<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - KeepPoker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE MESMA VERS√ÉO -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // MESMA CONFIGURA√á√ÉO
        const firebaseConfig = {
            apiKey: "AIzaSyBIBucZSzN671VgJQHGIiepHNUqxbqNKAQ",
            authDomain: "keeppoker-b4173.firebaseapp.com",
            projectId: "keeppoker-b4173",
            storageBucket: "keeppoker-b4173.firebasestorage.app",
            messagingSenderId: "436464592434",
            appId: "1:436464592434:web:c5a1e0c10e10acbc14fe2b"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        async function loginUser(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const senha = document.getElementById('senha').value;
            
            if (!email || !senha) {
                alert('Preencha email e senha!');
                return;
            }
            
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            btn.disabled = true;
            
            try {
                console.log('üîê Tentando login para:', email);
                
                // 1. LOGIN NO FIREBASE AUTH
                const userCredential = await auth.signInWithEmailAndPassword(email, senha);
                const user = userCredential.user;
                
                console.log('‚úÖ Auth OK! UID:', user.uid);
                
                // 2. BUSCAR DADOS NO FIRESTORE
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (!userDoc.exists) {
                    throw new Error('Usu√°rio n√£o encontrado no banco de dados');
                }
                
                const userData = userDoc.data();
                console.log('üìÑ Dados do Firestore:', userData);
                
                // 3. VERIFICAR E CORRIGIR DADOS SE NECESS√ÅRIO
                let dadosCorrigidos = { ...userData };
                
                // Se n√£o tem playerId, criar um
                if (!dadosCorrigidos.playerId) {
                    dadosCorrigidos.playerId = 'KP' + Math.floor(10000 + Math.random() * 90000);
                    console.log('üîß Criando playerId:', dadosCorrigidos.playerId);
                }
                
                // Se n√£o tem nickname, usar o nome
                if (!dadosCorrigidos.nickname) {
                    dadosCorrigidos.nickname = dadosCorrigidos.nome || 'Jogador';
                    console.log('üîß Definindo nickname:', dadosCorrigidos.nickname);
                }
                
                // Se n√£o tem saldo, definir 1000
                if (!dadosCorrigidos.saldo && dadosCorrigidos.saldo !== 0) {
                    dadosCorrigidos.saldo = 1000;
                    console.log('üîß Definindo saldo: 1000');
                }
                
                // Se n√£o tem diamantes, definir 50
                if (!dadosCorrigidos.diamantes && dadosCorrigidos.diamantes !== 0) {
                    dadosCorrigidos.diamantes = 50;
                    console.log('üîß Definindo diamantes: 50');
                }
                
                // Se n√£o tem n√≠vel, definir 1
                if (!dadosCorrigidos.nivel) {
                    dadosCorrigidos.nivel = 1;
                    console.log('üîß Definindo n√≠vel: 1');
                }
                
                // 4. ATUALIZAR FIRESTORE SE PRECISOU CORRIGIR
                const precisaAtualizar = 
                    !userData.playerId || 
                    !userData.nickname || 
                    !userData.saldo || 
                    !userData.diamantes || 
                    !userData.nivel;
                
                if (precisaAtualizar) {
                    console.log('üîÑ Atualizando dados no Firestore...');
                    await db.collection('users').doc(user.uid).update({
                        playerId: dadosCorrigidos.playerId,
                        nickname: dadosCorrigidos.nickname,
                        saldo: dadosCorrigidos.saldo,
                        diamantes: dadosCorrigidos.diamantes,
                        nivel: dadosCorrigidos.nivel,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Dados atualizados no Firestore');
                }
                
                // 5. SALVAR NO LOCALSTORAGE
                const dadosParaSalvar = {
                    uid: user.uid,
                    nome: dadosCorrigidos.nome,
                    email: dadosCorrigidos.email || email,
                    playerId: dadosCorrigidos.playerId,
                    nickname: dadosCorrigidos.nickname,
                    saldo: dadosCorrigidos.saldo,
                    diamantes: dadosCorrigidos.diamantes,
                    nivel: dadosCorrigidos.nivel
                };
                
                localStorage.setItem('keepPokerUser', JSON.stringify(dadosParaSalvar));
                console.log('üíæ Salvo no localStorage:', dadosParaSalvar);
                
                // 6. REDIRECIONAR
                alert(`‚úÖ Bem-vindo de volta, ${dadosCorrigidos.nome}!`);
                window.location.href = 'home.html';
                
            } catch (error) {
                console.error('‚ùå ERRO NO LOGIN:', error);
                
                let mensagem = 'Erro ao fazer login!';
                
                if (error.code === 'auth/user-not-found') {
                    mensagem = 'Usu√°rio n√£o encontrado!';
                } else if (error.code === 'auth/wrong-password') {
                    mensagem = 'Senha incorreta!';
                } else if (error.code === 'auth/invalid-email') {
                    mensagem = 'Email inv√°lido!';
                } else if (error.code === 'auth/too-many-requests') {
                    mensagem = 'Muitas tentativas. Tente mais tarde.';
                } else if (error.message.includes('n√£o encontrado no banco')) {
                    mensagem = 'Sua conta precisa ser recriada. Fa√ßa cadastro novamente.';
                } else {
                    mensagem = error.message || 'Erro desconhecido';
                }
                
                alert(mensagem);
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
                btn.disabled = false;
            }
        }
        
        window.loginUser = loginUser;
    </script>
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        :root {
            --azul-profundo: #0d1b2a;
            --azul-medio: #1b263b;
            --azul-claro: #415a77;
            --dourado: #d4af37;
            --dourado-claro: #f7ef8a;
            --branco: #ffffff;
            --cinza-claro: #e0e1dd;
            --verde: #2ecc71;
            --vermelho: #e74c3c;
        }
        
        body { 
            background: var(--azul-profundo); 
            color: var(--cinza-claro);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container { 
            width: 100%;
            max-width: 400px;
        }
        
        .login-box { 
            background: var(--azul-medio); 
            padding: 40px;
            border-radius: 15px; 
            border: 2px solid var(--dourado);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 { 
            color: var(--dourado); 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .input-group { 
            margin-bottom: 25px; 
        }
        
        label { 
            display: block; 
            margin-bottom: 10px; 
            color: var(--cinza-claro);
            font-weight: 600;
            font-size: 14px;
        }
        
        input { 
            width: 100%; 
            padding: 15px;
            border-radius: 10px; 
            border: 2px solid var(--azul-claro);
            background: rgba(255,255,255,0.1); 
            color: var(--branco);
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus { 
            outline: none; 
            border-color: var(--dourado);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }
        
        button { 
            width: 100%; 
            padding: 16px; 
            background: var(--dourado); 
            color: var(--azul-profundo); 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        button:hover { 
            background: var(--dourado-claro);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .register-link { 
            text-align: center; 
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .register-link a { 
            color: var(--dourado); 
            text-decoration: none; 
            font-weight: bold;
            font-size: 15px;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }
        
        .forgot-password a {
            color: var(--azul-claro);
            text-decoration: none;
            font-size: 14px;
        }
        
        .forgot-password a:hover {
            color: var(--dourado);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-box">
            <h1><i class="fas fa-poker-chips"></i> KeepPoker</h1>
            
            <form onsubmit="loginUser(event)">
                <div class="input-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="email" placeholder="seu@email.com" required autofocus>
                </div>
                
                <div class="input-group">
                    <label><i class="fas fa-lock"></i> Senha</label>
                    <input type="password" id="senha" placeholder="Sua senha" required>
                </div>
                
                <div class="forgot-password">
                    <a href="#" onclick="alert('Use o mesmo email do cadastro para recuperar senha')">Esqueceu a senha?</a>
                </div>
                
                <button type="submit" id="submitBtn">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                
                <div class="register-link">
                    N√£o tem conta? <a href="cadastro.html">Cadastre-se aqui</a>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // SE J√Å ESTIVER LOGADO, REDIRECIONAR
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('keepPokerUser')) {
                console.log('J√° logado, redirecionando...');
                window.location.href = 'home.html';
            }
            
            // Focar no campo email automaticamente
            document.getElementById('email').focus();
        });
        
        // Fun√ß√£o para recuperar senha
        async function resetPassword() {
            const email = prompt('Digite seu email para recuperar a senha:');
            if (!email) return;
            
            try {
                await auth.sendPasswordResetEmail(email);
                alert('Email de recupera√ß√£o enviado! Verifique sua caixa de entrada.');
            } catch (error) {
                alert('Erro: ' + (error.message || 'N√£o foi poss√≠vel enviar o email'));
            }
        }
    </script>
</body>
</html>