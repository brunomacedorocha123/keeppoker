<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Mesa de Torneio | KeepPoker</title>
 
 <!-- Firebase -->
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
 
 <script>
   // Firebase Configuration
   const firebaseConfig = {
     apiKey: "AIzaSyBIBucZSzN671VgJQHGIiepHNUqxbqNKAQ",
     authDomain: "keeppoker-b4173.firebaseapp.com",
     projectId: "keeppoker-b4173",
     storageBucket: "keeppoker-b4173.firebasestorage.app",
     messagingSenderId: "436464592434",
     appId: "1:436464592434:web:c5a1e0c10e10acbc14fe2b"
   };
   
   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();
 </script>
 
<style>
/* ===== SEU CSS ORIGINAL - N√ÉO MODIFIQUEI ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #0a1520;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* ===== CABE√áALHO ===== */
.header {
  height: 50px;
  background: rgba(13, 27, 42, 0.9);
  border-bottom: 2px solid #d4af37;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
}

.tournament-info {
  font-size: 1em;
  color: #d4af37;
  font-weight: bold;
}

.game-stats {
  display: flex;
  gap: 10px;
}

.stat {
  background: rgba(212, 175, 55, 0.15);
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  font-weight: bold;
  font-size: 0.9em;
}

/* ===== MESA ===== */
.table-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 70%;
  height: 50%;
  z-index: 1;
}

.poker-table {
  width: 100%;
  height: 100%;
  background: #0a5c36;
  border: 15px solid #8B4513;
  border-radius: 50% / 40%;
  box-shadow:
    inset 0 0 40px rgba(0, 0, 0, 0.6),
    0 0 30px rgba(0, 0, 0, 0.7);
  position: relative;
  overflow: visible;
}

.table-center {
  position: absolute;
  top: 52%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 45%;
  height: 35%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.community-cards {
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
}

.card-placeholder {
  width: 50px;
  height: 70px;
  background: white;
  border-radius: 5px;
  border: 2px solid #333;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.2em;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  color: #2c3e50;
}

.pot {
  color: #d4af37;
  font-size: 1.4em;
  font-weight: bold;
  margin-top: 5px;
}

/* ===== AVATARES ===== */
.avatar-container {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 20;
}

.avatar {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: linear-gradient(135deg, #415a77, #1b263b);
  border: 3px solid #d4af37;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.4em;
  margin-bottom: 5px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
  position: relative;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.player-cards {
  position: absolute;
  left: 85px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 5px;
  z-index: 25;
  width: 90px;
}

.player-card {
  width: 40px;
  height: 56px;
  background: white;
  border-radius: 4px;
  border: 2px solid #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1em;
  color: #000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.player-chips {
  background: rgba(0, 0, 0, 0.7);
  color: #ffd700;
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 0.9em;
  font-weight: bold;
  margin-top: 5px;
  min-width: 80px;
  text-align: center;
}

.current-turn .avatar {
  border-color: #00ff00;
  box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
}

.player-bet {
  position: absolute;
  top: -15px;
  background: rgba(212, 175, 55, 0.9);
  color: #000;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.8em;
  white-space: nowrap;
}

.player-folded .avatar {
  opacity: 0.5;
  border-color: #666;
}

.player-info {
  background: rgba(13, 27, 42, 0.95);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  text-align: center;
  min-width: 100px;
  font-size: 0.9em;
  display: none;
}

/* ===== INDICADORES DE BLIND ===== */
.blind-indicator {
  position: absolute;
  top: -10px;
  right: -10px;
  background: #d4af37;
  color: #000;
  padding: 2px 5px;
  border-radius: 50%;
  font-size: 0.7em;
  font-weight: bold;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 35;
}

.dealer-button {
  position: absolute;
  bottom: -10px;
  right: -10px;
  background: #fff;
  color: #000;
  padding: 2px 5px;
  border-radius: 50%;
  font-size: 0.7em;
  font-weight: bold;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 35;
  border: 2px solid #d4af37;
}

/* ===== POSI√á√ïES DESKTOP ===== */
.pos-1 {
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
}

.pos-2 {
  top: 140px;
  right: 15%;
}

.pos-3 {
  bottom: 140px;
  right: 15%;
}

.pos-4 {
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
}

.pos-5 {
  bottom: 140px;
  left: 15%;
}

.pos-6 {
  top: 140px;
  left: 15%;
}

/* JOGADOR ATUAL */
.player-you .avatar {
  border-color: #3498db;
  box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
}

.player-you .player-info {
  display: block;
}

/* ===== CONTROLES ===== */
.controls-container {
  position: fixed;
  bottom: 8px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  z-index: 1000;
}

.controls {
  background: rgba(13, 27, 42, 0.95);
  padding: 12px 20px;
  border-radius: 12px;
  border: 2px solid #d4af37;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 95%;
  max-width: 500px;
  min-height: 90px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.7);
}

.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: nowrap;
  justify-content: center;
  width: 100%;
}

.action-btn {
  padding: 10px 8px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  min-width: 60px;
  font-size: 0.9em;
  transition: all 0.3s;
  flex: 1;
  max-width: 80px;
}

.btn-fold { background: #e74c3c; color: white; }
.btn-check { background: #3498db; color: white; }
.btn-call { background: #2ecc71; color: white; }
.btn-raise { background: #9b59b6; color: white; }
.btn-allin { background: #e67e22; color: white; }

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.bet-controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 4px;
  width: 100%;
  display: none;
}

.bet-slider {
  flex: 1;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  outline: none;
  -webkit-appearance: none;
}

.bet-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #d4af37;
  cursor: pointer;
  border: 2px solid white;
}

.bet-amount {
  background: rgba(212, 175, 55, 0.2);
  padding: 5px 10px;
  border-radius: 8px;
  font-weight: bold;
  color: #ffd700;
  min-width: 60px;
  text-align: center;
  font-size: 0.9em;
  border: 1px solid rgba(212, 175, 55, 0.3);
}

.action-timer {
  width: 100%;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin-top: 6px;
  overflow: hidden;
  display: none;
}

.timer-bar {
  height: 100%;
  background: linear-gradient(90deg, #2ecc71, #e67e22, #e74c3c);
  width: 100%;
  transition: width 1s linear;
}

.status-message {
  position: fixed;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  padding: 10px 20px;
  border-radius: 20px;
  border: 2px solid #d4af37;
  z-index: 1000;
  font-weight: bold;
  font-size: 1em;
  display: none;
  text-align: center;
  min-width: 250px;
}

/* ===== RESPONSIVIDADE MOBILE - 6 POSI√á√ïES SIM√âTRICAS ===== */
@media (max-width: 768px) {
  /* MESA MOBILE */
  .table-container {
    width: 90%;
    height: 40%;
    top: 35%;
  }
  
  .poker-table {
    border-width: 8px;
  }
  
  .table-center {
    width: 55%;
    height: 40%;
  }
  
  .community-cards {
    gap: 5px;
  }
  
  .card-placeholder {
    width: 35px;
    height: 50px;
    font-size: 0.9em;
  }
  
  .pot {
    font-size: 1.2em;
  }
  
  /* AVATARES MOBILE - CARTAS MAIORES */
  .avatar {
    width: 55px;
    height: 55px;
    font-size: 1.2em;
  }
  
  .player-cards {
    left: 65px;
    width: 75px;
    gap: 4px;
  }
  
  .player-card {
    width: 32px;
    height: 45px;
    font-size: 0.9em;
  }
  
  .player-chips {
    font-size: 0.8em;
    min-width: 70px;
    padding: 3px 6px;
  }
  
  /* POSI√á√ïES MOBILE - 6 LUGARES SIM√âTRICOS */
  .pos-1 {
    top: 20px !important;
    left: 50% !important;
    right: auto !important;
    bottom: auto !important;
    transform: translateX(-50%) !important;
  }
  
  .pos-2 {
    top: 25% !important;
    right: 15px !important;
    left: auto !important;
    bottom: auto !important;
    transform: none !important;
  }
  
  .pos-3 {
    bottom: 25% !important;
    right: 15px !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
    display: block !important; /* GARANTIR VIS√çVEL */
  }
  
  .pos-4 {
    bottom: 20px !important;
    left: 50% !important;
    right: auto !important;
    top: auto !important;
    transform: translateX(-50%) !important;
  }
  
  .pos-5 {
    bottom: 25% !important;
    left: 15px !important;
    right: auto !important;
    top: auto !important;
    transform: none !important;
    display: block !important; /* GARANTIR VIS√çVEL */
  }
  
  .pos-6 {
    top: 25% !important;
    left: 15px !important;
    right: auto !important;
    bottom: auto !important;
    transform: none !important;
  }
  
  /* INDICADORES DE BLIND MOBILE */
  .blind-indicator {
    width: 16px;
    height: 16px;
    font-size: 0.6em;
  }
  
  .dealer-button {
    width: 16px;
    height: 16px;
    font-size: 0.6em;
  }
  
  /* CONTROLES MOBILE */
  .controls {
    width: 98%;
    padding: 10px 15px;
    min-height: 80px;
  }
  
  .action-buttons {
    gap: 5px;
  }
  
  .action-btn {
    padding: 8px 4px;
    min-width: 50px;
    font-size: 0.8em;
    max-width: 65px;
  }
  
  .bet-controls {
    gap: 6px;
    flex-wrap: wrap;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  /* MOBILE PEQUENO - AJUSTES */
  .avatar {
    width: 50px;
    height: 50px;
    font-size: 1.1em;
  }
  
  .player-cards {
    left: 55px;
    width: 65px;
  }
  
  .player-card {
    width: 28px;
    height: 40px;
    font-size: 0.85em;
  }
  
  .pos-2, .pos-3 {
    right: 10px !important;
  }
  
  .pos-5, .pos-6 {
    left: 10px !important;
  }
  
  .controls {
    width: 99%;
    padding: 8px 10px;
    min-height: 70px;
  }
  
  .action-btn {
    padding: 6px 3px;
    min-width: 45px;
    font-size: 0.75em;
    max-width: 55px;
  }
}
</style>
</head>
<body>
<!-- CABE√áALHO -->
<div class="header">
  <div class="tournament-info" id="tournamentName">Torneio</div>
  <div class="game-stats">
    <div class="stat" id="blinds">50/100</div>
    <div class="stat" id="pot">Pote: 0</div>
    <div class="stat" id="playersCount">1/6</div>
  </div>
</div>

<!-- MENSAGEM DE STATUS -->
<div class="status-message" id="statusMessage"></div>

<!-- CONTAINER DA MESA -->
<div class="table-container">
  <div class="poker-table">
    <!-- √ÅREA CENTRAL -->
    <div class="table-center">
      <div class="community-cards" id="communityCards">
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
      </div>
      <div class="pot" id="potAmount">0</div>
    </div>
  </div>
</div>

<!-- AVATARES -->
<div class="avatar-container pos-1" id="playerPos1">
  <div class="avatar" id="avatar1">?</div>
  <div class="blind-indicator" id="blind1" style="display: none;"></div>
  <div class="dealer-button" id="dealer1" style="display: none;">D</div>
  <div class="player-cards">
    <div class="player-card" id="playerCard1A">?</div>
    <div class="player-card" id="playerCard1B">?</div>
  </div>
  <div class="player-chips" id="chips1">-<br>0</div>
</div>

<div class="avatar-container pos-2" id="playerPos2">
  <div class="avatar" id="avatar2">?</div>
  <div class="blind-indicator" id="blind2" style="display: none;"></div>
  <div class="dealer-button" id="dealer2" style="display: none;">D</div>
  <div class="player-chips" id="chips2">-<br>0</div>
</div>

<div class="avatar-container pos-3" id="playerPos3">
  <div class="avatar" id="avatar3">?</div>
  <div class="blind-indicator" id="blind3" style="display: none;"></div>
  <div class="dealer-button" id="dealer3" style="display: none;">D</div>
  <div class="player-chips" id="chips3">-<br>0</div>
</div>

<div class="avatar-container pos-4" id="playerPos4">
  <div class="avatar" id="avatar4">?</div>
  <div class="blind-indicator" id="blind4" style="display: none;"></div>
  <div class="dealer-button" id="dealer4" style="display: none;">D</div>
  <div class="player-chips" id="chips4">-<br>0</div>
</div>

<div class="avatar-container pos-5" id="playerPos5">
  <div class="avatar" id="avatar5">?</div>
  <div class="blind-indicator" id="blind5" style="display: none;"></div>
  <div class="dealer-button" id="dealer5" style="display: none;">D</div>
  <div class="player-chips" id="chips5">-<br>0</div>
</div>

<div class="avatar-container pos-6" id="playerPos6">
  <div class="avatar" id="avatar6">?</div>
  <div class="blind-indicator" id="blind6" style="display: none;"></div>
  <div class="dealer-button" id="dealer6" style="display: none;">D</div>
  <div class="player-chips" id="chips6">-<br>0</div>
</div>

<!-- CONTROLES -->
<div class="controls-container">
  <div class="controls" id="playerControls">
    <div class="action-buttons" id="actionButtons">
      <button class="action-btn btn-fold" id="btnFold">Fold</button>
      <button class="action-btn btn-check" id="btnCheck" style="display: none;">Check</button>
      <button class="action-btn btn-call" id="btnCall" style="display: none;">Call 0</button>
      <button class="action-btn btn-raise" id="btnRaise" style="display: none;">Raise</button>
      <button class="action-btn btn-allin" id="btnAllIn" style="display: none;">All-in</button>
    </div>

    <div class="bet-controls" id="raiseControls">
      <input type="range" min="0" max="100" value="0" class="bet-slider" id="betSlider">
      <div class="bet-amount" id="betAmount">0</div>
      <button class="action-btn btn-raise" id="btnConfirmRaise">Confirmar</button>
      <button class="action-btn btn-fold" id="btnCancelRaise">Cancelar</button>
    </div>

    <div class="action-timer" id="actionTimerContainer">
      <div class="timer-bar" id="actionTimerBar"></div>
    </div>
  </div>
</div>

<script>
// =============================================
// SISTEMA COMPLETO DE POKER - MANTENDO SEU CSS
// =============================================

// VARI√ÅVEIS GLOBAIS
let currentUser = null;
let tournamentId = null;
let tournamentData = null;
let realtimeListener = null;
let gameEngine = null;
let gameStarted = false;
let isMyTurn = false;
let actionTimer = null;
let timeLeft = 30;
let myPlayerData = null;

// CLASSE DO MOTOR DE POKER SIMPLIFICADO
class PokerEngine {
    constructor(players, smallBlind = 50, bigBlind = 100) {
        this.players = players;
        this.smallBlind = smallBlind;
        this.bigBlind = bigBlind;
        this.deck = [];
        this.communityCards = [];
        this.pot = 0;
        this.currentRound = 'preflop';
        this.dealerPosition = 0;
        this.currentMaxBet = 0;
        this.currentPlayerTurn = null;
        this.handActive = false;
        this.suits = ['H', 'D', 'C', 'S'];
        this.values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        this.initializeDeck();
    }
    
    initializeDeck() {
        this.deck = [];
        for (let suit of this.suits) {
            for (let value of this.values) {
                this.deck.push({ suit, value, display: value + this.getSuitSymbol(suit) });
            }
        }
        this.shuffleDeck();
    }
    
    getSuitSymbol(suit) {
        const symbols = { 'H': '‚ô•', 'D': '‚ô¶', 'C': '‚ô£', 'S': '‚ô†' };
        return symbols[suit];
    }
    
    shuffleDeck() {
        for (let i = this.deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
        }
    }
    
    startNewHand() {
        console.log('üÉè Iniciando nova m√£o...');
        
        // Resetar estado
        this.communityCards = [];
        this.pot = 0;
        this.currentMaxBet = 0;
        this.currentRound = 'preflop';
        this.handActive = true;
        this.initializeDeck();
        
        // Resetar jogadores
        this.players.forEach(player => {
            player.cards = [];
            player.bet = 0;
            player.lastAction = null;
            player.hasActed = false;
            player.isFolded = false;
            player.isAllIn = false;
        });
        
        // Distribuir cartas
        this.dealCards();
        
        // Aplicar blinds
        this.applyBlinds();
        
        // Definir primeiro jogador a agir
        this.determineNextPlayer();
        
        console.log('‚úÖ M√£o iniciada:', this.getGameState());
        return this.getGameState();
    }
    
    dealCards() {
        // Dar 2 cartas para cada jogador
        for (let i = 0; i < 2; i++) {
            this.players.forEach(player => {
                if (player.chips > 0) {
                    const card = this.deck.pop();
                    if (!player.cards) player.cards = [];
                    player.cards.push(card);
                }
            });
        }
    }
    
    applyBlinds() {
        const activePlayers = this.players.filter(p => p.chips > 0);
        if (activePlayers.length < 2) return;
        
        // Small Blind
        const sbPlayer = activePlayers[(this.dealerPosition + 1) % activePlayers.length];
        const sbAmount = Math.min(this.smallBlind, sbPlayer.chips);
        sbPlayer.chips -= sbAmount;
        sbPlayer.bet = sbAmount;
        this.pot += sbAmount;
        sbPlayer.lastAction = 'SB';
        sbPlayer.hasActed = true;
        this.currentMaxBet = sbAmount;
        
        console.log(`üí∞ Small Blind: ${sbPlayer.nickname} apostou ${sbAmount}`);
        
        // Big Blind
        const bbPlayer = activePlayers[(this.dealerPosition + 2) % activePlayers.length];
        const bbAmount = Math.min(this.bigBlind, bbPlayer.chips);
        bbPlayer.chips -= bbAmount;
        bbPlayer.bet = bbAmount;
        this.pot += bbAmount;
        bbPlayer.lastAction = 'BB';
        bbPlayer.hasActed = true;
        this.currentMaxBet = bbAmount;
        
        console.log(`üí∞ Big Blind: ${bbPlayer.nickname} apostou ${bbAmount}`);
    }
    
    determineNextPlayer() {
        const activePlayers = this.players.filter(p => 
            p.chips > 0 && !p.isFolded && !p.hasActed && !p.isAllIn
        );
        
        if (activePlayers.length === 0) {
            this.currentPlayerTurn = null;
            return null;
        }
        
        // Encontrar pr√≥ximo jogador que ainda n√£o agiu
        let startIndex = this.currentRound === 'preflop' 
            ? (this.dealerPosition + 3) % this.players.length
            : (this.dealerPosition + 1) % this.players.length;
        
        for (let i = 0; i < this.players.length; i++) {
            const index = (startIndex + i) % this.players.length;
            const player = this.players[index];
            
            if (player.chips > 0 && !player.isFolded && !player.hasActed && !player.isAllIn) {
                this.currentPlayerTurn = player.userId;
                console.log(`üéØ Pr√≥ximo jogador: ${player.nickname} (${player.userId})`);
                return player.userId;
            }
        }
        
        this.currentPlayerTurn = null;
        return null;
    }
    
    playerAction(playerId, action, amount = 0) {
        const player = this.players.find(p => p.userId === playerId);
        if (!player) {
            console.error('‚ùå Jogador n√£o encontrado:', playerId);
            return { error: 'Jogador n√£o encontrado' };
        }
        
        console.log(`üéØ A√ß√£o recebida: ${player.nickname} - ${action} ${amount > 0 ? amount : ''}`);
        
        // Validar a√ß√£o
        let validation = this.validateAction(player, action, amount);
        if (validation.error) {
            console.error('‚ùå Valida√ß√£o falhou:', validation.error);
            return validation;
        }
        
        // Executar a√ß√£o
        switch(action.toLowerCase()) {
            case 'fold':
                player.isFolded = true;
                player.lastAction = 'fold';
                player.hasActed = true;
                console.log(`üÉè ${player.nickname} foldou`);
                break;
                
            case 'check':
                player.lastAction = 'check';
                player.hasActed = true;
                console.log(`‚úì ${player.nickname} deu check`);
                break;
                
            case 'call':
                const callAmount = this.currentMaxBet - player.bet;
                if (callAmount >= player.chips) {
                    // All-in
                    player.lastAction = 'allin';
                    this.pot += player.chips;
                    player.bet += player.chips;
                    player.chips = 0;
                    player.isAllIn = true;
                    console.log(`üíé ${player.nickname} all-in de ${player.bet}`);
                } else {
                    player.lastAction = 'call';
                    player.chips -= callAmount;
                    player.bet += callAmount;
                    this.pot += callAmount;
                    console.log(`üìû ${player.nickname} call de ${callAmount}`);
                }
                player.hasActed = true;
                break;
                
            case 'bet':
            case 'raise':
                if (amount >= player.chips) {
                    // All-in
                    player.lastAction = 'allin';
                    this.pot += player.chips;
                    player.bet += player.chips;
                    player.chips = 0;
                    player.isAllIn = true;
                    this.currentMaxBet = player.bet;
                    console.log(`üíé ${player.nickname} all-in de ${player.bet}`);
                } else {
                    player.lastAction = action === 'bet' ? 'bet' : 'raise';
                    player.chips -= amount;
                    player.bet += amount;
                    this.pot += amount;
                    this.currentMaxBet = player.bet;
                    console.log(`‚¨ÜÔ∏è ${player.nickname} ${action} de ${amount}`);
                }
                player.hasActed = true;
                break;
                
            case 'allin':
                player.lastAction = 'allin';
                this.pot += player.chips;
                player.bet += player.chips;
                this.currentMaxBet = Math.max(this.currentMaxBet, player.bet);
                player.chips = 0;
                player.isAllIn = true;
                player.hasActed = true;
                console.log(`üíé ${player.nickname} all-in de ${player.bet}`);
                break;
        }
        
        // Verificar se rodada terminou
        if (this.isRoundComplete()) {
            console.log('‚úÖ Rodada completa, avan√ßando...');
            this.advanceRound();
        } else {
            this.determineNextPlayer();
        }
        
        return { 
            success: true, 
            gameState: this.getGameState(),
            player: player 
        };
    }
    
    validateAction(player, action, amount) {
        const myBet = player.bet || 0;
        const maxBet = this.currentMaxBet || 0;
        const myChips = player.chips || 0;
        
        switch(action.toLowerCase()) {
            case 'check':
                if (myBet < maxBet) {
                    return { error: 'N√£o pode dar check, precisa igualar' };
                }
                break;
                
            case 'call':
                const callAmount = maxBet - myBet;
                if (callAmount <= 0) {
                    return { error: 'N√£o precisa dar call' };
                }
                break;
                
            case 'bet':
                if (maxBet > 0) {
                    return { error: 'N√£o pode fazer bet, j√° h√° apostas' };
                }
                if (amount <= 0) {
                    return { error: 'Valor de bet inv√°lido' };
                }
                if (amount > myChips) {
                    return { error: 'Fichas insuficientes' };
                }
                break;
                
            case 'raise':
                const raiseAmount = amount - myBet;
                if (raiseAmount <= maxBet - myBet) {
                    return { error: 'Raise deve ser maior que aposta atual' };
                }
                if (raiseAmount > myChips) {
                    return { error: 'Fichas insuficientes' };
                }
                break;
                
            case 'allin':
                if (myChips <= 0) {
                    return { error: 'Sem fichas para all-in' };
                }
                break;
        }
        
        return { success: true };
    }
    
    isRoundComplete() {
        const activePlayers = this.players.filter(p => 
            p.chips > 0 && !p.isFolded && !p.isAllIn
        );
        
        if (activePlayers.length <= 1) return true;
        
        // Todos jogadores ativos j√° agiram
        const allActed = activePlayers.every(p => p.hasActed);
        if (!allActed) return false;
        
        // Todas apostas est√£o igualadas
        return activePlayers.every(p => 
            p.isAllIn || p.bet === this.currentMaxBet
        );
    }
    
    advanceRound() {
        console.log(`üîÑ Avan√ßando de ${this.currentRound}...`);
        
        // Resetar a√ß√µes dos jogadores
        this.players.forEach(p => {
            if (!p.isFolded) {
                p.hasActed = false;
                p.bet = 0;
            }
        });
        
        this.currentMaxBet = 0;
        
        switch(this.currentRound) {
            case 'preflop':
                // Virar flop
                this.communityCards = this.deck.splice(0, 3);
                this.currentRound = 'flop';
                console.log('üÉè Flop virado:', this.communityCards.map(c => c.display));
                break;
                
            case 'flop':
                // Virar turn
                this.communityCards.push(this.deck.splice(0, 1)[0]);
                this.currentRound = 'turn';
                console.log('üÉè Turn virado:', this.communityCards[3].display);
                break;
                
            case 'turn':
                // Virar river
                this.communityCards.push(this.deck.splice(0, 1)[0]);
                this.currentRound = 'river';
                console.log('üÉè River virado:', this.communityCards[4].display);
                break;
                
            case 'river':
                // Mostdown
                this.currentRound = 'showdown';
                this.handActive = false;
                console.log('üèÜ Showdown!');
                this.determineWinner();
                return;
        }
        
        this.determineNextPlayer();
    }
    
    determineWinner() {
        console.log('üèÜ Determinando vencedor...');
        const activePlayers = this.players.filter(p => !p.isFolded && p.cards.length === 2);
        
        if (activePlayers.length === 0) {
            console.log('‚ùå Nenhum jogador ativo');
            return;
        }
        
        if (activePlayers.length === 1) {
            // Vencedor √∫nico
            const winner = activePlayers[0];
            winner.chips += this.pot;
            console.log(`üéâ ${winner.nickname} ganhou ${this.pot} fichas!`);
            this.pot = 0;
            return;
        }
        
        // Distribuir pote igualmente (simplificado)
        const prize = Math.floor(this.pot / activePlayers.length);
        activePlayers.forEach(player => {
            player.chips += prize;
            console.log(`üéâ ${player.nickname} ganhou ${prize} fichas`);
        });
        
        this.pot = 0;
    }
    
    getGameState() {
        return {
            players: this.players.map(p => ({
                userId: p.userId,
                nickname: p.nickname,
                chips: p.chips,
                bet: p.bet || 0,
                cards: p.cards ? p.cards.map(c => c.display) : [],
                lastAction: p.lastAction,
                isFolded: p.isFolded || false,
                isAllIn: p.isAllIn || false,
                hasActed: p.hasActed || false
            })),
            communityCards: this.communityCards.map(c => c.display),
            pot: this.pot,
            currentRound: this.currentRound,
            dealerPosition: this.dealerPosition,
            currentMaxBet: this.currentMaxBet,
            currentPlayerTurn: this.currentPlayerTurn,
            handActive: this.handActive,
            smallBlind: this.smallBlind,
            bigBlind: this.bigBlind
        };
    }
}

// =============================================
// INICIALIZA√á√ÉO DO SISTEMA
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéÆ Sistema de Poker iniciando...');
    
    // Pegar ID do torneio da URL
    const urlParams = new URLSearchParams(window.location.search);
    tournamentId = urlParams.get('tournamentId');
    
    if (!tournamentId) {
        console.error('‚ùå Nenhum ID de torneio na URL');
        window.location.href = 'torneios.html';
        return;
    }
    
    console.log('üîç Torneio ID:', tournamentId);
    
    // Verificar autentica√ß√£o
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            console.log('‚ùå Usu√°rio n√£o autenticado');
            window.location.href = 'login.html';
            return;
        }
        
        currentUser = user;
        console.log('‚úÖ Usu√°rio autenticado:', user.email, 'UID:', user.uid);
        
        // Carregar dados do torneio
        await loadTournamentData();
        
        // Verificar se est√° inscrito
        if (!isUserInTournament()) {
            alert('Voc√™ n√£o est√° inscrito neste torneio');
            window.location.href = 'torneios.html';
            return;
        }
        
        // Inicializar interface
        initializeInterface();
        
        // Configurar eventos
        setupEventListeners();
        
        // Configurar listener em tempo real
        setupRealtimeListener();
        
        // Iniciar jogo se poss√≠vel
        checkAndStartGame();
    });
});

// =============================================
// CARREGAR DADOS DO TORNEIO
// =============================================
async function loadTournamentData() {
    try {
        console.log('üì• Carregando torneio...');
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            throw new Error('Torneio n√£o encontrado');
        }
        
        tournamentData = tournamentDoc.data();
        tournamentData.id = tournamentId;
        
        console.log('‚úÖ Torneio carregado:', tournamentData.name);
        console.log('üë• Jogadores:', tournamentData.players);
        
        // Atualizar header
        document.getElementById('tournamentName').textContent = tournamentData.name;
        updatePlayerCount();
        
        // Encontrar minhas informa√ß√µes
        myPlayerData = tournamentData.players?.find(p => p.userId === currentUser.uid);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar torneio:', error);
        showNotification(`Erro: ${error.message}`, 'error');
    }
}

function updatePlayerCount() {
    if (!tournamentData) return;
    const count = tournamentData.players?.length || 0;
    const max = tournamentData.maxPlayers || 6;
    document.getElementById('playersCount').textContent = `${count}/${max}`;
}

function isUserInTournament() {
    if (!tournamentData?.players) return false;
    return tournamentData.players.some(p => p.userId === currentUser.uid);
}

// =============================================
// INICIALIZAR INTERFACE
// =============================================
function initializeInterface() {
    console.log('üé® Inicializando interface...');
    
    if (!tournamentData?.players) {
        console.warn('‚ö†Ô∏è Sem jogadores para mostrar');
        return;
    }
    
    // Resetar todas as posi√ß√µes
    for (let i = 1; i <= 6; i++) {
        resetPlayerPosition(i);
    }
    
    // Mostrar jogadores inscritos
    const players = tournamentData.players || [];
    console.log(`üë§ Mostrando ${players.length} jogadores`);
    
    players.forEach((player, index) => {
        if (index < 6) {
            updatePlayerDisplay(index + 1, player);
        }
    });
    
    // Atualizar pote
    updatePotDisplay();
}

function resetPlayerPosition(position) {
    const avatar = document.getElementById(`avatar${position}`);
    const chips = document.getElementById(`chips${position}`);
    const container = document.getElementById(`playerPos${position}`);
    const cardsContainer = container?.querySelector('.player-cards');
    
    if (avatar) {
        avatar.innerHTML = '?';
        avatar.classList.remove('current-turn', 'player-folded', 'player-you');
    }
    
    if (chips) chips.innerHTML = '-<br>0';
    
    if (container) {
        container.classList.remove('player-you', 'current-turn', 'player-folded');
    }
    
    if (cardsContainer) {
        cardsContainer.style.display = 'none';
        const cards = cardsContainer.querySelectorAll('.player-card');
        cards.forEach(card => {
            card.textContent = '?';
            card.style.color = '#2c3e50';
        });
    }
    
    // Resetar indicadores
    document.getElementById(`blind${position}`).style.display = 'none';
    document.getElementById(`dealer${position}`).style.display = 'none';
    
    // Remover apostas anteriores
    const oldBet = container?.querySelector('.player-bet');
    if (oldBet) oldBet.remove();
}

function updatePlayerDisplay(position, player) {
    const avatar = document.getElementById(`avatar${position}`);
    const chips = document.getElementById(`chips${position}`);
    const container = document.getElementById(`playerPos${position}`);
    
    if (!avatar || !chips || !container) {
        console.warn(`‚ö†Ô∏è Elementos n√£o encontrados para posi√ß√£o ${position}`);
        return;
    }
    
    // Verificar se sou eu
    const isMe = player.userId === currentUser.uid;
    if (isMe) {
        container.classList.add('player-you');
        console.log(`üéØ Eu estou na posi√ß√£o ${position}: ${player.nickname}`);
    }
    
    // Nome do jogador - USAR O NICKNAME CORRETAMENTE
    const displayName = player.nickname || `Jogador ${position}`;
    
    // Avatar com inicial
    const initial = displayName.charAt(0).toUpperCase();
    avatar.textContent = initial;
    avatar.title = displayName;
    
    // Fichas
    const playerChips = player.chips || 1500;
    chips.innerHTML = `${displayName}<br>${playerChips}`;
    
    // Mostrar minhas cartas
    if (isMe && player.cards && player.cards.length >= 2) {
        showMyCards(position, player.cards);
    }
    
    // Aposta atual
    if (player.bet > 0) {
        showPlayerBet(position, player.bet);
    }
    
    // Status do jogador
    if (player.lastAction === 'fold') {
        avatar.classList.add('player-folded');
    }
}

function showMyCards(position, cards) {
    const container = document.getElementById(`playerPos${position}`);
    if (!container) return;
    
    const cardsContainer = container.querySelector('.player-cards');
    if (!cardsContainer) return;
    
    cardsContainer.style.display = 'flex';
    const cardElements = cardsContainer.querySelectorAll('.player-card');
    
    if (cardElements.length >= 2) {
        cardElements[0].textContent = cards[0] || '?';
        cardElements[1].textContent = cards[1] || '?';
        
        // Cores das cartas
        const isRed1 = cards[0]?.includes('‚ô•') || cards[0]?.includes('‚ô¶');
        const isRed2 = cards[1]?.includes('‚ô•') || cards[1]?.includes('‚ô¶');
        
        cardElements[0].style.color = isRed1 ? '#e74c3c' : '#2c3e50';
        cardElements[1].style.color = isRed2 ? '#e74c3c' : '#2c3e50';
    }
}

function showPlayerBet(position, amount) {
    const container = document.getElementById(`playerPos${position}`);
    if (!container) return;
    
    // Remover aposta anterior
    const oldBet = container.querySelector('.player-bet');
    if (oldBet) oldBet.remove();
    
    // Criar nova aposta
    const betElement = document.createElement('div');
    betElement.className = 'player-bet';
    betElement.textContent = amount;
    betElement.style.position = 'absolute';
    betElement.style.top = '-25px';
    betElement.style.left = '50%';
    betElement.style.transform = 'translateX(-50%)';
    betElement.style.background = 'rgba(212, 175, 55, 0.95)';
    betElement.style.color = '#000';
    betElement.style.padding = '4px 10px';
    betElement.style.borderRadius = '12px';
    betElement.style.fontWeight = 'bold';
    betElement.style.fontSize = '0.9em';
    betElement.style.zIndex = '30';
    betElement.style.whiteSpace = 'nowrap';
    betElement.style.boxShadow = '0 3px 8px rgba(0,0,0,0.3)';
    
    container.appendChild(betElement);
}

function updatePotDisplay() {
    if (!tournamentData) return;
    const pot = tournamentData.pot || 0;
    document.getElementById('pot').textContent = `Pote: ${pot}`;
    document.getElementById('potAmount').textContent = pot;
}

// =============================================
// LISTENER EM TEMPO REAL
// =============================================
function setupRealtimeListener() {
    console.log('üì° Configurando listener em tempo real...');
    
    if (!tournamentId) return;
    
    realtimeListener = db.collection('tournaments').doc(tournamentId)
        .onSnapshot((doc) => {
            if (!doc.exists) {
                console.error('‚ùå Torneio n√£o existe mais');
                return;
            }
            
            const newData = doc.data();
            console.log('üîÑ Update recebido do Firestore');
            
            // Atualizar dados locais
            tournamentData = newData;
            
            // Atualizar interface completa
            updateFullInterface();
            
            // Verificar turno
            checkMyTurn();
            
            // Atualizar blinds/dealer
            updateBlindIndicators();
            
        }, (error) => {
            console.error('‚ùå Erro no listener:', error);
        });
}

function updateFullInterface() {
    if (!tournamentData) return;
    
    // Atualizar contadores
    updatePlayerCount();
    updatePotDisplay();
    
    // Atualizar cartas comunit√°rias
    updateCommunityCards();
    
    // Atualizar jogadores
    updateAllPlayers();
    
    // Atualizar minhas informa√ß√µes
    updateMyPlayerInfo();
}

function updateCommunityCards() {
    if (!tournamentData) return;
    
    const cards = tournamentData.communityCards || [];
    const container = document.getElementById('communityCards');
    const cardElements = container.querySelectorAll('.card-placeholder');
    
    cardElements.forEach((cardEl, index) => {
        if (cards[index]) {
            const card = cards[index];
            cardEl.textContent = card;
            cardEl.style.background = 'white';
            cardEl.style.color = (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
        } else {
            cardEl.textContent = '';
            cardEl.style.background = 'rgba(255,255,255,0.1)';
        }
    });
}

function updateAllPlayers() {
    if (!tournamentData?.players) return;
    
    const players = tournamentData.players;
    
    // Resetar turnos
    for (let i = 1; i <= 6; i++) {
        const avatar = document.getElementById(`avatar${i}`);
        if (avatar) avatar.classList.remove('current-turn');
    }
    
    // Atualizar cada jogador
    players.forEach((player, index) => {
        if (index < 6) {
            updatePlayerDisplay(index + 1, player);
            
            // Marcar turno atual
            if (tournamentData.currentPlayerTurn === player.userId) {
                const avatar = document.getElementById(`avatar${index + 1}`);
                if (avatar) avatar.classList.add('current-turn');
            }
        }
    });
}

function updateMyPlayerInfo() {
    if (!tournamentData?.players) return;
    
    myPlayerData = tournamentData.players.find(p => p.userId === currentUser.uid);
    
    if (myPlayerData) {
        // Encontrar minha posi√ß√£o
        const myIndex = tournamentData.players.findIndex(p => p.userId === currentUser.uid);
        if (myIndex >= 0 && myIndex < 6) {
            if (myPlayerData.cards) {
                showMyCards(myIndex + 1, myPlayerData.cards);
            }
        }
    }
}

function updateBlindIndicators() {
    if (!tournamentData?.players) return;
    
    // Resetar todos
    for (let i = 1; i <= 6; i++) {
        document.getElementById(`blind${i}`).style.display = 'none';
        document.getElementById(`dealer${i}`).style.display = 'none';
    }
    
    const players = tournamentData.players;
    const dealerPos = tournamentData.dealerPosition || 0;
    
    // Mostrar dealer
    if (players[dealerPos]) {
        const dealerIndex = dealerPos;
        if (dealerIndex < 6) {
            document.getElementById(`dealer${dealerIndex + 1}`).style.display = 'flex';
        }
    }
    
    // Mostrar blinds (para 2 jogadores)
    if (players.length === 2) {
        // Small Blind
        const sbIndex = (dealerPos + 1) % 2;
        if (players[sbIndex] && sbIndex < 6) {
            const blindEl = document.getElementById(`blind${sbIndex + 1}`);
            blindEl.textContent = 'SB';
            blindEl.style.display = 'flex';
        }
        
        // Big Blind
        const bbIndex = (dealerPos + 2) % 2;
        if (players[bbIndex] && bbIndex < 6) {
            const blindEl = document.getElementById(`blind${bbIndex + 1}`);
            blindEl.textContent = 'BB';
            blindEl.style.display = 'flex';
        }
    } else if (players.length > 2) {
        // Small Blind
        const sbIndex = (dealerPos + 1) % players.length;
        if (players[sbIndex] && sbIndex < 6) {
            const blindEl = document.getElementById(`blind${sbIndex + 1}`);
            blindEl.textContent = 'SB';
            blindEl.style.display = 'flex';
        }
        
        // Big Blind
        const bbIndex = (dealerPos + 2) % players.length;
        if (players[bbIndex] && bbIndex < 6) {
            const blindEl = document.getElementById(`blind${bbIndex + 1}`);
            blindEl.textContent = 'BB';
            blindEl.style.display = 'flex';
        }
    }
}

// =============================================
// CONTROLE DE TURNO
// =============================================
function checkMyTurn() {
    if (!tournamentData?.currentPlayerTurn) {
        console.log('‚è∏Ô∏è Nenhum turno definido');
        disablePlayerControls();
        stopActionTimer();
        return;
    }
    
    isMyTurn = tournamentData.currentPlayerTurn === currentUser.uid;
    
    if (isMyTurn) {
        console.log('‚úÖ √â MINHA VEZ!');
        enablePlayerControls();
        startActionTimer();
        showNotification('‚úÖ SUA VEZ! Fa√ßa sua jogada.', 'turn');
    } else {
        console.log('‚è≥ N√£o √© minha vez');
        disablePlayerControls();
        stopActionTimer();
    }
}

function enablePlayerControls() {
    console.log('üéÆ Habilitando controles...');
    
    const buttons = document.querySelectorAll('.action-btn');
    buttons.forEach(btn => {
        btn.disabled = false;
    });
    
    document.getElementById('actionTimerContainer').style.display = 'block';
    updateActionButtons();
}

function disablePlayerControls() {
    const buttons = document.querySelectorAll('.action-btn');
    buttons.forEach(btn => {
        btn.disabled = true;
    });
    
    document.getElementById('actionTimerContainer').style.display = 'none';
    hideRaiseControls();
}

function updateActionButtons() {
    if (!myPlayerData) {
        console.warn('‚ö†Ô∏è Sem dados do jogador para atualizar bot√µes');
        return;
    }
    
    const myBet = myPlayerData.bet || 0;
    const maxBet = tournamentData.currentMaxBet || 0;
    const myChips = myPlayerData.chips || 0;
    const callAmount = Math.max(0, maxBet - myBet);
    
    console.log(`üìä Meu bet: ${myBet}, Max bet: ${maxBet}, Call: ${callAmount}, Fichas: ${myChips}`);
    
    const checkBtn = document.getElementById('btnCheck');
    const callBtn = document.getElementById('btnCall');
    const raiseBtn = document.getElementById('btnRaise');
    const allinBtn = document.getElementById('btnAllIn');
    
    if (!checkBtn || !callBtn || !raiseBtn || !allinBtn) {
        console.error('‚ùå Bot√µes n√£o encontrados');
        return;
    }
    
    // L√≥gica de poker
    if (myBet >= maxBet || maxBet === 0) {
        // Pode dar check
        checkBtn.style.display = 'block';
        callBtn.style.display = 'none';
    } else {
        // Deve call ou fold
        checkBtn.style.display = 'none';
        callBtn.style.display = 'block';
        callBtn.textContent = callAmount > 0 ? `Call ${callAmount}` : 'Check';
    }
    
    // Raise s√≥ se tiver fichas
    const canRaise = myChips > callAmount && myChips > 0;
    raiseBtn.style.display = canRaise ? 'block' : 'none';
    
    // All-in sempre vis√≠vel se tiver fichas
    allinBtn.style.display = myChips > 0 ? 'block' : 'none';
    allinBtn.textContent = `All-in ${myChips}`;
}

// =============================================
// INICIAR JOGO
// =============================================
function checkAndStartGame() {
    if (!tournamentData?.players) return;
    
    const playerCount = tournamentData.players.length;
    
    if (playerCount >= 2 && !gameStarted) {
        console.log('üöÄ 2+ jogadores! Iniciando jogo...');
        showNotification('üéÆ Iniciando jogo...', 'info');
        
        setTimeout(async () => {
            await startGame();
        }, 2000);
    } else if (playerCount < 2) {
        showNotification(`‚è≥ Aguardando jogadores... (${playerCount}/2)`, 'info');
    }
}

async function startGame() {
    if (gameStarted) {
        console.log('‚ö†Ô∏è Jogo j√° iniciado');
        return;
    }
    
    try {
        console.log('üöÄ Iniciando novo jogo...');
        gameStarted = true;
        
        // Preparar jogadores
        const players = tournamentData.players.map((player, index) => ({
            userId: player.userId,
            nickname: player.nickname || `Jogador ${index + 1}`,
            chips: player.chips || 1500,
            position: index
        }));
        
        // Criar motor de jogo
        gameEngine = new PokerEngine(players, 50, 100);
        const gameState = gameEngine.startNewHand();
        
        // Salvar estado inicial no Firestore
        await saveGameState(gameState);
        
        showNotification('üÉè M√£o iniciada! Boa sorte!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro ao iniciar jogo:', error);
        gameStarted = false;
        showNotification(`Erro: ${error.message}`, 'error');
    }
}

async function saveGameState(gameState) {
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            players: gameState.players,
            communityCards: gameState.communityCards,
            pot: gameState.pot,
            currentRound: gameState.currentRound,
            dealerPosition: gameState.dealerPosition,
            currentMaxBet: gameState.currentMaxBet,
            currentPlayerTurn: gameState.currentPlayerTurn,
            gameState: 'active',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('üíæ Estado do jogo salvo no Firestore');
    } catch (error) {
        console.error('‚ùå Erro ao salvar estado:', error);
    }
}

// =============================================
// A√á√ïES DO JOGADOR
// =============================================
async function playerAction(action, amount = 0) {
    console.log(`üéØ Executando a√ß√£o: ${action} ${amount}`);
    
    if (!isMyTurn || !gameEngine) {
        showNotification('N√£o √© sua vez!', 'error');
        return;
    }
    
    if (!myPlayerData) {
        showNotification('Dados do jogador n√£o encontrados', 'error');
        return;
    }
    
    try {
        const result = gameEngine.playerAction(currentUser.uid, action, amount);
        
        if (result.error) {
            showNotification(result.error, 'error');
            return;
        }
        
        // Atualizar Firestore com novo estado
        await saveGameState(result.gameState);
        
        showNotification(`‚úÖ ${action.toUpperCase()} realizado!`, 'success');
        stopActionTimer();
        
    } catch (error) {
        console.error('‚ùå Erro na a√ß√£o:', error);
        showNotification(`Erro: ${error.message}`, 'error');
    }
}

// =============================================
// CONTROLES DE RAISE
// =============================================
function showRaiseControls() {
    if (!isMyTurn || !myPlayerData) {
        showNotification('N√£o √© sua vez!', 'error');
        return;
    }
    
    const myChips = myPlayerData.chips || 0;
    const maxBet = tournamentData.currentMaxBet || 0;
    const myBet = myPlayerData.bet || 0;
    const minRaise = Math.max(50, (maxBet - myBet) * 2);
    
    const slider = document.getElementById('betSlider');
    slider.min = minRaise;
    slider.max = myChips;
    slider.value = Math.min(Math.max(minRaise, myBet + 100), myChips);
    
    document.getElementById('raiseControls').style.display = 'flex';
    document.getElementById('actionButtons').style.display = 'none';
    
    updateBetAmount();
}

function hideRaiseControls() {
    document.getElementById('raiseControls').style.display = 'none';
    document.getElementById('actionButtons').style.display = 'flex';
}

function updateBetAmount() {
    const amount = parseInt(document.getElementById('betSlider').value) || 0;
    document.getElementById('betAmount').textContent = amount;
}

function confirmRaise() {
    const amount = parseInt(document.getElementById('betAmount').textContent);
    if (amount > 0) {
        playerAction('raise', amount);
        hideRaiseControls();
    }
}

// =============================================
// TIMER DE A√á√ÉO
// =============================================
function startActionTimer() {
    timeLeft = 30;
    const timerBar = document.getElementById('actionTimerBar');
    if (!timerBar) return;
    
    timerBar.style.width = '100%';
    timerBar.style.background = '#2ecc71';
    
    stopActionTimer();
    
    actionTimer = setInterval(() => {
        timeLeft--;
        const percentage = (timeLeft / 30) * 100;
        timerBar.style.width = percentage + '%';
        
        if (timeLeft <= 10) {
            timerBar.style.background = '#e74c3c';
        } else if (timeLeft <= 20) {
            timerBar.style.background = '#e67e22';
        }
        
        if (timeLeft <= 0) {
            console.log('‚è∞ Tempo esgotado! Fold autom√°tico.');
            playerAction('fold');
            stopActionTimer();
        }
    }, 1000);
}

function stopActionTimer() {
    if (actionTimer) {
        clearInterval(actionTimer);
        actionTimer = null;
    }
}

// =============================================
// EVENT LISTENERS
// =============================================
function setupEventListeners() {
    console.log('üîó Configurando event listeners...');
    
    // Bot√µes principais
    document.getElementById('btnFold').addEventListener('click', () => {
        console.log('üîÑ Fold clicado');
        playerAction('fold');
    });
    
    document.getElementById('btnCheck').addEventListener('click', () => {
        console.log('üîÑ Check clicado');
        playerAction('check');
    });
    
    document.getElementById('btnCall').addEventListener('click', () => {
        console.log('üîÑ Call clicado');
        playerAction('call');
    });
    
    document.getElementById('btnRaise').addEventListener('click', () => {
        console.log('üîÑ Raise clicado');
        showRaiseControls();
    });
    
    document.getElementById('btnAllIn').addEventListener('click', () => {
        console.log('üîÑ All-in clicado');
        playerAction('allin');
    });
    
    // Controles de raise
    document.getElementById('betSlider').addEventListener('input', updateBetAmount);
    document.getElementById('btnConfirmRaise').addEventListener('click', confirmRaise);
    document.getElementById('btnCancelRaise').addEventListener('click', hideRaiseControls);
    
    console.log('‚úÖ Event listeners configurados');
}

// =============================================
// NOTIFICA√á√ïES
// =============================================
function showNotification(message, type = 'info') {
    const messageEl = document.getElementById('statusMessage');
    if (!messageEl) {
        console.log('üì¢', message);
        return;
    }
    
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    switch (type) {
        case 'error':
            messageEl.style.background = 'rgba(231, 76, 60, 0.95)';
            messageEl.style.borderColor = '#c0392b';
            break;
        case 'success':
            messageEl.style.background = 'rgba(46, 204, 113, 0.95)';
            messageEl.style.borderColor = '#27ae60';
            break;
        case 'turn':
            messageEl.style.background = 'rgba(52, 152, 219, 0.95)';
            messageEl.style.borderColor = '#2980b9';
            messageEl.style.boxShadow = '0 0 15px rgba(52, 152, 219, 0.5)';
            break;
        case 'info':
            messageEl.style.background = 'rgba(0, 0, 0, 0.95)';
            messageEl.style.borderColor = '#d4af37';
            break;
    }
    
    if (type !== 'turn') {
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 3000);
    }
}

// =============================================
// LIMPEZA
// =============================================
window.addEventListener('beforeunload', () => {
    if (realtimeListener) {
        realtimeListener();
    }
    stopActionTimer();
});

// =============================================
// INICIALIZA√á√ÉO FINAL
// =============================================
console.log('‚úÖ Sistema de Poker carregado e pronto!');
</script>
</body>
</html>