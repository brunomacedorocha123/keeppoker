<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Mesa de Torneio | KeepPoker</title>
 
 <!-- Firebase -->
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
 
 <script>
   // Firebase Configuration
   const firebaseConfig = {
     apiKey: "AIzaSyBIBucZSzN671VgJQHGIiepHNUqxbqNKAQ",
     authDomain: "keeppoker-b4173.firebaseapp.com",
     projectId: "keeppoker-b4173",
     storageBucket: "keeppoker-b4173.firebasestorage.app",
     messagingSenderId: "436464592434",
     appId: "1:436464592434:web:c5a1e0c10e10acbc14fe2b"
   };
   
   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();
 </script>
 
 <!-- Poker Engine (ARQUIVO SEPARADO) -->
 <script src="poker-engine.js"></script>
 
<style>
/* ===== RESET E BASE ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #0a1520;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* ===== CABE√áALHO ===== */
.header {
  height: 60px;
  background: rgba(13, 27, 42, 0.9);
  border-bottom: 2px solid #d4af37;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
}

.tournament-info {
  font-size: 1.1em;
  color: #d4af37;
  font-weight: bold;
}

.game-stats {
  display: flex;
  gap: 20px;
}

.stat {
  background: rgba(212, 175, 55, 0.15);
  padding: 6px 12px;
  border-radius: 12px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  font-weight: bold;
}

/* ===== MESA ===== */
.table-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 70%;
  height: 50%;
  z-index: 1;
}

.poker-table {
  width: 100%;
  height: 100%;
  background: #0a5c36;
  border: 15px solid #8B4513;
  border-radius: 50% / 40%;
  box-shadow:
    inset 0 0 40px rgba(0, 0, 0, 0.6),
    0 0 30px rgba(0, 0, 0, 0.7);
  position: relative;
  overflow: visible;
}

.table-center {
  position: absolute;
  top: 52%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 45%;
  height: 35%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.community-cards {
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
}

.card-placeholder {
  width: 50px;
  height: 70px;
  background: white;
  border-radius: 5px;
  border: 2px solid #333;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.2em;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  color: #2c3e50;
}

.pot {
  color: #d4af37;
  font-size: 1.4em;
  font-weight: bold;
  margin-top: 5px;
}

/* ===== AVATARS ===== */
.avatar-container {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 20;
}

.avatar {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: linear-gradient(135deg, #415a77, #1b263b);
  border: 3px solid #d4af37;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.4em;
  margin-bottom: 5px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
  position: relative;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.player-cards {
  position: absolute;
  left: 85px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 5px;
  z-index: 25;
  width: 90px;
}

.player-card {
  width: 40px;
  height: 56px;
  background: white;
  border-radius: 4px;
  border: 2px solid #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1em;
  color: #000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.player-chips {
  background: rgba(0, 0, 0, 0.7);
  color: #ffd700;
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 0.9em;
  font-weight: bold;
  margin-top: 5px;
  min-width: 80px;
  text-align: center;
}

.current-turn .avatar {
  border-color: #00ff00;
  box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
}

.player-bet {
  position: absolute;
  top: -15px;
  background: rgba(212, 175, 55, 0.9);
  color: #000;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.8em;
  white-space: nowrap;
}

.player-folded .avatar {
  opacity: 0.5;
  border-color: #666;
}

.player-info {
  background: rgba(13, 27, 42, 0.95);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  text-align: center;
  min-width: 100px;
  font-size: 0.9em;
  display: none;
}

/* ===== POSI√á√ïES DOS AVATARES - AJUSTE FINAL VISUAL ===== */
.pos-1 {
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
}

/* Posi√ß√µes 2 e 3 ‚Üí MOVER PARA A DIREITA (‚Üí‚Üí‚Üí) */
.pos-2 {
  top: 160px;
  right: 20%; /* mais perto da borda direita */
}
.pos-3 {
  bottom: 160px;
  right: 20%;
}

/* Posi√ß√µes 5 e 6 ‚Üí MOVER PARA A ESQUERDA (‚Üê‚Üê‚Üê) */
.pos-6 {
  top: 160px;
  left: 20%; /* mais perto da borda esquerda */
}
.pos-5 {
  bottom: 160px;
  left: 20%;
}

/* Posi√ß√£o 4 ‚Üí MOVER PARA CIMA (‚Üë‚Üë‚Üë) */
.pos-4 {
  bottom: 150px; /* mais alto na tela, longe dos controles */
  left: 50%;
  transform: translateX(-50%);
}

/* JOGADOR ATUAL (VOC√ä) */
.player-you .avatar {
  border-color: #3498db;
  box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
}

.player-you .player-info {
  display: block;
}

/* ===== CONTROLES ===== */
.controls-container {
  position: fixed;
  bottom: 8px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  z-index: 1000;
}

.controls {
  background: rgba(13, 27, 42, 0.95);
  padding: 12px 25px;
  border-radius: 12px;
  border: 2px solid #d4af37;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 560px;
  min-height: 100px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.7);
}

.action-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: nowrap;
  justify-content: center;
  width: 100%;
}

.action-btn {
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  min-width: 90px;
  font-size: 0.95em;
  transition: all 0.3s;
  flex: 1;
  max-width: 100px;
}

.btn-fold { background: #e74c3c; color: white; }
.btn-check { background: #3498db; color: white; }
.btn-call { background: #2ecc71; color: white; }
.btn-raise { background: #9b59b6; color: white; }
.btn-allin { background: #e67e22; color: white; }

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.bet-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-top: 4px;
  width: 100%;
  display: none;
}

.bet-slider {
  flex: 1;
  height: 7px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  outline: none;
  -webkit-appearance: none;
}

.bet-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #d4af37;
  cursor: pointer;
  border: 2px solid white;
}

.bet-amount {
  background: rgba(212, 175, 55, 0.2);
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: bold;
  color: #ffd700;
  min-width: 70px;
  text-align: center;
  font-size: 0.95em;
  border: 1px solid rgba(212, 175, 55, 0.3);
}

.action-timer {
  width: 100%;
  height: 5px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin-top: 6px;
  overflow: hidden;
  display: none;
}

.timer-bar {
  height: 100%;
  background: linear-gradient(90deg, #2ecc71, #e67e22, #e74c3c);
  width: 100%;
  transition: width 1s linear;
}

.status-message {
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  padding: 12px 25px;
  border-radius: 20px;
  border: 2px solid #d4af37;
  z-index: 1000;
  font-weight: bold;
  font-size: 1.1em;
  display: none;
  text-align: center;
  min-width: 300px;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 768px) {
  .table-container {
    width: 85%;
    height: 45%;
    top: 40%;
  }

  .avatar {
    width: 55px;
    height: 55px;
    font-size: 1.2em;
  }

  .player-cards {
    left: 65px;
    width: 80px;
  }

  .player-card {
    width: 35px;
    height: 49px;
    font-size: 0.9em;
  }

  .pos-1 { top: 75px; }
  .pos-2 { top: 120px; right: 24%; }
  .pos-6 { top: 120px; left: 24%; }
  .pos-3 { bottom: 140px; right: 24%; }
  .pos-5 { bottom: 140px; left: 24%; }
  .pos-4 { bottom: 120px; }

  .controls {
    width: 92%;
    padding: 10px 20px;
    min-height: 90px;
  }

  .action-btn {
    padding: 8px 10px;
    min-width: 65px;
    font-size: 0.9em;
    max-width: 75px;
  }
}

@media (max-width: 480px) {
  .avatar {
    width: 45px;
    height: 45px;
    font-size: 1em;
  }

  .player-cards {
    left: 55px;
    width: 70px;
  }

  .player-card {
    width: 30px;
    height: 42px;
    font-size: 0.85em;
  }

  .pos-1 { top: 70px; }
  .pos-2 { top: 100px; right: 20%; }
  .pos-6 { top: 100px; left: 20%; }
  .pos-3 { bottom: 120px; right: 20%; }
  .pos-5 { bottom: 120px; left: 20%; }
  .pos-4 { bottom: 100px; }

  .controls {
    width: 96%;
    padding: 8px 16px;
    min-height: 80px;
  }

  .action-btn {
    padding: 6px 8px;
    min-width: 55px;
    font-size: 0.85em;
    max-width: 65px;
  }

  .bet-controls {
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }
}
</style>
</head>
<body>
<!-- CABE√áALHO -->
<div class="header">
  <div class="tournament-info" id="tournamentName">Torneio</div>
  <div class="game-stats">
    <div class="stat" id="blinds">100/200</div>
    <div class="stat" id="pot">Pote: 0</div>
    <div class="stat" id="playersCount">1/6</div>
  </div>
</div>

<!-- MENSAGEM DE STATUS -->
<div class="status-message" id="statusMessage"></div>

<!-- CONTAINER DA MESA (S√ì A MESA MESMO) -->
<div class="table-container">
  <div class="poker-table">
    <!-- √ÅREA CENTRAL -->
    <div class="table-center">
      <div class="community-cards" id="communityCards">
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
      </div>
      <div class="pot" id="potAmount">0</div>
    </div>
  </div>
</div>

<!-- AVATARES (FORA da .table-container, posicionados no BODY) -->
<div class="avatar-container pos-1" id="playerPos1">
  <div class="avatar" id="avatar1">?</div>
  <!-- CARTAS AO LADO DO SEU AVATAR (POSI√á√ÉO 1) -->
  <div class="player-cards">
    <div class="player-card" id="playerCard1">?</div>
    <div class="player-card" id="playerCard2">?</div>
  </div>
  <div class="player-chips" id="chips1">-<br>0</div>
</div>

<div class="avatar-container pos-2" id="playerPos2">
  <div class="avatar" id="avatar2">?</div>
  <div class="player-chips" id="chips2">-<br>0</div>
</div>

<div class="avatar-container pos-6" id="playerPos6">
  <div class="avatar" id="avatar6">?</div>
  <div class="player-chips" id="chips6">-<br>0</div>
</div>

<div class="avatar-container pos-3" id="playerPos3">
  <div class="avatar" id="avatar3">?</div>
  <div class="player-chips" id="chips3">-<br>0</div>
</div>

<div class="avatar-container pos-5" id="playerPos5">
  <div class="avatar" id="avatar5">?</div>
  <div class="player-chips" id="chips5">-<br>0</div>
</div>

<div class="avatar-container pos-4" id="playerPos4">
  <div class="avatar" id="avatar4">?</div>
  <div class="player-chips" id="chips4">-<br>0</div>
</div>

<!-- CONTROLES (FORA da .table-container, posicionados no BODY) -->
<div class="controls-container">
  <div class="controls" id="playerControls">
    <!-- BOT√ïES DE A√á√ÉO -->
    <div class="action-buttons" id="actionButtons">
      <button class="action-btn btn-fold" onclick="playerAction('fold')">Fold</button>
      <button class="action-btn btn-check" onclick="playerAction('check')">Check</button>
      <button class="action-btn btn-call" onclick="playerAction('call')">Call</button>
      <button class="action-btn btn-raise" onclick="showRaiseControls()">Raise</button>
      <button class="action-btn btn-allin" onclick="playerAction('allin')">All-in</button>
    </div>

    <!-- CONTROLE DE APOSTA -->
    <div class="bet-controls" id="raiseControls">
      <input type="range" min="0" max="100" value="0" class="bet-slider" id="betSlider" oninput="updateBetAmount()">
      <div class="bet-amount" id="betAmount">0</div>
      <button class="action-btn btn-raise" onclick="confirmRaise()">Confirmar</button>
      <button class="action-btn btn-fold" onclick="hideRaiseControls()">Cancelar</button>
    </div>

    <!-- TIMER DE A√á√ÉO -->
    <div class="action-timer" id="actionTimerContainer">
      <div class="timer-bar" id="actionTimerBar"></div>
    </div>
  </div>
</div>
<script>
// =============================================
// SISTEMA DE POKER - mesa-torneio.js CORRETO
// =============================================
let tournamentId = null;
let tournamentData = null;
let currentUser = null;
let pokerGame = null;
let realtimeListener = null;
let actionTimerInterval = null;
let timeLeft = 30;
let myPlayerPosition = -1;
let gameStarted = false;
let myCards = [];
let currentBet = 0;
let actionPhase = 'waiting';
let isActionProcessing = false;

const positionMap = [1, 2, 6, 3, 5, 4];

// =============================================
// 1. INICIALIZA√á√ÉO
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    tournamentId = urlParams.get('tournamentId');
    
    if (!tournamentId) {
        window.location.href = 'torneios.html';
        return;
    }
    
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        
        currentUser = user;
        await loadTournamentData();
        
        if (!isUserInTournament()) {
            alert('Voc√™ n√£o est√° inscrito neste torneio');
            window.location.href = 'torneios.html';
            return;
        }
        
        initializeInterface();
        setupRealtimeListener();
        checkIfGameCanStart();
    });
});

async function loadTournamentData() {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        if (!tournamentDoc.exists) throw new Error('Torneio n√£o encontrado');
        
        tournamentData = tournamentDoc.data();
        tournamentData.id = tournamentId;
        
        document.getElementById('tournamentName').textContent = tournamentData.name;
        updatePlayerCount();
        
    } catch (error) {
        alert('Erro ao carregar torneio');
    }
}

function updatePlayerCount() {
    const count = tournamentData.players?.length || 1;
    const max = tournamentData.maxPlayers || 6;
    document.getElementById('playersCount').textContent = `${count}/${max}`;
}

function isUserInTournament() {
    if (!tournamentData.players) return false;
    return tournamentData.players.some(p => p.userId === currentUser.uid);
}

function initializeInterface() {
    // Reset all positions
    for (let i = 1; i <= 6; i++) {
        document.getElementById(`avatar${i}`).innerHTML = '?';
        document.getElementById(`chips${i}`).innerHTML = '-<br>0';
        const playerCards = document.getElementById(`playerPos${i}`)?.querySelector('.player-cards');
        if (playerCards) playerCards.style.display = 'none';
    }
    
    const players = tournamentData.players || [];
    
    players.forEach((player, index) => {
        if (index < 6) {
            const pos = positionMap[index];
            const avatarElement = document.getElementById(`avatar${pos}`);
            const chipsElement = document.getElementById(`chips${pos}`);
            const container = document.getElementById(`playerPos${pos}`);
            
            const isMe = player.userId === currentUser.uid;
            if (isMe) {
                myPlayerPosition = index;
                container.classList.add('player-you');
            }
            
            if (player.avatarUrl) {
                avatarElement.innerHTML = `<img src="${player.avatarUrl}" alt="${player.nickname}">`;
            } else {
                const initial = (player.nickname || '?').charAt(0).toUpperCase();
                avatarElement.textContent = initial;
            }
            
            const chips = player.chips || tournamentData.startingStack || 1500;
            chipsElement.innerHTML = `${player.nickname || 'Jogador'}<br>${chips}`;
        }
    });
}

function setupRealtimeListener() {
    realtimeListener = db.collection('tournaments').doc(tournamentId)
        .onSnapshot((doc) => {
            if (doc.exists) {
                const newData = doc.data();
                tournamentData = newData;
                updateInterface();
                
                if (newData.currentPlayerTurn) {
                    checkMyTurn();
                }
                
                if (newData.currentRound && newData.currentRound !== actionPhase) {
                    actionPhase = newData.currentRound;
                    handlePhaseChange();
                }
            }
        });
}

// =============================================
// 2. ATUALIZA√á√ÉO DA INTERFACE
// =============================================
function updateInterface() {
    if (!tournamentData) return;
    
    updatePlayerCount();
    
    const pot = tournamentData.pot || 0;
    document.getElementById('pot').textContent = `Pote: ${pot}`;
    document.getElementById('potAmount').textContent = pot;
    
    updateCommunityCards();
    updatePlayerDisplays();
    updateMyCards();
}

function updateCommunityCards() {
    if (!tournamentData) return;
    
    const communityCards = tournamentData.communityCards || [];
    const container = document.getElementById('communityCards');
    const cards = container.querySelectorAll('.card-placeholder');
    
    cards.forEach((cardEl, index) => {
        if (communityCards[index]) {
            const card = communityCards[index];
            let displayText = '?';
            let color = '#2c3e50';
            
            if (typeof card === 'string') {
                displayText = card;
                color = (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
            }
            
            cardEl.textContent = displayText;
            cardEl.style.color = color;
            cardEl.style.background = 'white';
        } else {
            cardEl.textContent = '';
            cardEl.style.background = 'rgba(255,255,255,0.1)';
        }
    });
}

function updatePlayerDisplays() {
    const players = tournamentData.players || [];
    
    players.forEach((player, index) => {
        if (index < 6) {
            const pos = positionMap[index];
            const chipsElement = document.getElementById(`chips${pos}`);
            const avatarElement = document.getElementById(`avatar${pos}`);
            
            const chips = player.chips || 1500;
            const name = player.nickname || 'Jogador';
            
            chipsElement.innerHTML = `${name}<br>${chips}`;
            
            // Update bet display
            const container = document.getElementById(`playerPos${pos}`);
            let betElement = container.querySelector('.player-bet');
            const bet = player.bet || 0;
            
            if (bet > 0) {
                if (!betElement) {
                    betElement = document.createElement('div');
                    betElement.className = 'player-bet';
                    betElement.style.position = 'absolute';
                    betElement.style.top = '-20px';
                    betElement.style.background = 'rgba(212, 175, 55, 0.9)';
                    betElement.style.color = '#000';
                    betElement.style.padding = '3px 8px';
                    betElement.style.borderRadius = '10px';
                    betElement.style.fontWeight = 'bold';
                    betElement.style.fontSize = '0.8em';
                    betElement.style.zIndex = '30';
                    container.appendChild(betElement);
                }
                betElement.textContent = `Aposta: ${bet}`;
                betElement.style.display = 'block';
            } else if (betElement) {
                betElement.style.display = 'none';
            }
            
            // Update turn indicator
            if (tournamentData.currentPlayerTurn === player.userId) {
                avatarElement.classList.add('current-turn');
            } else {
                avatarElement.classList.remove('current-turn');
            }
            
            // Update folded status
            if (player.isActive === false || player.lastAction === 'fold') {
                avatarElement.classList.add('player-folded');
            } else {
                avatarElement.classList.remove('player-folded');
            }
        }
    });
}

function updateMyCards() {
    if (!currentUser) return;
    
    const card1Element = document.getElementById('playerCard1');
    const card2Element = document.getElementById('playerCard2');
    const myCardsContainer = document.querySelector('#playerPos1 .player-cards');
    
    const me = tournamentData?.players?.find(p => p.userId === currentUser.uid);
    
    if (me && me.cards && me.cards.length >= 2) {
        myCards = me.cards;
        if (card1Element && card2Element) {
            card1Element.textContent = formatCard(myCards[0]);
            card2Element.textContent = formatCard(myCards[1]);
            
            card1Element.style.color = getCardColor(myCards[0]);
            card2Element.style.color = getCardColor(myCards[1]);
            
            if (myCardsContainer) {
                myCardsContainer.style.display = 'flex';
            }
        }
    } else {
        if (myCardsContainer) {
            myCardsContainer.style.display = 'none';
        }
    }
}

function handlePhaseChange() {
    if (actionPhase === 'flop') {
        showNotification('üÉè FLOP virado!', 'info');
    } else if (actionPhase === 'turn') {
        showNotification('üÉè TURN virado!', 'info');
    } else if (actionPhase === 'river') {
        showNotification('üÉè RIVER virado!', 'info');
    } else if (actionPhase === 'showdown') {
        showNotification('üèÜ SHOWDOWN!', 'info');
    }
}

// =============================================
// 3. CONTROLE DE TURNO
// =============================================
function checkMyTurn() {
    if (!tournamentData || !tournamentData.currentPlayerTurn) {
        disablePlayerControls();
        stopActionTimer();
        return;
    }
    
    const isMyTurn = tournamentData.currentPlayerTurn === currentUser.uid;
    
    if (isMyTurn) {
        enablePlayerControls();
        startActionTimer();
        showNotification('‚úÖ SUA VEZ!', 'turn');
    } else {
        disablePlayerControls();
        stopActionTimer();
    }
}

function checkIfGameCanStart() {
    const playersCount = tournamentData?.players?.length || 0;
    
    if (playersCount >= 2 && !gameStarted) {
        showNotification('üéÆ Iniciando jogo...', 'info');
        
        setTimeout(async () => {
            await initializePokerEngine();
        }, 2000);
    } else if (playersCount < 2) {
        showNotification('‚è≥ Aguardando mais jogadores...', 'info');
    }
}

async function initializePokerEngine() {
    if (gameStarted) return;
    
    const players = tournamentData.players || [];
    
    if (players.length < 2) return;
    
    if (!window.PokerEngine || !window.PokerEngine.PokerGameEngine) {
        showNotification('Erro: Poker Engine n√£o encontrado', 'error');
        return;
    }
    
    try {
        const enginePlayers = players.map((player, index) => ({
            userId: player.userId,
            nickname: player.nickname || `Jogador ${index + 1}`,
            chips: player.chips || 1500,
            position: index,
            isActive: true
        }));
        
        pokerGame = new window.PokerEngine.PokerGameEngine(tournamentId);
        pokerGame.initialize(enginePlayers);
        
        gameStarted = true;
        
        showNotification('üéÆ Jogo iniciado!', 'success');
        
        await startNewHand();
        
    } catch (error) {
        showNotification('Erro ao iniciar jogo', 'error');
    }
}

// CONTINUA NO PR√ìXIMO COMENT√ÅRIO...
async function startNewHand() {
    if (!pokerGame || !gameStarted) return;
    
    try {
        showNotification('üÉè Nova m√£o iniciada!', 'info');
        
        actionPhase = 'preflop';
        
        const handResult = pokerGame.startHand();
        const gameInfo = pokerGame.getGameInfo();
        
        // Get my cards
        const myPlayerInfo = pokerGame.getPlayerInfo(currentUser.uid);
        if (myPlayerInfo && myPlayerInfo.cards) {
            myCards = myPlayerInfo.cards;
        }
        
        // Update Firestore with new hand
        await db.collection('tournaments').doc(tournamentId).update({
            players: gameInfo.players,
            communityCards: gameInfo.communityCards,
            pot: gameInfo.pot,
            currentRound: 'preflop',
            currentPlayerTurn: gameInfo.currentPlayerTurn || '',
            dealerPosition: gameInfo.dealerPosition || 0,
            currentMaxBet: 0,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        updateInterface();
        
        // Start betting round after 2 seconds
        setTimeout(() => {
            startBettingRound();
        }, 2000);
        
    } catch (error) {
        showNotification('Erro ao iniciar m√£o', 'error');
    }
}

function startBettingRound() {
    if (!pokerGame || !tournamentData) return;
    
    const gameInfo = pokerGame.getGameInfo();
    const nextPlayer = gameInfo.currentPlayerTurn;
    
    if (nextPlayer) {
        updateCurrentTurn(nextPlayer);
    } else {
        // Find first active player
        const activePlayers = tournamentData.players?.filter(p => 
            p.isActive !== false && p.lastAction !== 'fold' && p.chips > 0
        ) || [];
        
        if (activePlayers.length > 0) {
            updateCurrentTurn(activePlayers[0].userId);
        }
    }
}

async function updateCurrentTurn(playerId) {
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            currentPlayerTurn: playerId,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Erro ao atualizar turno:', error);
    }
}

async function processActionAndMoveToNext(action, amount = 0) {
    if (isActionProcessing) return;
    isActionProcessing = true;
    
    try {
        const currentPlayerId = tournamentData.currentPlayerTurn;
        
        if (pokerGame) {
            const result = pokerGame.playerAction(currentPlayerId, action, amount);
            
            if (result.success) {
                const gameState = pokerGame.getGameInfo();
                
                // Update Firestore
                await db.collection('tournaments').doc(tournamentId).update({
                    players: gameState.players,
                    pot: gameState.pot,
                    currentMaxBet: gameState.currentMaxBet || 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (result.bettingRoundComplete) {
                    await advanceToNextPhase();
                } else {
                    await moveToNextPlayer();
                }
            }
        }
    } catch (error) {
        showNotification('Erro: ' + error.message, 'error');
    } finally {
        isActionProcessing = false;
    }
}

async function moveToNextPlayer() {
    if (!pokerGame) return;
    
    const gameInfo = pokerGame.getGameInfo();
    const nextPlayer = gameInfo.currentPlayerTurn;
    
    if (nextPlayer) {
        await updateCurrentTurn(nextPlayer);
    } else {
        // Check if round is complete
        if (gameInfo.bettingRoundComplete) {
            await advanceToNextPhase();
        }
    }
}

async function advanceToNextPhase() {
    if (!pokerGame) return;
    
    try {
        const result = pokerGame.advanceRound();
        
        if (result.round === 'showdown') {
            actionPhase = 'showdown';
            
            showNotification('üèÜ SHOWDOWN!', 'info');
            
            // Distribute prizes
            if (result.winners && result.winners.length > 0) {
                result.winners.forEach(winner => {
                    showNotification(`${winner.player.nickname} ganhou ${winner.prize} fichas!`, 'success');
                });
            }
            
            // Reset for new hand after 5 seconds
            setTimeout(() => {
                resetForNewHand();
            }, 5000);
            
        } else {
            // Update community cards and round
            const gameState = pokerGame.getGameInfo();
            
            await db.collection('tournaments').doc(tournamentId).update({
                communityCards: gameState.communityCards,
                currentRound: gameState.round,
                players: gameState.players.map(p => ({
                    ...p,
                    lastAction: null,
                    bet: 0
                })),
                currentMaxBet: 0,
                currentPlayerTurn: '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            actionPhase = gameState.round;
            
            // Start next betting round after 2 seconds
            setTimeout(() => {
                startBettingRound();
            }, 2000);
        }
        
    } catch (error) {
        console.error('Erro ao avan√ßar fase:', error);
    }
}

async function resetForNewHand() {
    if (pokerGame) {
        const gameState = pokerGame.getGameInfo();
        
        await db.collection('tournaments').doc(tournamentId).update({
            communityCards: [],
            currentRound: 'preflop',
            currentPlayerTurn: '',
            currentMaxBet: 0,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Start new hand after 3 seconds
        setTimeout(async () => {
            await startNewHand();
        }, 3000);
    }
}

// =============================================
// 4. CONTROLES DO JOGADOR
// =============================================
function setupControls() {
    const slider = document.getElementById('betSlider');
    if (slider) {
        slider.addEventListener('input', updateBetAmount);
    }
    
    // Action buttons
    document.querySelector('.btn-fold')?.addEventListener('click', () => playerAction('fold'));
    document.querySelector('.btn-check')?.addEventListener('click', () => playerAction('check'));
    document.querySelector('.btn-call')?.addEventListener('click', () => playerAction('call'));
    document.querySelector('.btn-bet')?.addEventListener('click', () => showRaiseControls());
    document.querySelector('.btn-raise')?.addEventListener('click', () => showRaiseControls());
    document.querySelector('.btn-allin')?.addEventListener('click', () => playerAction('allin'));
    document.querySelector('.btn-cancel-raise')?.addEventListener('click', hideRaiseControls);
    document.querySelector('.btn-confirm-raise')?.addEventListener('click', confirmRaise);
}

async function playerAction(action) {
    if (!isMyTurn()) {
        showNotification('N√£o √© sua vez!', 'error');
        return;
    }
    
    try {
        let amount = 0;
        
        if (action === 'raise') {
            amount = parseInt(document.getElementById('betAmount').textContent);
            if (amount <= 0) {
                showNotification('Escolha um valor para raise', 'error');
                return;
            }
        }
        
        await processActionAndMoveToNext(action, amount);
        hideRaiseControls();
        
    } catch (error) {
        showNotification('Erro: ' + error.message, 'error');
    }
}

function showRaiseControls() {
    if (!isMyTurn()) return;
    
    const me = tournamentData?.players?.find(p => p.userId === currentUser.uid);
    if (!me) return;
    
    const maxBet = me.chips || 0;
    const minBet = Math.max(100, (tournamentData.currentMaxBet || 0) * 2);
    
    const slider = document.getElementById('betSlider');
    if (slider) {
        slider.min = minBet;
        slider.max = maxBet;
        slider.value = minBet;
    }
    
    document.getElementById('raiseControls').style.display = 'flex';
    document.getElementById('actionButtons').style.display = 'none';
    
    updateBetAmount();
}

function hideRaiseControls() {
    document.getElementById('raiseControls').style.display = 'none';
    document.getElementById('actionButtons').style.display = 'flex';
}

function updateBetAmount() {
    const slider = document.getElementById('betSlider');
    const amount = parseInt(slider.value);
    document.getElementById('betAmount').textContent = amount;
}

function confirmRaise() {
    playerAction('raise');
}

function isMyTurn() {
    if (!tournamentData || !tournamentData.currentPlayerTurn) return false;
    return tournamentData.currentPlayerTurn === currentUser.uid;
}

function enablePlayerControls() {
    const buttons = document.querySelectorAll('.action-btn');
    buttons.forEach(btn => {
        btn.disabled = false;
    });
    
    document.getElementById('actionTimerContainer').style.display = 'block';
    updateActionButtons();
}

function updateActionButtons() {
    const me = tournamentData.players?.find(p => p.userId === currentUser.uid);
    if (!me) return;
    
    const myBet = me.bet || 0;
    const maxBet = tournamentData.currentMaxBet || 0;
    const canCheck = myBet >= maxBet;
    
    const checkBtn = document.querySelector('.btn-check');
    const callBtn = document.querySelector('.btn-call');
    const betBtn = document.querySelector('.btn-bet');
    const raiseBtn = document.querySelector('.btn-raise');
    
    if (checkBtn && callBtn && betBtn && raiseBtn) {
        checkBtn.style.display = canCheck ? 'block' : 'none';
        callBtn.style.display = (!canCheck && maxBet > 0) ? 'block' : 'none';
        betBtn.style.display = (canCheck && maxBet === 0) ? 'block' : 'none';
        raiseBtn.style.display = (!canCheck && maxBet > 0) ? 'block' : 'none';
        
        const callAmount = Math.max(0, maxBet - myBet);
        callBtn.textContent = callAmount > 0 ? `Call ${callAmount}` : 'Call';
    }
}

function disablePlayerControls() {
    const buttons = document.querySelectorAll('.action-btn');
    buttons.forEach(btn => {
        btn.disabled = true;
    });
    
    document.getElementById('actionTimerContainer').style.display = 'none';
}

// =============================================
// 5. TIMER DE A√á√ÉO
// =============================================
function startActionTimer() {
    timeLeft = 30;
    const timerBar = document.getElementById('actionTimerBar');
    timerBar.style.width = '100%';
    timerBar.style.background = '#2ecc71';
    
    stopActionTimer();
    
    actionTimerInterval = setInterval(() => {
        timeLeft--;
        const percentage = (timeLeft / 30) * 100;
        timerBar.style.width = percentage + '%';
        
        if (timeLeft <= 10) {
            timerBar.style.background = '#e74c3c';
        } else if (timeLeft <= 20) {
            timerBar.style.background = '#e67e22';
        }
        
        if (timeLeft <= 0) {
            playerAction('fold');
            stopActionTimer();
        }
    }, 1000);
}

function stopActionTimer() {
    if (actionTimerInterval) {
        clearInterval(actionTimerInterval);
        actionTimerInterval = null;
    }
}

// =============================================
// 6. FUN√á√ïES AUXILIARES
// =============================================
function formatCard(card) {
    if (!card) return '?';
    
    if (typeof card === 'string') {
        return card;
    }
    
    return '?';
}

function getCardColor(card) {
    if (typeof card === 'string') {
        return (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
    }
    
    return '#2c3e50';
}

function showNotification(message, type = 'info') {
    const messageEl = document.getElementById('statusMessage');
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    if (type === 'error') {
        messageEl.style.background = 'rgba(231, 76, 60, 0.9)';
    } else if (type === 'success') {
        messageEl.style.background = 'rgba(46, 204, 113, 0.9)';
    } else if (type === 'turn') {
        messageEl.style.background = 'rgba(52, 152, 219, 0.9)';
    } else {
        messageEl.style.background = 'rgba(0,0,0,0.8)';
    }
    
    if (type !== 'turn') {
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 3000);
    }
}

// =============================================
// 7. LIMPEZA E GERENCIAMENTO
// =============================================
window.addEventListener('beforeunload', () => {
    if (realtimeListener) realtimeListener();
    stopActionTimer();
});

// Inicializar controles quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    setupControls();
});
// =============================================
// 8. SISTEMA DE SINCRONIZA√á√ÉO AVAN√áADO
// =============================================
async function syncGameState() {
    if (!tournamentData || !pokerGame) return;
    
    try {
        const gameInfo = pokerGame.getGameInfo();
        
        // Atualizar estado no Firestore
        await db.collection('tournaments').doc(tournamentId).update({
            players: gameInfo.players.map(player => ({
                userId: player.userId,
                nickname: player.nickname,
                chips: player.chips,
                bet: player.bet || 0,
                isActive: player.isActive !== false,
                lastAction: player.lastAction || null,
                cards: player.userId === currentUser.uid ? player.cards : [],
                isAllIn: player.isAllIn || false
            })),
            communityCards: gameInfo.communityCards,
            pot: gameInfo.pot,
            currentRound: gameInfo.round,
            dealerPosition: gameInfo.dealerPosition,
            currentMaxBet: gameInfo.currentMaxBet || 0,
            currentPlayerTurn: gameInfo.currentPlayerTurn || '',
            handNumber: gameInfo.handNumber || 1,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        return true;
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o:', error);
        return false;
    }
}

function handleDisconnection() {
    showNotification('üîå Conex√£o perdida. Tentando reconectar...', 'warning');
    
    // Tentar reconectar a cada 5 segundos
    const reconnectInterval = setInterval(async () => {
        try {
            // Verificar se ainda est√° no torneio
            const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
            if (tournamentDoc.exists) {
                tournamentData = tournamentDoc.data();
                clearInterval(reconnectInterval);
                showNotification('‚úÖ Reconectado!', 'success');
                updateInterface();
                checkMyTurn();
            }
        } catch (error) {
            console.error('Falha na reconex√£o:', error);
        }
    }, 5000);
    
    // Parar ap√≥s 30 segundos
    setTimeout(() => {
        clearInterval(reconnectInterval);
        showNotification('‚ùå Falha na reconex√£o. Recarregue a p√°gina.', 'error');
    }, 30000);
}

// =============================================
// 9. SISTEMA DE √ÅUDIO E FEEDBACK
// =============================================
function playSound(soundType) {
    if (!soundEnabled) return;
    
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    try {
        switch(soundType) {
            case 'card_deal':
                playBeep(800, 0.1);
                break;
            case 'chips':
                playBeep(600, 0.2);
                break;
            case 'notification':
                playBeep(1000, 0.1);
                break;
            case 'win':
                playVictorySound();
                break;
            case 'timer':
                playBeep(400, 0.05);
                break;
        }
    } catch (error) {
        console.warn('√Åudio n√£o dispon√≠vel:', error);
    }
}

function playBeep(frequency, duration) {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
}

function playVictorySound() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const notes = [523.25, 659.25, 783.99, 1046.50];
    let time = audioContext.currentTime;
    
    notes.forEach((freq, index) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, time);
        gainNode.gain.linearRampToValueAtTime(0.3, time + 0.1);
        gainNode.gain.exponentialRampToValueAtTime(0.01, time + 0.3);
        
        oscillator.start(time);
        oscillator.stop(time + 0.3);
        
        time += 0.15;
    });
}

// =============================================
// 10. ANIMA√á√ïES E EFEITOS VISUAIS
// =============================================
function animateCardDeal(element, delay = 0) {
    setTimeout(() => {
        element.style.transform = 'scale(1.2)';
        element.style.transition = 'transform 0.3s';
        
        setTimeout(() => {
            element.style.transform = 'scale(1)';
        }, 300);
    }, delay);
}

function animateChipMove(fromElement, toElement, amount) {
    const chip = document.createElement('div');
    chip.style.position = 'fixed';
    chip.style.width = '20px';
    chip.style.height = '20px';
    chip.style.background = 'radial-gradient(circle, #ffd700, #daa520)';
    chip.style.borderRadius = '50%';
    chip.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)';
    chip.style.zIndex = '1000';
    
    const fromRect = fromElement.getBoundingClientRect();
    const toRect = toElement.getBoundingClientRect();
    
    chip.style.left = (fromRect.left + fromRect.width / 2 - 10) + 'px';
    chip.style.top = (fromRect.top + fromRect.height / 2 - 10) + 'px';
    
    document.body.appendChild(chip);
    
    setTimeout(() => {
        chip.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        chip.style.left = (toRect.left + toRect.width / 2 - 10) + 'px';
        chip.style.top = (toRect.top + toRect.height / 2 - 10) + 'px';
        
        setTimeout(() => {
            document.body.removeChild(chip);
        }, 500);
    }, 50);
}

function animatePotUpdate(newPot) {
    const potElement = document.getElementById('potAmount');
    if (!potElement) return;
    
    potElement.style.transform = 'scale(1.2)';
    potElement.style.color = '#f1c40f';
    potElement.style.transition = 'all 0.3s';
    
    setTimeout(() => {
        potElement.textContent = newPot;
        
        setTimeout(() => {
            potElement.style.transform = 'scale(1)';
            potElement.style.color = '';
        }, 300);
    }, 150);
}

function animatePlayerHighlight(playerPosition, duration = 2000) {
    const avatarElement = document.getElementById(`avatar${playerPosition}`);
    if (!avatarElement) return;
    
    avatarElement.style.boxShadow = '0 0 20px #3498db';
    avatarElement.style.transition = 'box-shadow 0.3s';
    
    setTimeout(() => {
        avatarElement.style.boxShadow = '';
    }, duration);
}

// =============================================
// 11. SISTEMA DE ESTAT√çSTICAS
// =============================================
function updateGameStatistics(action, amount = 0) {
    switch(action) {
        case 'fold':
            gameStatistics.folds++;
            break;
        case 'check':
            gameStatistics.checks++;
            break;
        case 'call':
            gameStatistics.calls++;
            break;
        case 'raise':
        case 'bet':
            gameStatistics.raises++;
            break;
        case 'allin':
            gameStatistics.allIns++;
            break;
    }
    
    gameStatistics.handsPlayed++;
    
    // Salvar estat√≠sticas localmente
    localStorage.setItem('poker_stats', JSON.stringify(gameStatistics));
}

function loadGameStatistics() {
    const savedStats = localStorage.getItem('poker_stats');
    if (savedStats) {
        gameStatistics = JSON.parse(savedStats);
    }
}

// =============================================
// 12. SISTEMA DE HIST√ìRICO DE M√ÉOS
// =============================================
function addToHandHistory(handData) {
    handReplayData.push({
        timestamp: new Date().toISOString(),
        handNumber: currentHandNumber,
        players: tournamentData.players?.map(p => ({
            userId: p.userId,
            nickname: p.nickname,
            cards: p.userId === currentUser.uid ? p.cards : [],
            action: p.lastAction,
            chips: p.chips
        })),
        communityCards: tournamentData.communityCards || [],
        pot: tournamentData.pot || 0,
        winner: lastWinners[0]?.player?.nickname || null,
        winningHand: lastWinners[0]?.hand?.hand || null
    });
    
    // Manter apenas as √∫ltimas 50 m√£os
    if (handReplayData.length > 50) {
        handReplayData.shift();
    }
    
    // Salvar no localStorage
    localStorage.setItem('hand_history', JSON.stringify(handReplayData));
}

// =============================================
// 13. SISTEMA DE CONFIGURA√á√ïES
// =============================================
function loadPlayerPreferences() {
    const preferences = localStorage.getItem('poker_preferences');
    if (preferences) {
        const prefs = JSON.parse(preferences);
        soundEnabled = prefs.soundEnabled !== false;
        chatEnabled = prefs.chatEnabled !== false;
        emojiEnabled = prefs.emojiEnabled !== false;
        gameSpeed = prefs.gameSpeed || 'normal';
        
        // Aplicar velocidade do jogo
        switch(gameSpeed) {
            case 'fast':
                animationDelay = 250;
                break;
            case 'normal':
                animationDelay = 500;
                break;
            case 'slow':
                animationDelay = 1000;
                break;
        }
    }
}

function savePlayerPreferences() {
    const preferences = {
        soundEnabled,
        chatEnabled,
        emojiEnabled,
        gameSpeed
    };
    localStorage.setItem('poker_preferences', JSON.stringify(preferences));
}

// =============================================
// 14. SISTEMA DE NOTIFICA√á√ïES AVAN√áADO
// =============================================
function showAdvancedNotification(message, options = {}) {
    const {
        type = 'info',
        duration = 3000,
        icon = null,
        action = null,
        dismissible = true
    } = options;
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${getNotificationColor(type)};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        min-width: 300px;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    `;
    
    let content = '';
    if (icon) {
        content += `<span style="margin-right: 10px; font-size: 1.2em;">${icon}</span>`;
    }
    content += `<span>${message}</span>`;
    
    if (action) {
        content += `<button style="margin-left: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">${action.label}</button>`;
    }
    
    if (dismissible) {
        content += `<button style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: white; font-size: 1.2em; cursor: pointer;">√ó</button>`;
    }
    
    notification.innerHTML = content;
    document.body.appendChild(notification);
    
    // Configurar eventos
    if (action) {
        notification.querySelector('button').addEventListener('click', action.callback);
    }
    
    if (dismissible) {
        const closeBtn = notification.querySelectorAll('button')[action ? 1 : 0];
        closeBtn.addEventListener('click', () => {
            notification.remove();
        });
    }
    
    // Auto-remover ap√≥s dura√ß√£o
    if (duration > 0) {
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }
        }, duration);
    }
    
    return notification;
}

function getNotificationColor(type) {
    switch(type) {
        case 'success': return 'linear-gradient(135deg, #2ecc71, #27ae60)';
        case 'error': return 'linear-gradient(135deg, #e74c3c, #c0392b)';
        case 'warning': return 'linear-gradient(135deg, #f39c12, #d35400)';
        case 'info': return 'linear-gradient(135deg, #3498db, #2980b9)';
        case 'turn': return 'linear-gradient(135deg, #9b59b6, #8e44ad)';
        default: return 'linear-gradient(135deg, #34495e, #2c3e50)';
    }
}

// =============================================
// 15. SISTEMA DE BACKUP E RECUPERA√á√ÉO
// =============================================
function createBackup() {
    const backup = {
        tournamentId,
        tournamentData,
        gameStatistics,
        handReplayData,
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('poker_backup', JSON.stringify(backup));
    return backup;
}

async function restoreBackup() {
    const backupStr = localStorage.getItem('poker_backup');
    if (!backupStr) return false;
    
    try {
        const backup = JSON.parse(backupStr);
        
        // Verificar se √© o mesmo torneio
        if (backup.tournamentId !== tournamentId) {
            showAdvancedNotification('Backup de torneio diferente. N√£o foi poss√≠vel restaurar.', { type: 'warning' });
            return false;
        }
        
        // Restaurar dados
        tournamentData = backup.tournamentData;
        gameStatistics = backup.gameStatistics;
        handReplayData = backup.handReplayData;
        
        showAdvancedNotification('‚úÖ Backup restaurado com sucesso!', { type: 'success' });
        updateInterface();
        return true;
        
    } catch (error) {
        console.error('Erro ao restaurar backup:', error);
        return false;
    }
}

// =============================================
// 16. INICIALIZA√á√ÉO FINAL
// =============================================
function finalizeInitialization() {
    // Carregar prefer√™ncias
    loadPlayerPreferences();
    loadGameStatistics();
    
    // Configurar backup autom√°tico a cada 5 minutos
    setInterval(() => {
        createBackup();
    }, 5 * 60 * 1000);
    
    // Verificar se h√° backup para restaurar
    setTimeout(() => {
        const lastBackup = localStorage.getItem('poker_backup');
        if (lastBackup) {
            const backup = JSON.parse(lastBackup);
            const backupTime = new Date(backup.timestamp);
            const currentTime = new Date();
            const hoursDiff = (currentTime - backupTime) / (1000 * 60 * 60);
            
            if (hoursDiff < 1) { // Backup com menos de 1 hora
                showAdvancedNotification('üìÇ Backup recente encontrado. Deseja restaurar?', {
                    type: 'info',
                    duration: 10000,
                    action: {
                        label: 'Restaurar',
                        callback: restoreBackup
                    }
                });
            }
        }
    }, 2000);
    
    // Adicionar estilos CSS din√¢micos
    addDynamicStyles();
    
    showAdvancedNotification('‚úÖ Sistema de Poker carregado com sucesso!', { 
        type: 'success',
        duration: 2000
    });
}

function addDynamicStyles() {
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes highlight {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }
        
        .current-turn {
            animation: pulse 2s infinite, highlight 1.5s infinite;
        }
        
        .player-folded {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        
        .player-you {
            border: 3px solid #2ecc71 !important;
        }
        
        .card-placeholder {
            transition: all 0.3s ease;
        }
        
        .card-placeholder:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .action-btn {
            transition: all 0.2s ease;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .action-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        #actionTimerBar {
            transition: width 1s linear, background-color 0.3s ease;
        }
    `;
    document.head.appendChild(style);
}

// =============================================
// 17. EXPORTAR/IMPORTAR DADOS
// =============================================
function exportGameData() {
    const exportData = {
        tournament: tournamentData,
        statistics: gameStatistics,
        handHistory: handReplayData,
        exportDate: new Date().toISOString(),
        version: '1.0.0'
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `poker-torneio-${tournamentId}-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showAdvancedNotification('üì• Dados exportados com sucesso!', { type: 'success' });
}

// =============================================
// 18. LIMPEZA FINAL E OTIMIZA√á√ÉO
// =============================================
function cleanup() {
    // Limpar listeners
    if (realtimeListener) realtimeListener();
    stopActionTimer();
    
    // Limpar intervalos
    const highestIntervalId = setInterval(() => {}, 0);
    for (let i = 0; i < highestIntervalId; i++) {
        clearInterval(i);
    }
    
    // Limpar timeouts
    const highestTimeoutId = setTimeout(() => {}, 0);
    for (let i = 0; i < highestTimeoutId; i++) {
        clearTimeout(i);
    }
    
    // Salvar estado atual
    createBackup();
    savePlayerPreferences();
    
    console.log('‚úÖ Sistema limpo com sucesso');
}

// =============================================
// 19. INICIALIZAR TUDO
// =============================================
window.addEventListener('load', () => {
    setTimeout(() => {
        finalizeInitialization();
    }, 1000);
});

window.addEventListener('beforeunload', (event) => {
    cleanup();
    
    // Para Chrome
    event.preventDefault();
    event.returnValue = '';
    
    // Para outros navegadores
    return '';
});

// =============================================
// 20. EXPORTAR FUN√á√ïES GLOBAIS (se necess√°rio)
// =============================================
window.PokerTournament = {
    exportGameData,
    restoreBackup,
    toggleSound: () => {
        soundEnabled = !soundEnabled;
        savePlayerPreferences();
        showAdvancedNotification(`Som ${soundEnabled ? 'ativado' : 'desativado'}`, {
            type: 'info',
            duration: 2000
        });
    },
    toggleChat: () => {
        chatEnabled = !chatEnabled;
        savePlayerPreferences();
        showAdvancedNotification(`Chat ${chatEnabled ? 'ativado' : 'desativado'}`, {
            type: 'info',
            duration: 2000
        });
    },
    setGameSpeed: (speed) => {
        if (['fast', 'normal', 'slow'].includes(speed)) {
            gameSpeed = speed;
            savePlayerPreferences();
            showAdvancedNotification(`Velocidade definida para: ${speed}`, {
                type: 'info',
                duration: 2000
            });
        }
    },
    showHandHistory: () => {
        if (handReplayData.length === 0) {
            showAdvancedNotification('Nenhuma m√£o no hist√≥rico', { type: 'info' });
            return;
        }
        
        const historyWindow = window.open('', 'Hist√≥rico de M√£os', 'width=600,height=400');
        historyWindow.document.write(`
            <html>
            <head>
                <title>Hist√≥rico de M√£os</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    .hand { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; }
                    .winner { background: #d4edda; }
                </style>
            </head>
            <body>
                <h2>Hist√≥rico de M√£os (${handReplayData.length})</h2>
                ${handReplayData.map(hand => `
                    <div class="hand ${hand.winner ? 'winner' : ''}">
                        <strong>M√£o #${hand.handNumber}</strong><br>
                        ${hand.timestamp}<br>
                        Pote: ${hand.pot}<br>
                        ${hand.winner ? `Vencedor: ${hand.winner} (${hand.winningHand})` : 'Sem vencedor'}
                    </div>
                `).join('')}
            </body>
            </html>
        `);
    }
};

console.log('üéÆ Sistema de Torneio de Poker carregado com sucesso!');
</script>
</body>
</html>