<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Mesa de Torneio | KeepPoker</title>
 
 <!-- Firebase -->
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
 
 <script>
   const firebaseConfig = {
     apiKey: "AIzaSyBIBucZSzN671VgJQHGIiepHNUqxbqNKAQ",
     authDomain: "keeppoker-b4173.firebaseapp.com",
     projectId: "keeppoker-b4173",
     storageBucket: "keeppoker-b4173.firebasestorage.app",
     messagingSenderId: "436464592434",
     appId: "1:436464592434:web:c5a1e0c10e10acbc14fe2b"
   };
   
   firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();
 </script>
 
<style>
/* ===== ESTILOS OTIMIZADOS ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #0a1520;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* CABE√áALHO */
.header {
  height: 50px;
  background: rgba(13, 27, 42, 0.9);
  border-bottom: 2px solid #d4af37;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
}

.tournament-info {
  font-size: 1em;
  color: #d4af37;
  font-weight: bold;
}

.game-stats {
  display: flex;
  gap: 10px;
}

.stat {
  background: rgba(212, 175, 55, 0.15);
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  font-weight: bold;
  font-size: 0.9em;
}

/* MESA */
.table-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 70%;
  height: 50%;
  z-index: 1;
}

.poker-table {
  width: 100%;
  height: 100%;
  background: #0a5c36;
  border: 15px solid #8B4513;
  border-radius: 50% / 40%;
  box-shadow:
    inset 0 0 40px rgba(0, 0, 0, 0.6),
    0 0 30px rgba(0, 0, 0, 0.7);
  position: relative;
  overflow: visible;
}

.table-center {
  position: absolute;
  top: 52%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 45%;
  height: 35%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.community-cards {
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
}

.card-placeholder {
  width: 50px;
  height: 70px;
  background: white;
  border-radius: 5px;
  border: 2px solid #333;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.2em;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  color: #2c3e50;
}

.pot {
  color: #d4af37;
  font-size: 1.4em;
  font-weight: bold;
  margin-top: 5px;
}

/* AVATARES */
.avatar-container {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 20;
}

.avatar {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: linear-gradient(135deg, #415a77, #1b263b);
  border: 3px solid #d4af37;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.4em;
  margin-bottom: 5px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
  position: relative;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.player-cards {
  position: absolute;
  left: 85px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 5px;
  z-index: 25;
  width: 90px;
}

.player-card {
  width: 40px;
  height: 56px;
  background: white;
  border-radius: 4px;
  border: 2px solid #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1em;
  color: #000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.player-chips {
  background: rgba(0, 0, 0, 0.7);
  color: #ffd700;
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 0.9em;
  font-weight: bold;
  margin-top: 5px;
  min-width: 80px;
  text-align: center;
}

.current-turn .avatar {
  border-color: #00ff00;
  box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
}

.player-bet {
  position: absolute;
  top: -15px;
  background: rgba(212, 175, 55, 0.9);
  color: #000;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.8em;
  white-space: nowrap;
}

.player-folded .avatar {
  opacity: 0.5;
  border-color: #666;
}

/* INDICADORES */
.blind-indicator {
  position: absolute;
  top: -10px;
  right: -10px;
  background: #d4af37;
  color: #000;
  padding: 2px 5px;
  border-radius: 50%;
  font-size: 0.7em;
  font-weight: bold;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 35;
}

.dealer-button {
  position: absolute;
  bottom: -10px;
  right: -10px;
  background: #fff;
  color: #000;
  padding: 2px 5px;
  border-radius: 50%;
  font-size: 0.7em;
  font-weight: bold;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 35;
  border: 2px solid #d4af37;
}

/* POSI√á√ïES */
.pos-1 { top: 80px; left: 50%; transform: translateX(-50%); }
.pos-2 { top: 140px; right: 15%; }
.pos-3 { bottom: 140px; right: 15%; }
.pos-4 { bottom: 80px; left: 50%; transform: translateX(-50%); }
.pos-5 { bottom: 140px; left: 15%; }
.pos-6 { top: 140px; left: 15%; }

/* JOGADOR ATUAL */
.player-you .avatar {
  border-color: #3498db;
  box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
}

/* CONTROLES */
.controls-container {
  position: fixed;
  bottom: 8px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  z-index: 1000;
}

.controls {
  background: rgba(13, 27, 42, 0.95);
  padding: 12px 20px;
  border-radius: 12px;
  border: 2px solid #d4af37;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 95%;
  max-width: 500px;
  min-height: 90px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.7);
}

.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: nowrap;
  justify-content: center;
  width: 100%;
}

.action-btn {
  padding: 10px 8px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  min-width: 60px;
  font-size: 0.9em;
  transition: all 0.3s;
  flex: 1;
  max-width: 80px;
}

.btn-fold { background: #e74c3c; color: white; }
.btn-check { background: #3498db; color: white; }
.btn-call { background: #2ecc71; color: white; }
.btn-raise { background: #9b59b6; color: white; }
.btn-allin { background: #e67e22; color: white; }

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.bet-controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 4px;
  width: 100%;
  display: none;
}

.bet-slider {
  flex: 1;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  outline: none;
  -webkit-appearance: none;
}

.bet-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #d4af37;
  cursor: pointer;
  border: 2px solid white;
}

.bet-amount {
  background: rgba(212, 175, 55, 0.2);
  padding: 5px 10px;
  border-radius: 8px;
  font-weight: bold;
  color: #ffd700;
  min-width: 60px;
  text-align: center;
  font-size: 0.9em;
  border: 1px solid rgba(212, 175, 55, 0.3);
}

.action-timer {
  width: 100%;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin-top: 6px;
  overflow: hidden;
  display: none;
}

.timer-bar {
  height: 100%;
  background: linear-gradient(90deg, #2ecc71, #e67e22, #e74c3c);
  width: 100%;
  transition: width 1s linear;
}

.status-message {
  position: fixed;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  padding: 10px 20px;
  border-radius: 20px;
  border: 2px solid #d4af37;
  z-index: 1000;
  font-weight: bold;
  font-size: 1em;
  display: none;
  text-align: center;
  min-width: 250px;
}

/* RESPONSIVO */
@media (max-width: 768px) {
  .table-container {
    width: 90%;
    height: 40%;
    top: 35%;
  }
  
  .poker-table {
    border-width: 8px;
  }
  
  .avatar {
    width: 55px;
    height: 55px;
    font-size: 1.2em;
  }
  
  .player-cards {
    left: 65px;
    width: 75px;
    gap: 4px;
  }
  
  .player-card {
    width: 32px;
    height: 45px;
    font-size: 0.9em;
  }
  
  .controls {
    width: 98%;
    padding: 10px 15px;
    min-height: 80px;
  }
  
  .action-btn {
    padding: 8px 4px;
    min-width: 50px;
    font-size: 0.8em;
    max-width: 65px;
  }
}
</style>

<script>
// ============================================
// POKER ENGINE SIMPLIFICADO
// ============================================
const PokerEngine = (function() {
  const SUITS = { 'H': '‚ô•', 'D': '‚ô¶', 'C': '‚ô£', 'S': '‚ô†' };
  const VALUES = { '2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14 };
  
  class Card {
    constructor(suit, value) {
      this.suit = suit;
      this.value = value;
      this.display = value + SUITS[suit];
    }
  }
  
  class Deck {
    constructor() {
      this.cards = [];
      this.reset();
    }
    
    reset() {
      this.cards = [];
      for (let suit of ['H', 'D', 'C', 'S']) {
        for (let value in VALUES) {
          this.cards.push(new Card(suit, value));
        }
      }
      this.shuffle();
    }
    
    shuffle() {
      for (let i = this.cards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
      }
    }
    
    deal(count) {
      return this.cards.splice(0, count);
    }
  }
  
  class PokerGame {
    constructor(players) {
      this.players = players;
      this.deck = new Deck();
      this.communityCards = [];
      this.pot = 0;
      this.currentRound = 'preflop';
      this.dealerPosition = 0;
      this.currentPlayerTurn = null;
      this.currentMaxBet = 0;
      this.smallBlind = 50;
      this.bigBlind = 100;
    }
    
    startHand() {
      console.log('üÉè Iniciando nova m√£o');
      this.deck.reset();
      this.communityCards = [];
      this.pot = 0;
      this.currentMaxBet = 0;
      
      // Reset players
      this.players.forEach(p => {
        p.cards = [];
        p.bet = 0;
        p.lastAction = null;
        p.hasActed = false;
      });
      
      // Deal cards
      for (let i = 0; i < 2; i++) {
        this.players.forEach(player => {
          if (player.chips > 0) {
            const card = this.deck.deal(1)[0];
            player.cards.push(card);
          }
        });
      }
      
      // Apply blinds
      this.applyBlinds();
      
      // Set first player to act
      this.currentPlayerTurn = this.getNextPlayerToAct();
      
      return this.getGameState();
    }
    
    applyBlinds() {
      const sbIndex = (this.dealerPosition + 1) % this.players.length;
      const bbIndex = (this.dealerPosition + 2) % this.players.length;
      
      const sbPlayer = this.players[sbIndex];
      const bbPlayer = this.players[bbIndex];
      
      if (sbPlayer && sbPlayer.chips > 0) {
        const sbAmount = Math.min(this.smallBlind, sbPlayer.chips);
        sbPlayer.chips -= sbAmount;
        sbPlayer.bet = sbAmount;
        this.pot += sbAmount;
        sbPlayer.lastAction = 'small blind';
        sbPlayer.hasActed = true;
        this.currentMaxBet = sbAmount;
      }
      
      if (bbPlayer && bbPlayer.chips > 0) {
        const bbAmount = Math.min(this.bigBlind, bbPlayer.chips);
        bbPlayer.chips -= bbAmount;
        bbPlayer.bet = bbAmount;
        this.pot += bbAmount;
        bbPlayer.lastAction = 'big blind';
        bbPlayer.hasActed = true;
        this.currentMaxBet = bbAmount;
      }
    }
    
    getNextPlayerToAct() {
      const startIndex = this.currentRound === 'preflop' 
        ? (this.dealerPosition + 3) % this.players.length
        : (this.dealerPosition + 1) % this.players.length;
      
      for (let i = 0; i < this.players.length; i++) {
        const index = (startIndex + i) % this.players.length;
        const player = this.players[index];
        
        if (player.chips > 0 && 
            !player.hasActed && 
            player.lastAction !== 'fold' && 
            !player.isAllIn) {
          return player;
        }
      }
      
      return null;
    }
    
    playerAction(playerId, action, amount = 0) {
      const player = this.players.find(p => p.userId === playerId);
      if (!player) return { error: 'Jogador n√£o encontrado' };
      
      console.log(`üéØ A√ß√£o: ${player.nickname} - ${action} ${amount}`);
      
      switch(action) {
        case 'fold':
          player.lastAction = 'fold';
          player.hasActed = true;
          break;
          
        case 'check':
          if (player.bet < this.currentMaxBet) {
            return { error: 'N√£o pode dar check' };
          }
          player.lastAction = 'check';
          player.hasActed = true;
          break;
          
        case 'call':
          const callAmount = this.currentMaxBet - player.bet;
          if (callAmount > player.chips) {
            // All-in
            player.lastAction = 'allin';
            this.pot += player.chips;
            player.bet += player.chips;
            player.chips = 0;
            player.isAllIn = true;
          } else {
            player.lastAction = 'call';
            player.chips -= callAmount;
            player.bet += callAmount;
            this.pot += callAmount;
          }
          player.hasActed = true;
          break;
          
        case 'raise':
          if (amount <= this.currentMaxBet) {
            return { error: 'Raise muito baixo' };
          }
          const raiseAmount = amount - player.bet;
          if (raiseAmount > player.chips) {
            return { error: 'Fichas insuficientes' };
          }
          player.lastAction = 'raise';
          player.chips -= raiseAmount;
          player.bet = amount;
          this.pot += raiseAmount;
          this.currentMaxBet = amount;
          player.hasActed = true;
          break;
          
        case 'allin':
          player.lastAction = 'allin';
          this.pot += player.chips;
          player.bet += player.chips;
          this.currentMaxBet = Math.max(this.currentMaxBet, player.bet);
          player.chips = 0;
          player.isAllIn = true;
          player.hasActed = true;
          break;
      }
      
      // Verificar se rodada terminou
      if (this.isRoundComplete()) {
        console.log('‚úÖ Rodada completa, avan√ßando...');
        this.advanceRound();
      } else {
        this.currentPlayerTurn = this.getNextPlayerToAct();
      }
      
      return { success: true, gameState: this.getGameState() };
    }
    
    isRoundComplete() {
      const activePlayers = this.players.filter(p => 
        p.chips > 0 && p.lastAction !== 'fold' && !p.isAllIn
      );
      
      if (activePlayers.length <= 1) return true;
      
      // Todos ativos agiram
      const allActed = activePlayers.every(p => p.hasActed);
      if (!allActed) return false;
      
      // Todas apostas igualadas
      return activePlayers.every(p => p.bet === this.currentMaxBet || p.isAllIn);
    }
    
    advanceRound() {
      console.log(`üîÑ Avan√ßando rodada de ${this.currentRound}`);
      
      // Resetar a√ß√µes dos jogadores
      this.players.forEach(p => {
        if (p.lastAction !== 'fold') {
          p.hasActed = false;
          p.bet = 0;
        }
      });
      
      this.currentMaxBet = 0;
      
      switch(this.currentRound) {
        case 'preflop':
          this.communityCards = this.deck.deal(3);
          this.currentRound = 'flop';
          break;
        case 'flop':
          this.communityCards.push(...this.deck.deal(1));
          this.currentRound = 'turn';
          break;
        case 'turn':
          this.communityCards.push(...this.deck.deal(1));
          this.currentRound = 'river';
          break;
        case 'river':
          this.determineWinner();
          this.currentRound = 'showdown';
          setTimeout(() => {
            this.startHand();
          }, 5000);
          return;
      }
      
      this.currentPlayerTurn = this.getNextPlayerToAct();
    }
    
    determineWinner() {
      console.log('üèÜ Determinando vencedor...');
      // Implementa√ß√£o simplificada - ganha quem tiver fichas
      const activePlayers = this.players.filter(p => p.lastAction !== 'fold');
      if (activePlayers.length === 1) {
        activePlayers[0].chips += this.pot;
        console.log(`üèÜ ${activePlayers[0].nickname} ganhou ${this.pot}`);
      }
      this.pot = 0;
    }
    
    getGameState() {
      return {
        players: this.players.map(p => ({
          userId: p.userId,
          nickname: p.nickname,
          chips: p.chips,
          bet: p.bet,
          lastAction: p.lastAction,
          cards: p.cards ? p.cards.map(c => c.display) : [],
          hasActed: p.hasActed,
          isAllIn: p.isAllIn || false
        })),
        communityCards: this.communityCards.map(c => c.display),
        pot: this.pot,
        round: this.currentRound,
        dealerPosition: this.dealerPosition,
        currentMaxBet: this.currentMaxBet,
        currentPlayerTurn: this.currentPlayerTurn ? this.currentPlayerTurn.userId : null
      };
    }
  }
  
  return { PokerGame };
})();
</script>
</head>
<body>
<!-- CABE√áALHO -->
<div class="header">
  <div class="tournament-info" id="tournamentName">Torneio</div>
  <div class="game-stats">
    <div class="stat" id="blinds">50/100</div>
    <div class="stat" id="pot">Pote: 0</div>
    <div class="stat" id="playersCount">1/6</div>
  </div>
</div>

<!-- MENSAGEM DE STATUS -->
<div class="status-message" id="statusMessage"></div>

<!-- CONTAINER DA MESA -->
<div class="table-container">
  <div class="poker-table">
    <!-- √ÅREA CENTRAL -->
    <div class="table-center">
      <div class="community-cards" id="communityCards">
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
      </div>
      <div class="pot" id="potAmount">0</div>
    </div>
  </div>
</div>

<!-- AVATARES -->
<div class="avatar-container pos-1" id="playerPos1">
  <div class="avatar" id="avatar1">?</div>
  <div class="blind-indicator" id="blind1" style="display: none;"></div>
  <div class="dealer-button" id="dealer1" style="display: none;">D</div>
  <div class="player-cards" style="display: none;">
    <div class="player-card" id="playerCard1A">?</div>
    <div class="player-card" id="playerCard1B">?</div>
  </div>
  <div class="player-chips" id="chips1">-<br>0</div>
</div>

<div class="avatar-container pos-2" id="playerPos2">
  <div class="avatar" id="avatar2">?</div>
  <div class="blind-indicator" id="blind2" style="display: none;"></div>
  <div class="dealer-button" id="dealer2" style="display: none;">D</div>
  <div class="player-cards" style="display: none;">
    <div class="player-card" id="playerCard2A">?</div>
    <div class="player-card" id="playerCard2B">?</div>
  </div>
  <div class="player-chips" id="chips2">-<br>0</div>
</div>

<div class="avatar-container pos-3" id="playerPos3">
  <div class="avatar" id="avatar3">?</div>
  <div class="blind-indicator" id="blind3" style="display: none;"></div>
  <div class="dealer-button" id="dealer3" style="display: none;">D</div>
  <div class="player-cards" style="display: none;">
    <div class="player-card" id="playerCard3A">?</div>
    <div class="player-card" id="playerCard3B">?</div>
  </div>
  <div class="player-chips" id="chips3">-<br>0</div>
</div>

<div class="avatar-container pos-4" id="playerPos4">
  <div class="avatar" id="avatar4">?</div>
  <div class="blind-indicator" id="blind4" style="display: none;"></div>
  <div class="dealer-button" id="dealer4" style="display: none;">D</div>
  <div class="player-cards" style="display: none;">
    <div class="player-card" id="playerCard4A">?</div>
    <div class="player-card" id="playerCard4B">?</div>
  </div>
  <div class="player-chips" id="chips4">-<br>0</div>
</div>

<div class="avatar-container pos-5" id="playerPos5">
  <div class="avatar" id="avatar5">?</div>
  <div class="blind-indicator" id="blind5" style="display: none;"></div>
  <div class="dealer-button" id="dealer5" style="display: none;">D</div>
  <div class="player-cards" style="display: none;">
    <div class="player-card" id="playerCard5A">?</div>
    <div class="player-card" id="playerCard5B">?</div>
  </div>
  <div class="player-chips" id="chips5">-<br>0</div>
</div>

<div class="avatar-container pos-6" id="playerPos6">
  <div class="avatar" id="avatar6">?</div>
  <div class="blind-indicator" id="blind6" style="display: none;"></div>
  <div class="dealer-button" id="dealer6" style="display: none;">D</div>
  <div class="player-cards" style="display: none;">
    <div class="player-card" id="playerCard6A">?</div>
    <div class="player-card" id="playerCard6B">?</div>
  </div>
  <div class="player-chips" id="chips6">-<br>0</div>
</div>

<!-- CONTROLES -->
<div class="controls-container">
  <div class="controls" id="playerControls">
    <div class="action-buttons" id="actionButtons">
      <button class="action-btn btn-fold" id="btnFold">Fold</button>
      <button class="action-btn btn-check" id="btnCheck" style="display: none;">Check</button>
      <button class="action-btn btn-call" id="btnCall" style="display: none;">Call 0</button>
      <button class="action-btn btn-raise" id="btnRaise" style="display: none;">Raise</button>
      <button class="action-btn btn-allin" id="btnAllIn" style="display: none;">All-in</button>
    </div>

    <div class="bet-controls" id="raiseControls">
      <input type="range" min="0" max="100" value="0" class="bet-slider" id="betSlider">
      <div class="bet-amount" id="betAmount">0</div>
      <button class="action-btn btn-raise" id="btnConfirmRaise">Confirmar</button>
      <button class="action-btn btn-fold" id="btnCancelRaise">Cancelar</button>
    </div>

    <div class="action-timer" id="actionTimerContainer">
      <div class="timer-bar" id="actionTimerBar"></div>
    </div>
  </div>
</div>

<script>
// =============================================
// SISTEMA PRINCIPAL CORRIGIDO
// =============================================

// VARI√ÅVEIS GLOBAIS
let currentUser = null;
let tournamentId = null;
let tournamentData = null;
let realtimeListener = null;
let pokerGame = null;
let gameStarted = false;
let isMyTurn = false;
let actionTimerInterval = null;
let timeLeft = 30;

// INICIALIZA√á√ÉO
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéÆ Sistema de Poker iniciando...');
    
    const urlParams = new URLSearchParams(window.location.search);
    tournamentId = urlParams.get('tournamentId');
    
    if (!tournamentId) {
        alert('Torneio n√£o encontrado!');
        window.location.href = 'torneios.html';
        return;
    }
    
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        
        currentUser = user;
        console.log('‚úÖ Usu√°rio:', user.email);
        
        await loadTournamentData();
        setupEventListeners();
        setupRealtimeListener();
    });
});

// CARREGAR TORNEIO
async function loadTournamentData() {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            throw new Error('Torneio n√£o encontrado');
        }
        
        tournamentData = tournamentDoc.data();
        tournamentData.id = tournamentId;
        
        console.log('üìä Torneio:', tournamentData.name);
        console.log('üë• Jogadores:', tournamentData.players?.length || 0);
        
        document.getElementById('tournamentName').textContent = tournamentData.name;
        updatePlayerCount();
        
        // Verificar se estou inscrito
        const myPlayer = tournamentData.players?.find(p => p.userId === currentUser.uid);
        if (!myPlayer) {
            alert('Voc√™ n√£o est√° inscrito neste torneio');
            window.location.href = 'torneios.html';
            return;
        }
        
        initializeInterface();
        
        // Iniciar jogo se tiver jogadores suficientes
        if (tournamentData.players?.length >= 2 && !gameStarted) {
            startGame();
        }
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        alert('Erro: ' + error.message);
    }
}

function updatePlayerCount() {
    if (!tournamentData) return;
    const count = tournamentData.players?.length || 1;
    const max = tournamentData.maxPlayers || 6;
    document.getElementById('playersCount').textContent = `${count}/${max}`;
}

// INICIALIZAR INTERFACE
function initializeInterface() {
    if (!tournamentData?.players) return;
    
    // Resetar todos os avatares
    for (let i = 1; i <= 6; i++) {
        const avatar = document.getElementById(`avatar${i}`);
        const chips = document.getElementById(`chips${i}`);
        const container = document.getElementById(`playerPos${i}`);
        
        if (avatar) avatar.innerHTML = '?';
        if (chips) chips.innerHTML = '-<br>0';
        if (container) {
            container.classList.remove('player-you', 'current-turn', 'player-folded');
            container.querySelector('.player-cards')?.style.setProperty('display', 'none');
        }
    }
    
    // Mostrar jogadores
    tournamentData.players.forEach((player, index) => {
        if (index < 6) {
            const pos = index + 1;
            const avatar = document.getElementById(`avatar${pos}`);
            const chips = document.getElementById(`chips${pos}`);
            const container = document.getElementById(`playerPos${pos}`);
            
            if (!avatar || !chips || !container) return;
            
            // Verificar se sou eu
            if (player.userId === currentUser.uid) {
                container.classList.add('player-you');
            }
            
            // Mostrar nome (corrigido)
            const displayName = player.nickname || `Jogador ${index + 1}`;
            
            // Avatar
            const initial = displayName.charAt(0).toUpperCase();
            avatar.textContent = initial;
            avatar.title = displayName;
            
            // Fichas
            chips.innerHTML = `${displayName}<br>${player.chips || 1500}`;
            
            // Mostrar minhas cartas se existirem
            if (player.userId === currentUser.uid && player.cards && player.cards.length >= 2) {
                showMyCards(pos, player.cards);
            }
        }
    });
}

function showMyCards(position, cards) {
    const container = document.getElementById(`playerPos${position}`);
    if (!container) return;
    
    const cardsContainer = container.querySelector('.player-cards');
    if (!cardsContainer) return;
    
    cardsContainer.style.display = 'flex';
    const cardElements = cardsContainer.querySelectorAll('.player-card');
    
    if (cardElements.length >= 2) {
        cardElements[0].textContent = cards[0] || '?';
        cardElements[1].textContent = cards[1] || '?';
        
        // Cores
        cardElements[0].style.color = (cards[0]?.includes('‚ô•') || cards[0]?.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
        cardElements[1].style.color = (cards[1]?.includes('‚ô•') || cards[1]?.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
    }
}

// LISTENER EM TEMPO REAL
function setupRealtimeListener() {
    console.log('üì° Configurando listener...');
    
    realtimeListener = db.collection('tournaments').doc(tournamentId)
        .onSnapshot((doc) => {
            if (!doc.exists) return;
            
            const newData = doc.data();
            tournamentData = newData;
            
            console.log('üîÑ Update recebido');
            
            updateInterface();
            checkMyTurn();
            updateGameState();
            
        }, (error) => {
            console.error('‚ùå Erro no listener:', error);
        });
}

function updateInterface() {
    if (!tournamentData) return;
    
    updatePlayerCount();
    updatePotDisplay();
    updateCommunityCards();
    updatePlayerDisplays();
    updateBlindIndicators();
}

function updatePotDisplay() {
    const pot = tournamentData.pot || 0;
    document.getElementById('pot').textContent = `Pote: ${pot}`;
    document.getElementById('potAmount').textContent = pot;
}

function updateCommunityCards() {
    const cards = tournamentData.communityCards || [];
    const container = document.getElementById('communityCards');
    const cardElements = container.querySelectorAll('.card-placeholder');
    
    cardElements.forEach((cardEl, index) => {
        if (cards[index]) {
            cardEl.textContent = cards[index];
            cardEl.style.background = 'white';
            cardEl.style.color = (cards[index].includes('‚ô•') || cards[index].includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
        } else {
            cardEl.textContent = '';
            cardEl.style.background = 'rgba(255,255,255,0.1)';
        }
    });
}

function updatePlayerDisplays() {
    if (!tournamentData?.players) return;
    
    // Resetar turnos
    for (let i = 1; i <= 6; i++) {
        const avatar = document.getElementById(`avatar${i}`);
        if (avatar) avatar.classList.remove('current-turn', 'player-folded');
    }
    
    // Atualizar cada jogador
    tournamentData.players.forEach((player, index) => {
        if (index < 6) {
            const pos = index + 1;
            const avatar = document.getElementById(`avatar${pos}`);
            const chips = document.getElementById(`chips${pos}`);
            const container = document.getElementById(`playerPos${pos}`);
            
            if (!avatar || !chips) return;
            
            // Atualizar fichas
            const displayName = player.nickname || `Jogador ${index + 1}`;
            chips.innerHTML = `${displayName}<br>${player.chips || 0}`;
            
            // Turno atual
            if (tournamentData.currentPlayerTurn === player.userId) {
                avatar.classList.add('current-turn');
            }
            
            // Folded
            if (player.lastAction === 'fold') {
                avatar.classList.add('player-folded');
            }
            
            // Minhas cartas
            if (player.userId === currentUser.uid && player.cards) {
                showMyCards(pos, player.cards);
            }
        }
    });
}

function updateBlindIndicators() {
    if (!tournamentData?.players) return;
    
    // Resetar
    for (let i = 1; i <= 6; i++) {
        document.getElementById(`blind${i}`).style.display = 'none';
        document.getElementById(`dealer${i}`).style.display = 'none';
    }
    
    const activePlayers = tournamentData.players.filter(p => p.chips > 0);
    if (activePlayers.length < 2) return;
    
    const dealerPos = tournamentData.dealerPosition || 0;
    const sbPos = (dealerPos + 1) % activePlayers.length;
    const bbPos = (dealerPos + 2) % activePlayers.length;
    
    // Mostrar indicadores
    if (activePlayers[dealerPos]) {
        const dealerIndex = tournamentData.players.findIndex(p => 
            p.userId === activePlayers[dealerPos].userId
        );
        if (dealerIndex >= 0 && dealerIndex < 6) {
            document.getElementById(`dealer${dealerIndex + 1}`).style.display = 'flex';
        }
    }
    
    if (activePlayers[sbPos]) {
        const sbIndex = tournamentData.players.findIndex(p => 
            p.userId === activePlayers[sbPos].userId
        );
        if (sbIndex >= 0 && sbIndex < 6) {
            const blindEl = document.getElementById(`blind${sbIndex + 1}`);
            blindEl.textContent = 'SB';
            blindEl.style.display = 'flex';
        }
    }
    
    if (activePlayers[bbPos]) {
        const bbIndex = tournamentData.players.findIndex(p => 
            p.userId === activePlayers[bbPos].userId
        );
        if (bbIndex >= 0 && bbIndex < 6) {
            const blindEl = document.getElementById(`blind${bbIndex + 1}`);
            blindEl.textContent = 'BB';
            blindEl.style.display = 'flex';
        }
    }
}

// VERIFICAR MEU TURNO
function checkMyTurn() {
    if (!tournamentData?.currentPlayerTurn) {
        disablePlayerControls();
        stopActionTimer();
        return;
    }
    
    isMyTurn = tournamentData.currentPlayerTurn === currentUser.uid;
    
    if (isMyTurn) {
        console.log('‚úÖ √â MINHA VEZ!');
        enablePlayerControls();
        startActionTimer();
        showNotification('‚úÖ SUA VEZ! Fa√ßa sua jogada.', 'turn');
    } else {
        console.log('‚è≥ Aguardando vez...');
        disablePlayerControls();
        stopActionTimer();
    }
}

function updateGameState() {
    if (!tournamentData) return;
    
    // Atualizar bot√µes com base no estado
    const myPlayer = tournamentData.players?.find(p => p.userId === currentUser.uid);
    if (!myPlayer) return;
    
    const checkBtn = document.getElementById('btnCheck');
    const callBtn = document.getElementById('btnCall');
    const raiseBtn = document.getElementById('btnRaise');
    const allinBtn = document.getElementById('btnAllIn');
    
    const myBet = myPlayer.bet || 0;
    const maxBet = tournamentData.currentMaxBet || 0;
    const myChips = myPlayer.chips || 0;
    const callAmount = Math.max(0, maxBet - myBet);
    
    // Mostrar bot√µes corretos
    if (myBet >= maxBet) {
        checkBtn.style.display = 'block';
        callBtn.style.display = 'none';
    } else {
        checkBtn.style.display = 'none';
        callBtn.style.display = 'block';
        callBtn.textContent = `Call ${callAmount}`;
    }
    
    // Raise e All-in
    raiseBtn.style.display = myChips > callAmount ? 'block' : 'none';
    allinBtn.style.display = myChips > 0 ? 'block' : 'none';
    allinBtn.textContent = `All-in ${myChips}`;
}

// INICIAR JOGO
async function startGame() {
    if (gameStarted) return;
    
    try {
        console.log('üöÄ Iniciando jogo...');
        gameStarted = true;
        
        // Preparar jogadores para o motor
        const players = tournamentData.players.map((player, index) => ({
            userId: player.userId,
            nickname: player.nickname || `Jogador ${index + 1}`,
            chips: player.chips || 1500,
            position: index,
            cards: [],
            bet: 0,
            lastAction: null,
            hasActed: false,
            isAllIn: false
        }));
        
        // Criar jogo
        pokerGame = new PokerEngine.PokerGame(players);
        const gameState = pokerGame.startHand();
        
        // Salvar estado inicial
        await db.collection('tournaments').doc(tournamentId).update({
            players: gameState.players,
            communityCards: gameState.communityCards,
            pot: gameState.pot,
            currentRound: gameState.round,
            dealerPosition: gameState.dealerPosition,
            currentMaxBet: gameState.currentMaxBet,
            currentPlayerTurn: gameState.currentPlayerTurn,
            gameState: 'active',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('üéÆ Jogo iniciado! Boa sorte!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro ao iniciar jogo:', error);
        gameStarted = false;
    }
}

// A√á√ïES DO JOGADOR
async function playerAction(action, amount = 0) {
    if (!isMyTurn || !pokerGame) {
        showNotification('N√£o √© sua vez!', 'error');
        return;
    }
    
    console.log(`üéØ Executando a√ß√£o: ${action} ${amount}`);
    
    try {
        const result = pokerGame.playerAction(currentUser.uid, action, amount);
        
        if (result.error) {
            showNotification(result.error, 'error');
            return;
        }
        
        // Atualizar Firestore
        await db.collection('tournaments').doc(tournamentId).update({
            players: result.gameState.players,
            communityCards: result.gameState.communityCards,
            pot: result.gameState.pot,
            currentRound: result.gameState.round,
            currentMaxBet: result.gameState.currentMaxBet,
            currentPlayerTurn: result.gameState.currentPlayerTurn,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification(`‚úÖ ${action.toUpperCase()} realizado!`, 'success');
        stopActionTimer();
        
    } catch (error) {
        console.error('‚ùå Erro na a√ß√£o:', error);
        showNotification('Erro: ' + error.message, 'error');
    }
}

// EVENT LISTENERS
function setupEventListeners() {
    // Bot√µes de a√ß√£o
    document.getElementById('btnFold').addEventListener('click', () => playerAction('fold'));
    document.getElementById('btnCheck').addEventListener('click', () => playerAction('check'));
    document.getElementById('btnCall').addEventListener('click', () => playerAction('call'));
    document.getElementById('btnAllIn').addEventListener('click', () => playerAction('allin'));
    
    // Raise
    document.getElementById('btnRaise').addEventListener('click', showRaiseControls);
    document.getElementById('btnConfirmRaise').addEventListener('click', confirmRaise);
    document.getElementById('btnCancelRaise').addEventListener('click', hideRaiseControls);
    document.getElementById('betSlider').addEventListener('input', updateBetAmount);
    
    console.log('‚úÖ Event listeners configurados');
}

// CONTROLES DE RAISE
function showRaiseControls() {
    if (!isMyTurn) return;
    
    const myPlayer = tournamentData.players?.find(p => p.userId === currentUser.uid);
    if (!myPlayer) return;
    
    const myChips = myPlayer.chips || 0;
    const maxBet = tournamentData.currentMaxBet || 0;
    const myBet = myPlayer.bet || 0;
    const minRaise = Math.max(50, (maxBet - myBet) * 2);
    
    const slider = document.getElementById('betSlider');
    slider.min = minRaise;
    slider.max = myChips;
    slider.value = Math.min(Math.max(minRaise, myBet + 100), myChips);
    
    document.getElementById('raiseControls').style.display = 'flex';
    document.getElementById('actionButtons').style.display = 'none';
    
    updateBetAmount();
}

function hideRaiseControls() {
    document.getElementById('raiseControls').style.display = 'none';
    document.getElementById('actionButtons').style.display = 'flex';
}

function updateBetAmount() {
    const amount = parseInt(document.getElementById('betSlider').value) || 0;
    document.getElementById('betAmount').textContent = amount;
}

function confirmRaise() {
    const amount = parseInt(document.getElementById('betAmount').textContent);
    if (amount > 0) {
        playerAction('raise', amount);
        hideRaiseControls();
    }
}

// TIMER
function startActionTimer() {
    timeLeft = 30;
    const timerBar = document.getElementById('actionTimerBar');
    timerBar.style.width = '100%';
    timerBar.style.background = '#2ecc71';
    
    stopActionTimer();
    
    actionTimerInterval = setInterval(() => {
        timeLeft--;
        const percentage = (timeLeft / 30) * 100;
        timerBar.style.width = percentage + '%';
        
        if (timeLeft <= 10) {
            timerBar.style.background = '#e74c3c';
        } else if (timeLeft <= 20) {
            timerBar.style.background = '#e67e22';
        }
        
        if (timeLeft <= 0) {
            console.log('‚è∞ Tempo esgotado! Fold autom√°tico.');
            playerAction('fold');
            stopActionTimer();
        }
    }, 1000);
}

function stopActionTimer() {
    if (actionTimerInterval) {
        clearInterval(actionTimerInterval);
        actionTimerInterval = null;
    }
}

// CONTROLES DO JOGADOR
function enablePlayerControls() {
    document.getElementById('actionTimerContainer').style.display = 'block';
    updateGameState(); // Atualiza quais bot√µes mostrar
}

function disablePlayerControls() {
    document.getElementById('actionTimerContainer').style.display = 'none';
    hideRaiseControls();
}

// NOTIFICA√á√ïES
function showNotification(message, type = 'info') {
    const messageEl = document.getElementById('statusMessage');
    if (!messageEl) return;
    
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    switch (type) {
        case 'error':
            messageEl.style.background = 'rgba(231, 76, 60, 0.95)';
            messageEl.style.borderColor = '#c0392b';
            break;
        case 'success':
            messageEl.style.background = 'rgba(46, 204, 113, 0.95)';
            messageEl.style.borderColor = '#27ae60';
            break;
        case 'turn':
            messageEl.style.background = 'rgba(52, 152, 219, 0.95)';
            messageEl.style.borderColor = '#2980b9';
            break;
    }
    
    if (type !== 'turn') {
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 3000);
    }
}

// LIMPEZA
window.addEventListener('beforeunload', () => {
    if (realtimeListener) realtimeListener();
    stopActionTimer();
});

console.log('‚úÖ Sistema pronto!');
</script>
</body>
</html>