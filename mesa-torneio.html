<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Mesa de Torneio | KeepPoker</title>
 
 <!-- Firebase -->
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
 
 <script>
   // Firebase Configuration
   const firebaseConfig = {
     apiKey: "AIzaSyBIBucZSzN671VgJQHGIiepHNUqxbqNKAQ",
     authDomain: "keeppoker-b4173.firebaseapp.com",
     projectId: "keeppoker-b4173",
     storageBucket: "keeppoker-b4173.firebasestorage.app",
     messagingSenderId: "436464592434",
     appId: "1:436464592434:web:c5a1e0c10e10acbc14fe2b"
   };
   
   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();
 </script>
 
 <!-- Poker Engine -->
 <script src="poker-engine.js"></script>
 
<style>
/* ===== RESET E BASE ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #0a1520;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* ===== CABE√áALHO ===== */
.header {
  height: 50px;
  background: rgba(13, 27, 42, 0.9);
  border-bottom: 2px solid #d4af37;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
}

.tournament-info {
  font-size: 1em;
  color: #d4af37;
  font-weight: bold;
}

.game-stats {
  display: flex;
  gap: 10px;
}

.stat {
  background: rgba(212, 175, 55, 0.15);
  padding: 4px 8px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  font-weight: bold;
  font-size: 0.9em;
}

/* ===== MESA ===== */
.table-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 70%;
  height: 50%;
  z-index: 1;
}

.poker-table {
  width: 100%;
  height: 100%;
  background: #0a5c36;
  border: 15px solid #8B4513;
  border-radius: 50% / 40%;
  box-shadow:
    inset 0 0 40px rgba(0, 0, 0, 0.6),
    0 0 30px rgba(0, 0, 0, 0.7);
  position: relative;
  overflow: visible;
}

.table-center {
  position: absolute;
  top: 52%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 45%;
  height: 35%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.community-cards {
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
}

.card-placeholder {
  width: 50px;
  height: 70px;
  background: white;
  border-radius: 5px;
  border: 2px solid #333;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.2em;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  color: #2c3e50;
}

.pot {
  color: #d4af37;
  font-size: 1.4em;
  font-weight: bold;
  margin-top: 5px;
}

/* ===== AVATARES ===== */
.avatar-container {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 20;
}

.avatar {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: linear-gradient(135deg, #415a77, #1b263b);
  border: 3px solid #d4af37;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.4em;
  margin-bottom: 5px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
  position: relative;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.player-cards {
  position: absolute;
  left: 85px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 5px;
  z-index: 25;
  width: 90px;
}

.player-card {
  width: 40px;
  height: 56px;
  background: white;
  border-radius: 4px;
  border: 2px solid #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1em;
  color: #000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.player-chips {
  background: rgba(0, 0, 0, 0.7);
  color: #ffd700;
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 0.9em;
  font-weight: bold;
  margin-top: 5px;
  min-width: 80px;
  text-align: center;
}

.current-turn .avatar {
  border-color: #00ff00;
  box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
}

.player-bet {
  position: absolute;
  top: -15px;
  background: rgba(212, 175, 55, 0.9);
  color: #000;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.8em;
  white-space: nowrap;
}

.player-folded .avatar {
  opacity: 0.5;
  border-color: #666;
}

.player-info {
  background: rgba(13, 27, 42, 0.95);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  text-align: center;
  min-width: 100px;
  font-size: 0.9em;
  display: none;
}

/* ===== INDICADORES DE BLIND ===== */
.blind-indicator {
  position: absolute;
  top: -10px;
  right: -10px;
  background: #d4af37;
  color: #000;
  padding: 2px 5px;
  border-radius: 50%;
  font-size: 0.7em;
  font-weight: bold;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 35;
}

.dealer-button {
  position: absolute;
  bottom: -10px;
  right: -10px;
  background: #fff;
  color: #000;
  padding: 2px 5px;
  border-radius: 50%;
  font-size: 0.7em;
  font-weight: bold;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 35;
  border: 2px solid #d4af37;
}

/* ===== POSI√á√ïES DESKTOP ===== */
.pos-1 {
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
}

.pos-2 {
  top: 140px;
  right: 15%;
}

.pos-3 {
  bottom: 140px;
  right: 15%;
}

.pos-4 {
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
}

.pos-5 {
  bottom: 140px;
  left: 15%;
}

.pos-6 {
  top: 140px;
  left: 15%;
}

/* JOGADOR ATUAL */
.player-you .avatar {
  border-color: #3498db;
  box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
}

.player-you .player-info {
  display: block;
}

/* ===== CONTROLES ===== */
.controls-container {
  position: fixed;
  bottom: 8px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  z-index: 1000;
}

.controls {
  background: rgba(13, 27, 42, 0.95);
  padding: 12px 20px;
  border-radius: 12px;
  border: 2px solid #d4af37;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 95%;
  max-width: 500px;
  min-height: 90px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.7);
}

.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: nowrap;
  justify-content: center;
  width: 100%;
}

.action-btn {
  padding: 10px 8px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  min-width: 60px;
  font-size: 0.9em;
  transition: all 0.3s;
  flex: 1;
  max-width: 80px;
}

.btn-fold { background: #e74c3c; color: white; }
.btn-check { background: #3498db; color: white; }
.btn-call { background: #2ecc71; color: white; }
.btn-raise { background: #9b59b6; color: white; }
.btn-allin { background: #e67e22; color: white; }

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.bet-controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 4px;
  width: 100%;
  display: none;
}

.bet-slider {
  flex: 1;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  outline: none;
  -webkit-appearance: none;
}

.bet-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #d4af37;
  cursor: pointer;
  border: 2px solid white;
}

.bet-amount {
  background: rgba(212, 175, 55, 0.2);
  padding: 5px 10px;
  border-radius: 8px;
  font-weight: bold;
  color: #ffd700;
  min-width: 60px;
  text-align: center;
  font-size: 0.9em;
  border: 1px solid rgba(212, 175, 55, 0.3);
}

.action-timer {
  width: 100%;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin-top: 6px;
  overflow: hidden;
  display: none;
}

.timer-bar {
  height: 100%;
  background: linear-gradient(90deg, #2ecc71, #e67e22, #e74c3c);
  width: 100%;
  transition: width 1s linear;
}

.status-message {
  position: fixed;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  padding: 10px 20px;
  border-radius: 20px;
  border: 2px solid #d4af37;
  z-index: 1000;
  font-weight: bold;
  font-size: 1em;
  display: none;
  text-align: center;
  min-width: 250px;
}

/* ===== RESPONSIVIDADE MOBILE - 6 POSI√á√ïES SIM√âTRICAS ===== */
@media (max-width: 768px) {
  /* MESA MOBILE */
  .table-container {
    width: 90%;
    height: 40%;
    top: 35%;
  }
  
  .poker-table {
    border-width: 8px;
  }
  
  .table-center {
    width: 55%;
    height: 40%;
  }
  
  .community-cards {
    gap: 5px;
  }
  
  .card-placeholder {
    width: 35px;
    height: 50px;
    font-size: 0.9em;
  }
  
  .pot {
    font-size: 1.2em;
  }
  
  /* AVATARES MOBILE - CARTAS MAIORES */
  .avatar {
    width: 55px;
    height: 55px;
    font-size: 1.2em;
  }
  
  .player-cards {
    left: 65px;
    width: 75px;
    gap: 4px;
  }
  
  .player-card {
    width: 32px;
    height: 45px;
    font-size: 0.9em;
  }
  
  .player-chips {
    font-size: 0.8em;
    min-width: 70px;
    padding: 3px 6px;
  }
  
  /* POSI√á√ïES MOBILE - 6 LUGARES SIM√âTRICOS */
  .pos-1 {
    top: 20px !important;
    left: 50% !important;
    right: auto !important;
    bottom: auto !important;
    transform: translateX(-50%) !important;
  }
  
  .pos-2 {
    top: 25% !important;
    right: 15px !important;
    left: auto !important;
    bottom: auto !important;
    transform: none !important;
  }
  
  .pos-3 {
    bottom: 25% !important;
    right: 15px !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
    display: block !important; /* GARANTIR VIS√çVEL */
  }
  
  .pos-4 {
    bottom: 20px !important;
    left: 50% !important;
    right: auto !important;
    top: auto !important;
    transform: translateX(-50%) !important;
  }
  
  .pos-5 {
    bottom: 25% !important;
    left: 15px !important;
    right: auto !important;
    top: auto !important;
    transform: none !important;
    display: block !important; /* GARANTIR VIS√çVEL */
  }
  
  .pos-6 {
    top: 25% !important;
    left: 15px !important;
    right: auto !important;
    bottom: auto !important;
    transform: none !important;
  }
  
  /* INDICADORES DE BLIND MOBILE */
  .blind-indicator {
    width: 16px;
    height: 16px;
    font-size: 0.6em;
  }
  
  .dealer-button {
    width: 16px;
    height: 16px;
    font-size: 0.6em;
  }
  
  /* CONTROLES MOBILE */
  .controls {
    width: 98%;
    padding: 10px 15px;
    min-height: 80px;
  }
  
  .action-buttons {
    gap: 5px;
  }
  
  .action-btn {
    padding: 8px 4px;
    min-width: 50px;
    font-size: 0.8em;
    max-width: 65px;
  }
  
  .bet-controls {
    gap: 6px;
    flex-wrap: wrap;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  /* MOBILE PEQUENO - AJUSTES */
  .avatar {
    width: 50px;
    height: 50px;
    font-size: 1.1em;
  }
  
  .player-cards {
    left: 55px;
    width: 65px;
  }
  
  .player-card {
    width: 28px;
    height: 40px;
    font-size: 0.85em;
  }
  
  .pos-2, .pos-3 {
    right: 10px !important;
  }
  
  .pos-5, .pos-6 {
    left: 10px !important;
  }
  
  .controls {
    width: 99%;
    padding: 8px 10px;
    min-height: 70px;
  }
  
  .action-btn {
    padding: 6px 3px;
    min-width: 45px;
    font-size: 0.75em;
    max-width: 55px;
  }
}
</style>
</head>
<body>
<!-- CABE√áALHO -->
<div class="header">
  <div class="tournament-info" id="tournamentName">Torneio</div>
  <div class="game-stats">
    <div class="stat" id="blinds">100/200</div>
    <div class="stat" id="pot">Pote: 0</div>
    <div class="stat" id="playersCount">1/6</div>
  </div>
</div>

<!-- MENSAGEM DE STATUS -->
<div class="status-message" id="statusMessage"></div>

<!-- CONTAINER DA MESA -->
<div class="table-container">
  <div class="poker-table">
    <!-- √ÅREA CENTRAL -->
    <div class="table-center">
      <div class="community-cards" id="communityCards">
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
      </div>
      <div class="pot" id="potAmount">0</div>
    </div>
  </div>
</div>

<!-- AVATARES -->
<div class="avatar-container pos-1" id="playerPos1">
  <div class="avatar" id="avatar1">?</div>
  <div class="blind-indicator" id="blind1" style="display: none;"></div>
  <div class="dealer-button" id="dealer1" style="display: none;">D</div>
  <div class="player-cards">
    <div class="player-card" id="playerCard1">?</div>
    <div class="player-card" id="playerCard2">?</div>
  </div>
  <div class="player-chips" id="chips1">-<br>0</div>
</div>

<div class="avatar-container pos-2" id="playerPos2">
  <div class="avatar" id="avatar2">?</div>
  <div class="blind-indicator" id="blind2" style="display: none;"></div>
  <div class="dealer-button" id="dealer2" style="display: none;">D</div>
  <div class="player-chips" id="chips2">-<br>0</div>
</div>

<div class="avatar-container pos-3" id="playerPos3">
  <div class="avatar" id="avatar3">?</div>
  <div class="blind-indicator" id="blind3" style="display: none;"></div>
  <div class="dealer-button" id="dealer3" style="display: none;">D</div>
  <div class="player-chips" id="chips3">-<br>0</div>
</div>

<div class="avatar-container pos-4" id="playerPos4">
  <div class="avatar" id="avatar4">?</div>
  <div class="blind-indicator" id="blind4" style="display: none;"></div>
  <div class="dealer-button" id="dealer4" style="display: none;">D</div>
  <div class="player-chips" id="chips4">-<br>0</div>
</div>

<div class="avatar-container pos-5" id="playerPos5">
  <div class="avatar" id="avatar5">?</div>
  <div class="blind-indicator" id="blind5" style="display: none;"></div>
  <div class="dealer-button" id="dealer5" style="display: none;">D</div>
  <div class="player-chips" id="chips5">-<br>0</div>
</div>

<div class="avatar-container pos-6" id="playerPos6">
  <div class="avatar" id="avatar6">?</div>
  <div class="blind-indicator" id="blind6" style="display: none;"></div>
  <div class="dealer-button" id="dealer6" style="display: none;">D</div>
  <div class="player-chips" id="chips6">-<br>0</div>
</div>

<!-- CONTROLES -->
<div class="controls-container">
  <div class="controls" id="playerControls">
    <div class="action-buttons" id="actionButtons">
      <button class="action-btn btn-fold" id="btnFold">Fold</button>
      <button class="action-btn btn-check" id="btnCheck">Check</button>
      <button class="action-btn btn-call" id="btnCall">Call</button>
      <button class="action-btn btn-raise" id="btnRaise">Raise</button>
      <button class="action-btn btn-allin" id="btnAllIn">All-in</button>
    </div>

    <div class="bet-controls" id="raiseControls">
      <input type="range" min="0" max="100" value="0" class="bet-slider" id="betSlider">
      <div class="bet-amount" id="betAmount">0</div>
      <button class="action-btn btn-raise" id="btnConfirmRaise">Confirmar</button>
      <button class="action-btn btn-fold" id="btnCancelRaise">Cancelar</button>
    </div>

    <div class="action-timer" id="actionTimerContainer">
      <div class="timer-bar" id="actionTimerBar"></div>
    </div>
  </div>
</div>

<script>
// =============================================
// SISTEMA DE POKER - 6 POSI√á√ïES + FLUXO COMPLETO
// =============================================
let tournamentId = null;
let tournamentData = null;
let currentUser = null;
let pokerGame = null;
let realtimeListener = null;
let actionTimerInterval = null;
let timeLeft = 30;
let myPlayerPosition = -1;
let gameStarted = false;
let myCards = [];
let currentBet = 0;
let actionPhase = 'waiting';
let isActionProcessing = false;
let dealerPosition = 0;

const positionMap = [1, 2, 6, 3, 5, 4];

// =============================================
// 1. INICIALIZA√á√ÉO
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    tournamentId = urlParams.get('tournamentId');
    
    if (!tournamentId) {
        window.location.href = 'torneios.html';
        return;
    }
    
    auth.onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        
        currentUser = user;
        await loadTournamentData();
        
        if (!isUserInTournament()) {
            alert('Voc√™ n√£o est√° inscrito neste torneio');
            window.location.href = 'torneios.html';
            return;
        }
        
        initializeInterface();
        setupRealtimeListener();
        setupEventListeners();
        checkIfGameCanStart();
    });
});

async function loadTournamentData() {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        if (!tournamentDoc.exists) throw new Error('Torneio n√£o encontrado');
        
        tournamentData = tournamentDoc.data();
        tournamentData.id = tournamentId;
        
        document.getElementById('tournamentName').textContent = tournamentData.name;
        updatePlayerCount();
        updateBlindDisplay();
        
    } catch (error) {
        alert('Erro ao carregar torneio');
    }
}

function updatePlayerCount() {
    const count = tournamentData.players?.length || 1;
    const max = tournamentData.maxPlayers || 6;
    document.getElementById('playersCount').textContent = `${count}/${max}`;
}

function updateBlindDisplay() {
    if (!pokerGame) return;
    
    const blinds = pokerGame.getCurrentBlinds ? pokerGame.getCurrentBlinds() : {smallBlind: 50, bigBlind: 100};
    document.getElementById('blinds').textContent = `${blinds.smallBlind}/${blinds.bigBlind}`;
}

function isUserInTournament() {
    if (!tournamentData.players) return false;
    return tournamentData.players.some(p => p.userId === currentUser.uid);
}

function initializeInterface() {
    // Reset all positions
    for (let i = 1; i <= 6; i++) {
        document.getElementById(`avatar${i}`).innerHTML = '?';
        document.getElementById(`chips${i}`).innerHTML = '-<br>0';
        document.getElementById(`blind${i}`).style.display = 'none';
        document.getElementById(`dealer${i}`).style.display = 'none';
        const playerCards = document.getElementById(`playerPos${i}`)?.querySelector('.player-cards');
        if (playerCards) playerCards.style.display = 'none';
    }
    
    const players = tournamentData.players || [];
    
    // APENAS JOGADORES INSCRITOS APARECEM
    players.forEach((player, index) => {
        if (index < 6) {
            const pos = positionMap[index];
            const avatarElement = document.getElementById(`avatar${pos}`);
            const chipsElement = document.getElementById(`chips${pos}`);
            const container = document.getElementById(`playerPos${pos}`);
            
            const isMe = player.userId === currentUser.uid;
            if (isMe) {
                myPlayerPosition = index;
                container.classList.add('player-you');
            }
            
            if (player.avatarUrl) {
                avatarElement.innerHTML = `<img src="${player.avatarUrl}" alt="${player.nickname}">`;
            } else {
                const initial = (player.nickname || '?').charAt(0).toUpperCase();
                avatarElement.textContent = initial;
            }
            
            const chips = player.chips || tournamentData.startingStack || 1500;
            chipsElement.innerHTML = `${player.nickname || 'Jogador'}<br>${chips}`;
        }
    });
}

function setupRealtimeListener() {
    realtimeListener = db.collection('tournaments').doc(tournamentId)
        .onSnapshot((doc) => {
            if (doc.exists) {
                const newData = doc.data();
                tournamentData = newData;
                updateInterface();
                updateBlindDisplay();
                
                if (newData.currentPlayerTurn) {
                    checkMyTurn();
                }
                
                if (newData.currentRound && newData.currentRound !== actionPhase) {
                    actionPhase = newData.currentRound;
                    handlePhaseChange();
                }
                
                if (newData.dealerPosition !== undefined) {
                    dealerPosition = newData.dealerPosition;
                    updateDealerButton();
                }
            }
        });
}

// =============================================
// 2. EVENT LISTENERS
// =============================================
function setupEventListeners() {
    // Bot√µes de a√ß√£o
    document.getElementById('btnFold').addEventListener('click', () => playerAction('fold'));
    document.getElementById('btnCheck').addEventListener('click', () => playerAction('check'));
    document.getElementById('btnCall').addEventListener('click', () => playerAction('call'));
    document.getElementById('btnRaise').addEventListener('click', showRaiseControls);
    document.getElementById('btnAllIn').addEventListener('click', () => playerAction('allin'));
    
    // Controles de aposta
    document.getElementById('betSlider').addEventListener('input', updateBetAmount);
    document.getElementById('btnConfirmRaise').addEventListener('click', confirmRaise);
    document.getElementById('btnCancelRaise').addEventListener('click', hideRaiseControls);
}

// =============================================
// 3. ATUALIZA√á√ÉO DA INTERFACE
// =============================================
function updateInterface() {
    if (!tournamentData) return;
    
    updatePlayerCount();
    
    const pot = tournamentData.pot || 0;
    document.getElementById('pot').textContent = `Pote: ${pot}`;
    document.getElementById('potAmount').textContent = pot;
    
    updateCommunityCards();
    updatePlayerDisplays();
    updateMyCards();
    updateBlindIndicators();
}

function updateCommunityCards() {
    if (!tournamentData) return;
    
    const communityCards = tournamentData.communityCards || [];
    const container = document.getElementById('communityCards');
    const cards = container.querySelectorAll('.card-placeholder');
    
    cards.forEach((cardEl, index) => {
        if (communityCards[index]) {
            const card = communityCards[index];
            let displayText = '?';
            let color = '#2c3e50';
            
            if (typeof card === 'string') {
                displayText = card;
                color = (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
            }
            
            cardEl.textContent = displayText;
            cardEl.style.color = color;
            cardEl.style.background = 'white';
        } else {
            cardEl.textContent = '';
            cardEl.style.background = 'rgba(255,255,255,0.1)';
        }
    });
}

function updatePlayerDisplays() {
    const players = tournamentData.players || [];
    
    players.forEach((player, index) => {
        if (index < 6) {
            const pos = positionMap[index];
            const chipsElement = document.getElementById(`chips${pos}`);
            const avatarElement = document.getElementById(`avatar${pos}`);
            
            const chips = player.chips || 1500;
            const name = player.nickname || 'Jogador';
            
            chipsElement.innerHTML = `${name}<br>${chips}`;
            
            // Update bet display
            const container = document.getElementById(`playerPos${pos}`);
            let betElement = container.querySelector('.player-bet');
            const bet = player.bet || 0;
            
            if (bet > 0) {
                if (!betElement) {
                    betElement = document.createElement('div');
                    betElement.className = 'player-bet';
                    betElement.style.position = 'absolute';
                    betElement.style.top = '-20px';
                    betElement.style.background = 'rgba(212, 175, 55, 0.9)';
                    betElement.style.color = '#000';
                    betElement.style.padding = '3px 8px';
                    betElement.style.borderRadius = '10px';
                    betElement.style.fontWeight = 'bold';
                    betElement.style.fontSize = '0.8em';
                    betElement.style.zIndex = '30';
                    container.appendChild(betElement);
                }
                betElement.textContent = `Aposta: ${bet}`;
                betElement.style.display = 'block';
            } else if (betElement) {
                betElement.style.display = 'none';
            }
            
            // Update turn indicator
            if (tournamentData.currentPlayerTurn === player.userId) {
                avatarElement.classList.add('current-turn');
            } else {
                avatarElement.classList.remove('current-turn');
            }
            
            // Update folded status
            if (player.isActive === false || player.lastAction === 'fold') {
                avatarElement.classList.add('player-folded');
            } else {
                avatarElement.classList.remove('player-folded');
            }
        }
    });
}

function updateMyCards() {
    if (!currentUser) return;
    
    const card1Element = document.getElementById('playerCard1');
    const card2Element = document.getElementById('playerCard2');
    const myCardsContainer = document.querySelector('#playerPos1 .player-cards');
    
    const me = tournamentData?.players?.find(p => p.userId === currentUser.uid);
    
    if (me && me.cards && me.cards.length >= 2) {
        myCards = me.cards;
        if (card1Element && card2Element) {
            card1Element.textContent = formatCard(myCards[0]);
            card2Element.textContent = formatCard(myCards[1]);
            
            card1Element.style.color = getCardColor(myCards[0]);
            card2Element.style.color = getCardColor(myCards[1]);
            
            if (myCardsContainer) {
                myCardsContainer.style.display = 'flex';
            }
        }
    } else {
        if (myCardsContainer) {
            myCardsContainer.style.display = 'none';
        }
    }
}

function updateBlindIndicators() {
    if (!tournamentData || !tournamentData.players) return;
    
    // Reset all blind indicators
    for (let i = 1; i <= 6; i++) {
        document.getElementById(`blind${i}`).style.display = 'none';
        document.getElementById(`blind${i}`).textContent = '';
    }
    
    const players = tournamentData.players;
    const activePlayers = players.filter(p => p.isActive !== false && p.chips > 0);
    
    if (activePlayers.length < 2) return;
    
    // Calcular posi√ß√µes do dealer e blinds
    const dealerIndex = dealerPosition % activePlayers.length;
    const smallBlindIndex = (dealerIndex + 1) % activePlayers.length;
    const bigBlindIndex = (dealerIndex + 2) % activePlayers.length;
    
    // Atualizar indicadores
    if (activePlayers[dealerIndex]) {
        const dealerPlayer = activePlayers[dealerIndex];
        const dealerPos = positionMap[players.findIndex(p => p.userId === dealerPlayer.userId)] + 1;
        document.getElementById(`dealer${dealerPos}`).style.display = 'flex';
    }
    
    if (activePlayers[smallBlindIndex]) {
        const sbPlayer = activePlayers[smallBlindIndex];
        const sbPos = positionMap[players.findIndex(p => p.userId === sbPlayer.userId)] + 1;
        document.getElementById(`blind${sbPos}`).textContent = 'SB';
        document.getElementById(`blind${sbPos}`).style.display = 'flex';
    }
    
    if (activePlayers[bigBlindIndex]) {
        const bbPlayer = activePlayers[bigBlindIndex];
        const bbPos = positionMap[players.findIndex(p => p.userId === bbPlayer.userId)] + 1;
        document.getElementById(`blind${bbPos}`).textContent = 'BB';
        document.getElementById(`blind${bbPos}`).style.display = 'flex';
    }
}

function updateDealerButton() {
    // J√° √© tratado em updateBlindIndicators
}

function handlePhaseChange() {
    if (actionPhase === 'flop') {
        showNotification('üÉè FLOP virado!', 'info');
    } else if (actionPhase === 'turn') {
        showNotification('üÉè TURN virado!', 'info');
    } else if (actionPhase === 'river') {
        showNotification('üÉè RIVER virado!', 'info');
    } else if (actionPhase === 'showdown') {
        showNotification('üèÜ SHOWDOWN!', 'info');
    }
}

// =============================================
// 4. CONTROLE DE TURNO - FLUXO COMPLETO
// =============================================
function checkMyTurn() {
    if (!tournamentData || !tournamentData.currentPlayerTurn) {
        disablePlayerControls();
        stopActionTimer();
        return;
    }
    
    const isMyTurn = tournamentData.currentPlayerTurn === currentUser.uid;
    
    if (isMyTurn) {
        enablePlayerControls();
        startActionTimer();
        showNotification('‚úÖ SUA VEZ!', 'turn');
    } else {
        disablePlayerControls();
        stopActionTimer();
    }
}

function checkIfGameCanStart() {
    const playersCount = tournamentData?.players?.length || 0;
    
    if (playersCount >= 2 && !gameStarted) {
        showNotification('üéÆ Iniciando jogo...', 'info');
        
        setTimeout(async () => {
            await initializePokerEngine();
        }, 2000);
    } else if (playersCount < 2) {
        showNotification('‚è≥ Aguardando mais jogadores...', 'info');
    }
}

async function initializePokerEngine() {
    if (gameStarted) return;
    
    const players = tournamentData.players || [];
    
    if (players.length < 2) return;
    
    if (!window.PokerEngine || !window.PokerEngine.PokerGameEngine) {
        showNotification('Erro: Poker Engine n√£o encontrado', 'error');
        return;
    }
    
    try {
        const enginePlayers = players.map((player, index) => ({
            userId: player.userId,
            nickname: player.nickname || `Jogador ${index + 1}`,
            chips: player.chips || 1500,
            position: index,
            isActive: true
        }));
        
        pokerGame = new window.PokerEngine.PokerGameEngine(tournamentId);
        pokerGame.initialize(enginePlayers);
        
        gameStarted = true;
        
        showNotification('üéÆ Jogo iniciado!', 'success');
        
        await startNewHand();
        
    } catch (error) {
        showNotification('Erro ao iniciar jogo', 'error');
    }
}

async function startNewHand() {
    if (!pokerGame || !gameStarted) return;
    
    try {
        showNotification('üÉè Nova m√£o iniciada!', 'info');
        
        actionPhase = 'preflop';
        
        const handResult = pokerGame.startHand();
        const gameInfo = pokerGame.getGameInfo();
        
        // Get my cards
        const myPlayerInfo = pokerGame.getPlayerInfo(currentUser.uid);
        if (myPlayerInfo && myPlayerInfo.cards) {
            myCards = myPlayerInfo.cards;
        }
        
        // Update Firestore with new hand
        await db.collection('tournaments').doc(tournamentId).update({
            players: gameInfo.players,
            communityCards: gameInfo.communityCards,
            pot: gameInfo.pot,
            currentRound: 'preflop',
            currentPlayerTurn: gameInfo.currentPlayerTurn || '',
            dealerPosition: gameInfo.dealerPosition || 0,
            currentMaxBet: 0,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        updateInterface();
        
        // Start betting round after 2 seconds
        setTimeout(() => {
            startBettingRound();
        }, 2000);
        
    } catch (error) {
        showNotification('Erro ao iniciar m√£o', 'error');
    }
}

function startBettingRound() {
    if (!pokerGame || !tournamentData) return;
    
    const gameInfo = pokerGame.getGameInfo();
    const nextPlayer = gameInfo.currentPlayerTurn;
    
    if (nextPlayer) {
        updateCurrentTurn(nextPlayer);
    } else {
        // Find first active player
        const activePlayers = tournamentData.players?.filter(p => 
            p.isActive !== false && p.lastAction !== 'fold' && p.chips > 0
        ) || [];
        
        if (activePlayers.length > 0) {
            updateCurrentTurn(activePlayers[0].userId);
        }
    }
}

async function updateCurrentTurn(playerId) {
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            currentPlayerTurn: playerId,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Erro ao atualizar turno:', error);
    }
}

// =============================================
// 5. A√á√ïES DO JOGADOR - FLUXO EM TEMPO REAL
// =============================================
async function playerAction(action) {
    if (!isMyTurn()) {
        showNotification('N√£o √© sua vez!', 'error');
        return;
    }
    
    if (isActionProcessing) {
        showNotification('A√ß√£o em processamento...', 'info');
        return;
    }
    
    try {
        isActionProcessing = true;
        let amount = 0;
        
        // Verificar regras b√°sicas do poker
        const me = tournamentData.players?.find(p => p.userId === currentUser.uid);
        if (!me) {
            showNotification('Erro: Jogador n√£o encontrado', 'error');
            isActionProcessing = false;
            return;
        }
        
        const myBet = me.bet || 0;
        const maxBet = tournamentData.currentMaxBet || 0;
        const myChips = me.chips || 0;
        
        // Validar a√ß√µes conforme regras do poker
        switch (action.toLowerCase()) {
            case 'check':
                if (myBet < maxBet) {
                    showNotification('N√£o pode dar check - h√° aposta para igualar!', 'error');
                    isActionProcessing = false;
                    return;
                }
                showNotification('‚úÖ Check - Vez passada!', 'success');
                break;
                
            case 'call':
                if (myBet >= maxBet) {
                    showNotification('N√£o pode dar call - j√° igualou a aposta!', 'error');
                    isActionProcessing = false;
                    return;
                }
                const callAmount = maxBet - myBet;
                if (callAmount > myChips) {
                    // All-in automaticamente
                    action = 'allin';
                    showNotification('üí∞ All-in autom√°tico!', 'info');
                } else {
                    showNotification(`üí∞ Call ${callAmount} - Vez passada!`, 'success');
                }
                break;
                
            case 'raise':
                amount = parseInt(document.getElementById('betAmount').textContent);
                if (amount <= 0) {
                    showNotification('Escolha um valor para raise', 'error');
                    isActionProcessing = false;
                    return;
                }
                if (amount <= maxBet - myBet) {
                    showNotification('Raise deve ser maior que a aposta atual!', 'error');
                    isActionProcessing = false;
                    return;
                }
                if (amount > myChips) {
                    showNotification('Fichas insuficientes!', 'error');
                    isActionProcessing = false;
                    return;
                }
                showNotification(`üí∞ Raise ${amount} - Vez passada!`, 'success');
                break;
                
            case 'fold':
                showNotification('üóëÔ∏è Fold - Vez passada!', 'info');
                break;
                
            case 'allin':
                showNotification('üí∞ All-in - Vez passada!', 'info');
                break;
        }
        
        // Processar a√ß√£o no poker engine
        if (pokerGame) {
            const result = pokerGame.playerAction(currentUser.uid, action, amount);
            
            if (result.success) {
                // Atualizar Firestore com novo estado
                const gameState = pokerGame.getGameInfo();
                
                await db.collection('tournaments').doc(tournamentId).update({
                    players: gameState.players,
                    pot: gameState.pot,
                    currentMaxBet: gameState.currentMaxBet || 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideRaiseControls();
                
                // Verificar se deve encerrar rodada (s√≥ restou 1 jogador ativo)
                const activePlayers = gameState.players?.filter(p => 
                    p.isActive !== false && p.lastAction !== 'fold' && p.chips > 0
                ) || [];
                
                if (activePlayers.length <= 1) {
                    // Encerrar rodada imediatamente
                    showNotification('üèÜ Rodada encerrada - vencedor √∫nico!', 'success');
                    setTimeout(async () => {
                        await endRoundEarly();
                    }, 1500);
                } else if (result.bettingRoundComplete) {
                    await advanceToNextPhase();
                } else {
                    await moveToNextPlayer();
                }
            } else {
                showNotification('Erro: ' + result.error, 'error');
            }
        }
        
    } catch (error) {
        showNotification('Erro na a√ß√£o: ' + error.message, 'error');
    } finally {
        isActionProcessing = false;
    }
}

async function endRoundEarly() {
    if (!pokerGame) return;
    
    try {
        // For√ßar showdown com vencedor √∫nico
        const winners = pokerGame.dealer.determineWinners();
        
        if (winners.length > 0) {
            // Distribuir pr√™mios
            pokerGame.distributePrizes(winners);
            
            // Atualizar Firestore
            const gameState = pokerGame.getGameInfo();
            await db.collection('tournaments').doc(tournamentId).update({
                players: gameState.players,
                currentRound: 'showdown',
                currentPlayerTurn: '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification(`${winners[0].player.nickname} ganhou ${winners[0].prize} fichas!`, 'success');
            
            // Preparar nova m√£o
            setTimeout(async () => {
                await resetForNewHand();
            }, 3000);
        }
        
    } catch (error) {
        console.error('Erro ao encerrar rodada:', error);
    }
}

async function moveToNextPlayer() {
    if (!pokerGame) return;
    
    const gameInfo = pokerGame.getGameInfo();
    const nextPlayer = gameInfo.nextPlayer;
    
    if (nextPlayer) {
        await updateCurrentTurn(nextPlayer.userId);
    } else {
        // Check if round is complete
        if (gameInfo.bettingRoundComplete) {
            await advanceToNextPhase();
        }
    }
}

async function advanceToNextPhase() {
    if (!pokerGame) return;
    
    try {
        const result = pokerGame.advanceRound();
        
        if (result.round === 'showdown') {
            actionPhase = 'showdown';
            
            showNotification('üèÜ SHOWDOWN!', 'info');
            
            // Distribute prizes
            if (result.winners && result.winners.length > 0) {
                result.winners.forEach(winner => {
                    showNotification(`${winner.player.nickname} ganhou ${winner.prize} fichas!`, 'success');
                });
            }
            
            // Update Firestore with final state
            const gameState = pokerGame.getGameInfo();
            await db.collection('tournaments').doc(tournamentId).update({
                players: gameState.players,
                communityCards: gameState.communityCards,
                currentRound: 'showdown',
                currentPlayerTurn: '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Reset for new hand after 5 seconds
            setTimeout(() => {
                resetForNewHand();
            }, 5000);
            
        } else {
            // Update community cards and round
            const gameState = pokerGame.getGameInfo();
            
            await db.collection('tournaments').doc(tournamentId).update({
                communityCards: gameState.communityCards,
                currentRound: gameState.round,
                players: gameState.players.map(p => ({
                    ...p,
                    lastAction: null,
                    bet: 0
                })),
                currentMaxBet: 0,
                currentPlayerTurn: '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            actionPhase = gameState.round;
            
            // Start next betting round after 2 seconds
            setTimeout(() => {
                startBettingRound();
            }, 2000);
        }
        
    } catch (error) {
        console.error('Erro ao avan√ßar fase:', error);
    }
}

async function resetForNewHand() {
    if (pokerGame) {
        const gameState = pokerGame.getGameInfo();
        
        await db.collection('tournaments').doc(tournamentId).update({
            communityCards: [],
            currentRound: 'preflop',
            currentPlayerTurn: '',
            currentMaxBet: 0,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Start new hand after 3 seconds
        setTimeout(async () => {
            await startNewHand();
        }, 3000);
    }
}

// =============================================
// 6. CONTROLES DE APOSTA
// =============================================
function showRaiseControls() {
    if (!isMyTurn()) return;
    
    const me = tournamentData?.players?.find(p => p.userId === currentUser.uid);
    if (!me) return;
    
    const maxBet = me.chips || 0;
    const minBet = Math.max(100, (tournamentData.currentMaxBet || 0) * 2);
    
    const slider = document.getElementById('betSlider');
    if (slider) {
        slider.min = minBet;
        slider.max = maxBet;
        slider.value = minBet;
    }
    
    document.getElementById('raiseControls').style.display = 'flex';
    document.getElementById('actionButtons').style.display = 'none';
    
    updateBetAmount();
}

function hideRaiseControls() {
    document.getElementById('raiseControls').style.display = 'none';
    document.getElementById('actionButtons').style.display = 'flex';
}

function updateBetAmount() {
    const slider = document.getElementById('betSlider');
    const amount = parseInt(slider.value);
    document.getElementById('betAmount').textContent = amount;
}

function confirmRaise() {
    playerAction('raise');
}

function isMyTurn() {
    if (!tournamentData || !tournamentData.currentPlayerTurn) return false;
    return tournamentData.currentPlayerTurn === currentUser.uid;
}

function enablePlayerControls() {
    const buttons = document.querySelectorAll('.action-btn');
    buttons.forEach(btn => {
        btn.disabled = false;
    });
    
    document.getElementById('actionTimerContainer').style.display = 'block';
    updateActionButtons();
}

function updateActionButtons() {
    const me = tournamentData.players?.find(p => p.userId === currentUser.uid);
    if (!me) return;
    
    const myBet = me.bet || 0;
    const maxBet = tournamentData.currentMaxBet || 0;
    const myChips = me.chips || 0;
    const canCheck = myBet >= maxBet;
    const canCall = myBet < maxBet && myChips > 0;
    const canRaise = maxBet > 0 && myChips > (maxBet - myBet);
    
    const checkBtn = document.getElementById('btnCheck');
    const callBtn = document.getElementById('btnCall');
    const raiseBtn = document.getElementById('btnRaise');
    
    if (checkBtn && callBtn && raiseBtn) {
        checkBtn.style.display = canCheck ? 'block' : 'none';
        callBtn.style.display = canCall ? 'block' : 'none';
        raiseBtn.style.display = canRaise ? 'block' : 'none';
        
        const callAmount = Math.max(0, maxBet - myBet);
        callBtn.textContent = callAmount > 0 ? `Call ${callAmount}` : 'Call';
    }
}

function disablePlayerControls() {
    const buttons = document.querySelectorAll('.action-btn');
    buttons.forEach(btn => {
        btn.disabled = true;
    });
    
    document.getElementById('actionTimerContainer').style.display = 'none';
}

// =============================================
// 7. TIMER DE A√á√ÉO
// =============================================
function startActionTimer() {
    timeLeft = 30;
    const timerBar = document.getElementById('actionTimerBar');
    timerBar.style.width = '100%';
    timerBar.style.background = '#2ecc71';
    
    stopActionTimer();
    
    actionTimerInterval = setInterval(() => {
        timeLeft--;
        const percentage = (timeLeft / 30) * 100;
        timerBar.style.width = percentage + '%';
        
        if (timeLeft <= 10) {
            timerBar.style.background = '#e74c3c';
        } else if (timeLeft <= 20) {
            timerBar.style.background = '#e67e22';
        }
        
        if (timeLeft <= 0) {
            playerAction('fold');
            stopActionTimer();
        }
    }, 1000);
}

function stopActionTimer() {
    if (actionTimerInterval) {
        clearInterval(actionTimerInterval);
        actionTimerInterval = null;
    }
}

// =============================================
// 8. FUN√á√ïES AUXILIARES
// =============================================
function formatCard(card) {
    if (!card) return '?';
    
    if (typeof card === 'string') {
        return card;
    }
    
    return '?';
}

function getCardColor(card) {
    if (typeof card === 'string') {
        return (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
    }
    
    return '#2c3e50';
}

function showNotification(message, type = 'info') {
    const messageEl = document.getElementById('statusMessage');
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    if (type === 'error') {
        messageEl.style.background = 'rgba(231, 76, 60, 0.9)';
    } else if (type === 'success') {
        messageEl.style.background = 'rgba(46, 204, 113, 0.9)';
    } else if (type === 'turn') {
        messageEl.style.background = 'rgba(52, 152, 219, 0.9)';
    } else {
        messageEl.style.background = 'rgba(0,0,0,0.8)';
    }
    
    if (type !== 'turn') {
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 3000);
    }
}

// =============================================
// 9. LIMPEZA E GERENCIAMENTO
// =============================================
window.addEventListener('beforeunload', () => {
    if (realtimeListener) realtimeListener();
    stopActionTimer();
});

console.log('üéÆ Sistema de Torneio de Poker - 6 Posi√ß√µes + Fluxo Completo carregado!');
</script>
</body>
</html>