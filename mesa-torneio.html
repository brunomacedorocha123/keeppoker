<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Mesa de Torneio | KeepPoker</title>
 
 <!-- Firebase -->
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
 
 <script>
   // Firebase Configuration
   const firebaseConfig = {
     apiKey: "AIzaSyBIBucZSzN671VgJQHGIiepHNUqxbqNKAQ",
     authDomain: "keeppoker-b4173.firebaseapp.com",
     projectId: "keeppoker-b4173",
     storageBucket: "keeppoker-b4173.firebasestorage.app",
     messagingSenderId: "436464592434",
     appId: "1:436464592434:web:c5a1e0c10e10acbc14fe2b"
   };
   
   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();
 </script>
 
 <!-- Poker Engine (ARQUIVO SEPARADO) -->
 <script src="poker-engine.js"></script>
 
 <style>
/* ===== RESET ===== */
* {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
}

/* ===== BASE ===== */
body {
 background: #0a1520;
 color: white;
 font-family: 'Segoe UI', sans-serif;
 height: 100vh;
 overflow: hidden;
}

/* ===== CABE√áALHO ===== */
.header {
 height: 60px;
 background: rgba(13, 27, 42, 0.9);
 border-bottom: 2px solid #d4af37;
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: 0 20px;
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 z-index: 100;
}

.tournament-info {
 font-size: 1.1em;
 color: #d4af37;
 font-weight: bold;
}

.game-stats {
 display: flex;
 gap: 20px;
}

.stat {
 background: rgba(212, 175, 55, 0.15);
 padding: 6px 12px;
 border-radius: 12px;
 border: 1px solid rgba(212, 175, 55, 0.3);
 font-weight: bold;
}

/* ===== MESA ===== */
.table-container {
 position: absolute;
 top: 45%;
 left: 50%;
 transform: translate(-50%, -50%);
 width: 70%;
 height: 55%;
 z-index: 1;
}

/* MESA FORMATO SALSICHA */
.poker-table {
 width: 100%;
 height: 100%;
 background: #0a5c36;
 border: 15px solid #8B4513;
 border-radius: 50% / 40%; /* Formato salsicha */
 box-shadow:
  inset 0 0 40px rgba(0, 0, 0, 0.6),
  0 0 30px rgba(0, 0, 0, 0.7);
 position: relative;
}

/* √ÅREA CENTRAL DA MESA */
.table-center {
 position: absolute;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 width: 40%;
 height: 40%;
 display: flex;
 flex-direction: column;
 align-items: center;
 justify-content: center;
 gap: 15px;
}

/* CARTAS COMUNIT√ÅRIAS */
.community-cards {
 display: flex;
 gap: 8px;
}

.card-placeholder {
 width: 50px;
 height: 70px;
 background: white;
 border-radius: 5px;
 border: 2px solid #333;
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: bold;
 font-size: 1.2em;
 box-shadow: 0 2px 5px rgba(0,0,0,0.3);
 color: #2c3e50;
}

/* POT */
.pot {
 color: #d4af37;
 font-size: 1.4em;
 font-weight: bold;
}

/* ===== AVATARS ===== */
.avatar-container {
 position: absolute;
 display: flex;
 flex-direction: column;
 align-items: center;
 z-index: 20; /* ‚¨ÖÔ∏è MAIOR que controls */
}

/* AVATAR CIRCULAR */
.avatar {
 width: 70px;
 height: 70px;
 border-radius: 50%;
 background: linear-gradient(135deg, #415a77, #1b263b);
 border: 3px solid #d4af37;
 display: flex;
 align-items: center;
 justify-content: center;
 color: white;
 font-size: 1.4em;
 margin-bottom: 5px;
 box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
 position: relative;
 overflow: hidden;
}

.avatar img {
 width: 100%;
 height: 100%;
 object-fit: cover;
 border-radius: 50%;
}

/* CARTAS DO JOGADOR (AO LADO DO AVATAR - S√ì POSI√á√ÉO 1) */
.player-cards {
 position: absolute;
 left: 85px; /* Ao lado direito do avatar */
 top: 50%;
 transform: translateY(-50%);
 display: flex;
 gap: 5px;
 z-index: 25; /* ‚¨ÖÔ∏è MAIOR que avatar */
}

.player-card {
 width: 40px;
 height: 56px;
 background: white;
 border-radius: 4px;
 border: 2px solid #000;
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: bold;
 font-size: 1em;
 color: #000;
 box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* CHIPS DO JOGADOR */
.player-chips {
 background: rgba(0, 0, 0, 0.7);
 color: #ffd700;
 padding: 4px 8px;
 border-radius: 10px;
 font-size: 0.9em;
 font-weight: bold;
 margin-top: 5px;
 min-width: 80px;
 text-align: center;
}

/* JOGADOR ATUAL (vez) */
.current-turn .avatar {
 border-color: #00ff00;
 box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
}

/* APOSTA DO JOGADOR */
.player-bet {
 position: absolute;
 top: -15px;
 background: rgba(212, 175, 55, 0.9);
 color: #000;
 padding: 3px 8px;
 border-radius: 10px;
 font-weight: bold;
 font-size: 0.8em;
 white-space: nowrap;
}

/* FOLDED/INATIVO */
.player-folded .avatar {
 opacity: 0.5;
 border-color: #666;
}

/* INFO DO JOGADOR (S√ì APARECE PARA VOC√ä) */
.player-info {
 background: rgba(13, 27, 42, 0.95);
 padding: 8px 12px;
 border-radius: 8px;
 border: 1px solid rgba(212, 175, 55, 0.3);
 text-align: center;
 min-width: 100px;
 font-size: 0.9em;
 display: none;
}

/* ===== POSICIONAMENTO DOS AVATARS ===== */

/* POSI√á√ÉO 1: TOPO CENTRO (VOC√ä) */
.pos-1 {
 top: -16.5%; /* MAIS PRA CIMA */
 left: 50%;
 transform: translateX(-50%);
}

/* POSI√á√ÉO 2: DIREITA SUPERIOR - FORA DA MESA */
.pos-2 {
 top: 16.5%; /* MAIS PRA CIMA */
 right: 3%; /* MAIS PRA DIREITA (fora da mesa) */
}

/* POSI√á√ÉO 3: DIREITA INFERIOR - FORA DA MESA */
.pos-3 {
 bottom: 16.5%; /* MAIS PRA BAIXO */
 right: 3%; /* MAIS PRA DIREITA (fora da mesa) */
}

/* POSI√á√ÉO 4: BAIXO CENTRO - TOTALMENTE VIS√çVEL */
.pos-4 {
 bottom: -16.5%; /* MAIS PRA BAIXO */
 left: 50%;
 transform: translateX(-50%);
}

/* POSI√á√ÉO 5: ESQUERDA INFERIOR - FORA DA MESA */
.pos-5 {
 bottom: 16.5%; /* MAIS PRA BAIXO */
 left: 3%; /* MAIS PRA ESQUERDA (fora da mesa) */
}

/* POSI√á√ÉO 6: ESQUERDA SUPERIOR - FORA DA MESA */
.pos-6 {
 top: 16.5%; /* MAIS PRA CIMA */
 left: 3%; /* MAIS PRA ESQUERDA (fora da mesa) */
}

/* AVATAR DO JOGADOR (VOC√ä) */
.player-you .avatar {
 border-color: #3498db;
 box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
}

.player-you .player-info {
 display: block;
}

/* ===== CONTROLES ===== */
.controls {
 position: fixed;
 bottom: 2%; /* L√Å EM BAIXO DA TELA */
 left: 50%;
 transform: translateX(-50%);
 background: rgba(13, 27, 42, 0.95);
 padding: 8px 12px; /* ALTURA REDUZIDA */
 border-radius: 12px;
 border: 2px solid #d4af37;
 display: flex;
 flex-direction: column;
 align-items: center;
 gap: 8px; /* GAP REDUZIDO */
 z-index: 10; /* ‚¨ÖÔ∏è MENOR que avatares (20) */
 min-width: 400px;
 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
 max-height: 120px; /* ALTURA M√ÅXIMA REDUZIDA */
}

/* BOT√ïES DE A√á√ÉO - SEM CARTAS DENTRO */
.action-buttons {
 display: flex;
 gap: 8px;
}

.action-btn {
 padding: 10px 18px;
 border: none;
 border-radius: 8px;
 font-weight: bold;
 cursor: pointer;
 min-width: 80px;
 font-size: 0.9em;
 transition: all 0.3s;
}

.btn-fold { background: #e74c3c; color: white; }
.btn-check { background: #3498db; color: white; }
.btn-call { background: #2ecc71; color: white; }
.btn-raise { background: #9b59b6; color: white; }
.btn-allin { background: #e67e22; color: white; }

.action-btn:hover {
 transform: translateY(-2px);
 box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.action-btn:disabled {
 opacity: 0.5;
 cursor: not-allowed;
 transform: none;
}

/* CONTROLE DE APOSTA */
.bet-controls {
 display: flex;
 gap: 10px;
 align-items: center;
 margin-top: 5px; /* REDUZIDO */
 display: none;
}

.bet-slider {
 flex: 1;
 height: 6px; /* REDUZIDO */
 background: rgba(255,255,255,0.1);
 border-radius: 3px;
 outline: none;
}

.bet-amount {
 background: rgba(212, 175, 55, 0.2);
 padding: 5px 10px; /* REDUZIDO */
 border-radius: 8px;
 font-weight: bold;
 color: #ffd700;
 min-width: 60px; /* REDUZIDO */
 text-align: center;
 font-size: 0.85em;
}

/* TIMER DE A√á√ÉO */
.action-timer {
 width: 100%;
 height: 4px; /* REDUZIDO */
 background: rgba(255,255,255,0.1);
 border-radius: 2px;
 margin-top: 5px; /* REDUZIDO */
 overflow: hidden;
 display: none;
}

.timer-bar {
 height: 100%;
 background: linear-gradient(90deg, #2ecc71, #e67e22, #e74c3c);
 width: 100%;
 transition: width 1s linear;
}

/* MENSAGEM DE STATUS */
.status-message {
 position: fixed;
 top: 70px;
 left: 50%;
 transform: translateX(-50%);
 background: rgba(0,0,0,0.8);
 padding: 10px 20px;
 border-radius: 20px;
 border: 1px solid #d4af37;
 z-index: 1000;
 font-weight: bold;
 display: none;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 768px) {
 .table-container {
  width: 85%;
  height: 50%;
  top: 44%;
 }

 .avatar {
  width: 50px;
  height: 50px;
  font-size: 1.2em;
 }

 .player-cards {
  left: 60px;
 }

 .player-card {
  width: 30px;
  height: 42px;
  font-size: 0.9em;
 }

 /* POSI√á√ïES MOBILE */
 .pos-1 { top: -18%; }
 .pos-2 { top: 14%; right: 2%; }
 .pos-6 { top: 14%; left: 2%; }
 .pos-3 { bottom: 14%; right: 2%; }
 .pos-5 { bottom: 14%; left: 2%; }
 .pos-4 { bottom: -18%; }

 .controls {
  min-width: 90%;
  padding: 6px 10px;
  bottom: 1%;
  max-height: 110px;
 }

 .action-btn {
  padding: 8px 12px;
  min-width: 70px;
  font-size: 0.85em;
 }

 .bet-amount {
  padding: 4px 8px;
  min-width: 50px;
  font-size: 0.8em;
 }
}

@media (max-width: 480px) {
 .header {
  padding: 0 10px;
 }

 .game-stats {
  gap: 10px;
 }

 .stat {
  padding: 4px 8px;
  font-size: 0.9em;
 }

 .avatar {
  width: 40px;
  height: 40px;
  font-size: 1em;
 }

 .player-cards {
  left: 50px;
 }

 .player-card {
  width: 25px;
  height: 35px;
  font-size: 0.8em;
 }

 .table-container {
  top: 43%;
 }

 /* POSI√á√ïES MOBILE PEQUENO */
 .pos-1 { top: -20%; }
 .pos-2 { top: 12%; right: 1.5%; }
 .pos-6 { top: 12%; left: 1.5%; }
 .pos-3 { bottom: 12%; right: 1.5%; }
 .pos-5 { bottom: 12%; left: 1.5%; }
 .pos-4 { bottom: -20%; }

 .controls {
  bottom: 0.5%;
  padding: 5px 8px;
  max-height: 100px;
 }

 .action-btn {
  padding: 6px 10px;
  min-width: 60px;
  font-size: 0.8em;
 }

 .bet-amount {
  padding: 3px 6px;
  min-width: 40px;
  font-size: 0.75em;
 }
}
</style>
</head>
<body>
 <!-- CABE√áALHO -->
 <div class="header">
  <div class="tournament-info" id="tournamentName">Torneio</div>
  <div class="game-stats">
   <div class="stat" id="blinds">100/200</div>
   <div class="stat" id="pot">Pote: 0</div>
   <div class="stat" id="playersCount">1/6</div>
  </div>
 </div>

 <!-- MENSAGEM DE STATUS -->
 <div class="status-message" id="statusMessage"></div>

 <!-- CONTAINER DA MESA -->
 <div class="table-container">
  <!-- MESA -->
  <div class="poker-table">
   <!-- √ÅREA CENTRAL -->
   <div class="table-center">
    <div class="community-cards" id="communityCards">
     <div class="card-placeholder"></div>
     <div class="card-placeholder"></div>
     <div class="card-placeholder"></div>
     <div class="card-placeholder"></div>
     <div class="card-placeholder"></div>
    </div>
    <div class="pot" id="potAmount">0</div>
   </div>
  </div>
  
  <!-- OS 6 AVATARS NAS POSI√á√ïES CORRETAS -->
<div class="avatar-container pos-1" id="playerPos1">
  <div class="avatar" id="avatar1">?</div>
  
  <!-- CARTAS AO LADO DO SEU AVATAR (POSI√á√ÉO 1) -->
  <div class="player-cards">
    <div class="player-card" id="playerCard1">?</div>
    <div class="player-card" id="playerCard2">?</div>
  </div>
  
  <div class="player-chips" id="chips1">-<br>0</div>
</div>

<div class="avatar-container pos-2" id="playerPos2">
  <div class="avatar" id="avatar2">?</div>
  <div class="player-chips" id="chips2">-<br>0</div>
</div>

<div class="avatar-container pos-6" id="playerPos6">
  <div class="avatar" id="avatar6">?</div>
  <div class="player-chips" id="chips6">-<br>0</div>
</div>

<div class="avatar-container pos-3" id="playerPos3">
  <div class="avatar" id="avatar3">?</div>
  <div class="player-chips" id="chips3">-<br>0</div>
</div>

<div class="avatar-container pos-5" id="playerPos5">
  <div class="avatar" id="avatar5">?</div>
  <div class="player-chips" id="chips5">-<br>0</div>
</div>

<div class="avatar-container pos-4" id="playerPos4">
  <div class="avatar" id="avatar4">?</div>
  <div class="player-chips" id="chips4">-<br>0</div>
</div>

 <!-- CONTROLES (FORA DA MESA) -->
 <div class="controls" id="playerControls">
  <!-- SUAS CARTAS -->
  <div class="your-cards">
   <div class="your-card" id="card1">?</div>
   <div class="your-card" id="card2">?</div>
  </div>
  
  <!-- BOT√ïES DE A√á√ÉO -->
  <div class="action-buttons" id="actionButtons">
   <button class="action-btn btn-fold" onclick="playerAction('fold')">Fold</button>
   <button class="action-btn btn-check" onclick="playerAction('check')">Check</button>
   <button class="action-btn btn-call" onclick="playerAction('call')">Call</button>
   <button class="action-btn btn-raise" onclick="showRaiseControls()">Raise</button>
   <button class="action-btn btn-allin" onclick="playerAction('allin')">All-in</button>
  </div>
  
  <!-- CONTROLE DE APOSTA -->
  <div class="bet-controls" id="raiseControls">
   <input type="range" min="0" max="100" value="0" class="bet-slider" id="betSlider" oninput="updateBetAmount()">
   <div class="bet-amount" id="betAmount">0</div>
   <button class="action-btn btn-raise" onclick="confirmRaise()">Confirmar</button>
   <button class="action-btn btn-fold" onclick="hideRaiseControls()">Cancelar</button>
  </div>
  
  <!-- TIMER DE A√á√ÉO -->
  <div class="action-timer" id="actionTimerContainer">
   <div class="timer-bar" id="actionTimerBar"></div>
  </div>
 </div>

 <!-- SCRIPT PRINCIPAL -->
 <script>
  // =============================================
  // VARI√ÅVEIS GLOBAIS
  // =============================================
  let tournamentId = null;
  let tournamentData = null;
  let currentUser = null;
  let userData = null;
  let pokerGame = null;
  let realtimeListener = null;
  let actionTimerInterval = null;
  let timeLeft = 30;
  let myPlayerPosition = -1;
  let gameStarted = false;

  // Mapeamento das posi√ß√µes na mesa (0-5)
  const positionMap = [1, 2, 6, 3, 5, 4]; // Ordem das posi√ß√µes visuais

  // =============================================
  // INICIALIZA√á√ÉO
  // =============================================
  document.addEventListener('DOMContentLoaded', function() {
   console.log('üéÆ Mesa de torneio carregada');
   
   // 1. Obter ID do torneio da URL
   const urlParams = new URLSearchParams(window.location.search);
   tournamentId = urlParams.get('tournamentId');
   
   if (!tournamentId) {
    alert('Torneio n√£o especificado! Redirecionando...');
    window.location.href = 'torneios.html';
    return;
   }
   
   console.log(`üéØ Torneio ID: ${tournamentId}`);
   
   // 2. Verificar autentica√ß√£o
   auth.onAuthStateChanged(async (user) => {
    if (!user) {
     console.log('üë§ Usu√°rio n√£o autenticado');
     window.location.href = 'login.html';
     return;
    }
    
    currentUser = user;
    console.log(`‚úÖ Usu√°rio autenticado: ${user.uid}`);
    
    // 3. Carregar dados do usu√°rio
    await loadUserData();
    
    // 4. Carregar dados do torneio
    await loadTournamentData();
    
    // 5. Verificar se usu√°rio est√° no torneio
    if (!isUserInTournament()) {
     showNotification('‚ùå Voc√™ n√£o est√° inscrito neste torneio', 'error');
     setTimeout(() => {
      window.location.href = 'torneios.html';
     }, 3000);
     return;
    }
    
    // 6. Inicializar interface com dados REAIS
    initializeInterface();
    
    // 7. Configurar listener em tempo real
    setupRealtimeListener();
    
    // 8. Verificar se pode iniciar jogo
    checkIfGameCanStart();
   });
   
   // Configurar controles
   setupControls();
  });

  // =============================================
  // FUN√á√ïES PRINCIPAIS
  // =============================================
  
  // 1. Carregar dados do usu√°rio
  async function loadUserData() {
   try {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (userDoc.exists) {
     userData = userDoc.data();
     console.log('üìä Usu√°rio:', userData.nickname || userData.nome);
    }
   } catch (error) {
    console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
   }
  }
  
  // 2. Carregar dados do torneio
  async function loadTournamentData() {
   try {
    const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
    if (!tournamentDoc.exists) {
     throw new Error('Torneio n√£o encontrado');
    }
    
    tournamentData = tournamentDoc.data();
    tournamentData.id = tournamentId;
    
    console.log('üé≤ Torneio:', tournamentData.name);
    console.log('üë• Jogadores:', tournamentData.players?.length || 0);
    
    // Atualizar header
    document.getElementById('tournamentName').textContent = tournamentData.name;
    document.getElementById('playersCount').textContent = 
     `${tournamentData.players?.length || 1}/${tournamentData.maxPlayers || 6}`;
     
   } catch (error) {
    console.error('‚ùå Erro ao carregar torneio:', error);
    showNotification('Erro ao carregar torneio', 'error');
   }
  }
  
  // 3. Verificar se usu√°rio est√° no torneio
  function isUserInTournament() {
   if (!tournamentData.players) return false;
   return tournamentData.players.some(p => p.userId === currentUser.uid);
  }
  
  // 4. Inicializar interface com dados REAIS
  function initializeInterface() {
   console.log('üé® Inicializando interface com dados reais...');
   
   // Limpar avatares
   for (let i = 1; i <= 6; i++) {
    document.getElementById(`avatar${i}`).innerHTML = '?';
    document.getElementById(`chips${i}`).innerHTML = '-<br>0';
    // Esconder cartas dos jogadores (s√≥ mostrarem quando tiverem cartas)
    const playerCards = document.getElementById(`playerPos${i}`)?.querySelector('.player-cards');
    if (playerCards) {
     playerCards.style.display = 'none';
    }
   }
   
   // Preencher com jogadores REAIS
   const players = tournamentData.players || [];
   
   players.forEach((player, index) => {
    if (index < 6) { // M√°ximo 6 jogadores
     const pos = positionMap[index]; // Mapear para posi√ß√£o visual
     const avatarElement = document.getElementById(`avatar${pos}`);
     const chipsElement = document.getElementById(`chips${pos}`);
     const container = document.getElementById(`playerPos${pos}`);
     
     // Verificar se √© o usu√°rio atual
     const isMe = player.userId === currentUser.uid;
     if (isMe) {
      myPlayerPosition = index;
      console.log(`üéÆ Voc√™ est√° na posi√ß√£o: ${index + 1} (visual: ${pos})`);
     }
     
     // Avatar
     if (player.avatarUrl) {
      avatarElement.innerHTML = `<img src="${player.avatarUrl}" alt="${player.nickname}">`;
     } else {
      // Primeira letra do nome
      const initial = (player.nickname || player.playerName || '?').charAt(0).toUpperCase();
      avatarElement.textContent = initial;
     }
     
     // Adicionar classe "player-you" se for o usu√°rio
     if (isMe) {
      container.classList.add('player-you');
      // Mostrar cartas do jogador (se tiver)
      const myCards = container.querySelector('.player-cards');
      if (myCards) {
       myCards.style.display = 'flex';
      }
     } else {
      container.classList.remove('player-you');
     }
     
     // Chips
     const chips = player.chips || tournamentData.startingStack || 1500;
     chipsElement.innerHTML = `${player.nickname || 'Jogador'}<br>${chips}`;
     
    } else {
     console.warn(`‚ö†Ô∏è Mais de 6 jogadores, ignorando jogador ${index + 1}`);
    }
   });
   
   // Atualizar minhas cartas (se j√° tiver)
   updateMyCards();
  }
  
  // 5. Configurar listener em tempo real
  function setupRealtimeListener() {
   console.log('üëÇ Configurando listener em tempo real...');
   
   realtimeListener = db.collection('tournaments').doc(tournamentId)
    .onSnapshot((doc) => {
     if (doc.exists) {
      const newData = doc.data();
      
      // Verificar se houve mudan√ßas importantes
      const playersChanged = JSON.stringify(newData.players) !== JSON.stringify(tournamentData?.players);
      const communityChanged = JSON.stringify(newData.communityCards) !== JSON.stringify(tournamentData?.communityCards);
      const potChanged = newData.pot !== tournamentData?.pot;
      const turnChanged = newData.currentPlayerTurn !== tournamentData?.currentPlayerTurn;
      
      if (playersChanged || communityChanged || potChanged || turnChanged) {
       tournamentData = newData;
       
       // Atualizar interface
       updateInterface();
      }
     }
    }, (error) => {
     console.error('‚ùå Erro no listener:', error);
    });
  }
  
  // 6. Atualizar interface completa
  function updateInterface() {
   // Atualizar contador de jogadores
   document.getElementById('playersCount').textContent = 
    `${tournamentData.players?.length || 1}/${tournamentData.maxPlayers || 6}`;
   
   // Atualizar avatares e chips
   const players = tournamentData.players || [];
   
   players.forEach((player, index) => {
    if (index < 6) {
     const pos = positionMap[index];
     const chipsElement = document.getElementById(`chips${pos}`);
     const avatarElement = document.getElementById(`avatar${pos}`);
     const container = document.getElementById(`playerPos${pos}`);
     
     // Atualizar chips
     const chips = player.chips || tournamentData.startingStack || 1500;
     const name = player.nickname || player.playerName || 'Jogador';
     chipsElement.innerHTML = `${name}<br>${chips}`;
     
     // Destacar jogador atual
     if (tournamentData.currentPlayerTurn === player.userId) {
      avatarElement.classList.add('current-turn');
     } else {
      avatarElement.classList.remove('current-turn');
     }
     
     // Marcar se foldou
     if (player.isActive === false) {
      avatarElement.classList.add('player-folded');
     } else {
      avatarElement.classList.remove('player-folded');
     }
     
     // Mostrar cartas do jogador (se for voc√™ e tiver cartas)
     const isMe = player.userId === currentUser.uid;
     if (isMe && player.cards && player.cards.length > 0) {
      const myCards = container.querySelector('.player-cards');
      if (myCards) {
       myCards.style.display = 'flex';
      }
     }
    }
   });
   
   // Atualizar cartas comunit√°rias
   updateCommunityCards();
   
   // Atualizar pot
   updatePot();
   
   // Atualizar minhas cartas
   updateMyCards();
   
   // Verificar se √© minha vez
   checkMyTurn();
  }
  
  // 7. Atualizar cartas comunit√°rias
  function updateCommunityCards() {
   const communityCards = tournamentData.communityCards || [];
   const container = document.getElementById('communityCards');
   const cards = container.querySelectorAll('.card-placeholder');
   
   cards.forEach((cardEl, index) => {
    if (communityCards[index]) {
     const card = communityCards[index];
     let displayText = '?';
     let color = '#2c3e50';
     
     if (typeof card === 'string') {
      displayText = card;
      color = (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
     } else if (card.suit && card.rank) {
      // Usar Poker Engine para formatar
      if (window.PokerEngine && window.PokerEngine.PokerCard) {
       const cardObj = new window.PokerEngine.PokerCard(card.suit, card.rank);
       displayText = cardObj.toString();
       color = cardObj.color === 'red' ? '#e74c3c' : '#2c3e50';
      } else {
       displayText = `${card.rank}${getSuitSymbol(card.suit)}`;
       color = (card.suit === 'hearts' || card.suit === 'diamonds') ? '#e74c3c' : '#2c3e50';
      }
     }
     
     cardEl.textContent = displayText;
     cardEl.style.color = color;
     cardEl.style.background = 'white';
    } else {
     cardEl.textContent = '';
     cardEl.style.background = 'rgba(255,255,255,0.1)';
    }
   });
  }
  
  // 8. Atualizar pot
  function updatePot() {
   const pot = tournamentData.pot || 0;
   document.getElementById('pot').textContent = `Pote: ${pot}`;
   document.getElementById('potAmount').textContent = pot;
  }
  
  // 9. Atualizar minhas cartas
  function updateMyCards() {
   if (!tournamentData.players || !currentUser) return;
   
   const me = tournamentData.players.find(p => p.userId === currentUser.uid);
   if (!me || !me.cards) {
    // Esconder minhas cartas se n√£o tiver
    const myCardsContainer = document.querySelector('#playerPos1 .player-cards');
    if (myCardsContainer) {
     myCardsContainer.style.display = 'none';
    }
    return;
   }
   
   const cards = me.cards;
   if (cards.length >= 2) {
    // Atualizar cartas ao lado do avatar
    const card1Element = document.getElementById('playerCard1');
    const card2Element = document.getElementById('playerCard2');
    
    if (card1Element && card2Element) {
     card1Element.textContent = formatCard(cards[0]);
     card2Element.textContent = formatCard(cards[1]);
     
     // Colorir cartas
     card1Element.style.color = getCardColor(cards[0]);
     card2Element.style.color = getCardColor(cards[1]);
     
     // Mostrar cartas
     const myCardsContainer = document.querySelector('#playerPos1 .player-cards');
     if (myCardsContainer) {
      myCardsContainer.style.display = 'flex';
     }
    }
    
    // Remover cartas antigas (se ainda existirem)
    const oldCard1 = document.getElementById('card1');
    const oldCard2 = document.getElementById('card2');
    if (oldCard1 && oldCard2) {
     oldCard1.style.display = 'none';
     oldCard2.style.display = 'none';
    }
   }
  }
  
  // 10. Verificar se √© minha vez
  function checkMyTurn() {
   if (!tournamentData.currentPlayerTurn) return;
   
   const isMyTurn = tournamentData.currentPlayerTurn === currentUser.uid;
   
   if (isMyTurn) {
    enablePlayerControls();
    startActionTimer();
    showNotification('‚úÖ SUA VEZ! Fa√ßa sua jogada', 'turn');
   } else {
    disablePlayerControls();
    stopActionTimer();
    
    // Mostrar quem est√° jogando
    const currentPlayer = tournamentData.players?.find(p => p.userId === tournamentData.currentPlayerTurn);
    if (currentPlayer) {
     showNotification(`${currentPlayer.nickname} est√° jogando...`, 'info');
    }
   }
  }
  
  // 11. Verificar se pode iniciar jogo
  function checkIfGameCanStart() {
   const playersCount = tournamentData.players?.length || 0;
   const maxPlayers = tournamentData.maxPlayers || 6;
   
   if (playersCount >= 2 && !gameStarted) {
    // Iniciar Poker Engine se tiver 2+ jogadores
    initializePokerEngine();
   } else if (playersCount < 2) {
    showNotification('‚è≥ Aguardando mais jogadores... (m√≠nimo 2)', 'info');
   }
  }
  
  // 12. Inicializar Poker Engine
  function initializePokerEngine() {
   if (gameStarted) return;
   
   console.log('üé¥ Inicializando Poker Engine...');
   
   if (!window.PokerEngine || !window.PokerEngine.PokerGameEngine) {
    console.error('‚ùå Poker Engine n√£o carregado!');
    showNotification('Erro: Poker Engine n√£o encontrado', 'error');
    return;
   }
   
   // Preparar jogadores para o engine
   const players = tournamentData.players.map((player, index) => ({
    userId: player.userId,
    nickname: player.nickname || player.playerName || `Jogador ${index + 1}`,
    chips: player.chips || tournamentData.startingStack || 1500,
    position: index,
    isActive: true,
    avatarUrl: player.avatarUrl || ''
   }));
   
   // Criar inst√¢ncia do jogo
   try {
    pokerGame = new window.PokerEngine.PokerGameEngine(tournamentId);
    pokerGame.initialize(players);
    
    gameStarted = true;
    console.log('‚úÖ Poker Engine inicializado com sucesso');
    showNotification('üéÆ Jogo iniciado! Aguardando primeira m√£o...', 'success');
    
    // Iniciar primeira m√£o ap√≥s 3 segundos
    setTimeout(() => {
     startNewHand();
    }, 3000);
    
   } catch (error) {
    console.error('‚ùå Erro ao inicializar Poker Engine:', error);
    showNotification('Erro ao iniciar jogo: ' + error.message, 'error');
   }
  }
  
  // 13. Iniciar nova m√£o
  async function startNewHand() {
   if (!pokerGame || !gameStarted) return;
   
   try {
    console.log('üÉè Iniciando nova m√£o...');
    showNotification('Nova m√£o iniciada!', 'info');
    
    const handResult = await pokerGame.startHand();
    
    // Atualizar interface com dados do engine
    const gameInfo = pokerGame.getGameInfo();
    
    // Atualizar dados no Firestore
    await updateGameStateInFirestore(gameInfo);
    
   } catch (error) {
    console.error('‚ùå Erro ao iniciar m√£o:', error);
    showNotification('Erro: ' + error.message, 'error');
   }
  }
  
  // =============================================
  // CONTROLES DO JOGADOR
  // =============================================
  
  function setupControls() {
   // Configurar slider de aposta
   const slider = document.getElementById('betSlider');
   if (slider) {
    slider.addEventListener('input', updateBetAmount);
   }
   
   // Configurar bot√µes de a√ß√£o
   document.getElementById('btnFold').addEventListener('click', () => playerAction('fold'));
   document.getElementById('btnCheck').addEventListener('click', () => playerAction('check'));
   document.getElementById('btnCall').addEventListener('click', () => playerAction('call'));
   document.getElementById('btnRaise').addEventListener('click', showRaiseControls);
   document.getElementById('btnAllin').addEventListener('click', () => playerAction('allin'));
  }
  
  async function playerAction(action) {
   if (!isMyTurn()) {
    showNotification('N√£o √© sua vez!', 'error');
    return;
   }
   
   console.log(`üéÆ A√ß√£o do jogador: ${action}`);
   
   try {
    let amount = 0;
    
    // Para raise, usar valor do slider
    if (action === 'raise') {
     amount = parseInt(document.getElementById('betAmount').textContent);
     if (amount <= 0) {
      showNotification('Escolha um valor para raise', 'error');
      return;
     }
    }
    
    // Se tiver Poker Engine, usar ele
    if (pokerGame && gameStarted) {
     const result = await pokerGame.playerAction(currentUser.uid, action, amount);
     
     if (result.success) {
      showNotification(`Voc√™ ${action}${amount > 0 ? ' ' + amount : ''}`, 'success');
      
      // Atualizar interface
      updateInterface();
      
      // Desabilitar controles temporariamente
      disablePlayerControls();
      hideRaiseControls();
      
      // Atualizar Firestore
      await updateGameStateInFirestore(result.gameState);
      
     } else {
      showNotification(`Erro: ${result.error}`, 'error');
     }
    } else {
     // Fallback: atualizar diretamente no Firestore
     await updatePlayerActionInFirestore(action, amount);
    }
    
   } catch (error) {
    console.error('‚ùå Erro na a√ß√£o:', error);
    showNotification('Erro: ' + error.message, 'error');
   }
  }
  
  function showRaiseControls() {
   if (!isMyTurn()) return;
   
   // Obter m√°ximo que pode apostar
   const me = tournamentData.players?.find(p => p.userId === currentUser.uid);
   if (!me) return;
   
   const maxBet = me.chips || 0;
   const minBet = tournamentData.currentBet || 100;
   
   // Configurar slider
   const slider = document.getElementById('betSlider');
   slider.min = minBet;
   slider.max = maxBet;
   slider.value = minBet;
   
   // Mostrar controles
   document.getElementById('raiseControls').style.display = 'flex';
   document.getElementById('actionButtons').style.display = 'none';
   
   // Atualizar valor
   updateBetAmount();
  }
  
  function hideRaiseControls() {
   document.getElementById('raiseControls').style.display = 'none';
   document.getElementById('actionButtons').style.display = 'flex';
  }
  
  function updateBetAmount() {
   const slider = document.getElementById('betSlider');
   const amount = parseInt(slider.value);
   document.getElementById('betAmount').textContent = amount;
  }
  
  function confirmRaise() {
   playerAction('raise');
  }
  
  function isMyTurn() {
   return tournamentData.currentPlayerTurn === currentUser.uid;
  }
  
  function enablePlayerControls() {
   const buttons = document.querySelectorAll('.action-btn');
   buttons.forEach(btn => {
    btn.disabled = false;
   });
   
   // Mostrar timer
   document.getElementById('actionTimerContainer').style.display = 'block';
  }
  
  function disablePlayerControls() {
   const buttons = document.querySelectorAll('.action-btn');
   buttons.forEach(btn => {
    btn.disabled = true;
   });
   
   // Esconder timer
   document.getElementById('actionTimerContainer').style.display = 'none';
  }
  
  // =============================================
  // TIMER DE A√á√ÉO
  // =============================================
  
  function startActionTimer() {
   timeLeft = 30;
   const timerBar = document.getElementById('actionTimerBar');
   timerBar.style.width = '100%';
   timerBar.style.background = '#2ecc71';
   
   stopActionTimer();
   
   actionTimerInterval = setInterval(() => {
    timeLeft--;
    const percentage = (timeLeft / 30) * 100;
    timerBar.style.width = percentage + '%';
    
    // Mudar cor conforme o tempo
    if (timeLeft <= 10) {
     timerBar.style.background = '#e74c3c';
    } else if (timeLeft <= 20) {
     timerBar.style.background = '#e67e22';
    }
    
    if (timeLeft <= 0) {
     // Tempo esgotado - fold autom√°tico
     playerAction('fold');
     stopActionTimer();
    }
   }, 1000);
  }
  
  function stopActionTimer() {
   if (actionTimerInterval) {
    clearInterval(actionTimerInterval);
    actionTimerInterval = null;
   }
  }
  
  // =============================================
  // FUN√á√ïES AUXILIARES
  // =============================================
  
  // Formatar carta para exibi√ß√£o
  function formatCard(card) {
   if (!card) return '?';
   
   if (typeof card === 'string') {
    return card;
   }
   
   if (card.rank && card.suit) {
    const rank = card.rank;
    const suitSymbol = getSuitSymbol(card.suit);
    return rank + suitSymbol;
   }
   
   return '?';
  }
  
  // Obter cor da carta
  function getCardColor(card) {
   if (typeof card === 'string') {
    return (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
   }
   
   if (card.suit) {
    return (card.suit === 'hearts' || card.suit === 'diamonds') ? '#e74c3c' : '#2c3e50';
   }
   
   return '#2c3e50';
  }
  
  // Obter s√≠mbolo do naipe
  function getSuitSymbol(suit) {
   switch(suit) {
    case 'hearts': return '‚ô•';
    case 'diamonds': return '‚ô¶';
    case 'clubs': return '‚ô£';
    case 'spades': return '‚ô†';
    default: return '?';
   }
  }
  
  // Atualizar estado do jogo no Firestore
  async function updateGameStateInFirestore(gameState) {
   try {
    // Preparar jogadores para Firestore
    const firestorePlayers = gameState.players.map(player => ({
     userId: player.userId,
     nickname: player.nickname,
     chips: player.chips,
     isActive: player.isActive,
     bet: player.bet || 0,
     lastAction: player.lastAction,
     cards: player.cards || [],
     avatarUrl: player.avatarUrl || ''
    }));
    
    await db.collection('tournaments').doc(tournamentId).update({
     players: firestorePlayers,
     communityCards: gameState.communityCards || [],
     pot: gameState.pot || 0,
     currentPlayerTurn: gameState.currentPlayerTurn,
     currentRound: gameState.round || 'preflop',
     updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    console.log('‚úÖ Firestore atualizado com estado do jogo');
    
   } catch (error) {
    console.error('‚ùå Erro ao atualizar Firestore:', error);
   }
  }
  
  // Atualizar a√ß√£o do jogador no Firestore (fallback)
  async function updatePlayerActionInFirestore(action, amount) {
   try {
    const playerIndex = tournamentData.players.findIndex(p => p.userId === currentUser.uid);
    if (playerIndex === -1) return;
    
    const updates = {
     [`players.${playerIndex}.lastAction`]: action,
     updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    // Atualizar chips se for aposta
    if (['bet', 'raise', 'call', 'allin'].includes(action) && amount > 0) {
     const currentChips = tournamentData.players[playerIndex].chips || 1500;
     updates[`players.${playerIndex}.chips`] = currentChips - amount;
     updates.pot = firebase.firestore.FieldValue.increment(amount);
    }
    
    // Se fold, marcar como inativo
    if (action === 'fold') {
     updates[`players.${playerIndex}.isActive`] = false;
    }
    
    await db.collection('tournaments').doc(tournamentId).update(updates);
    
    showNotification(`Voc√™ ${action}${amount > 0 ? ' ' + amount : ''}`, 'success');
    
   } catch (error) {
    console.error('‚ùå Erro ao atualizar a√ß√£o:', error);
    showNotification('Erro ao processar a√ß√£o', 'error');
   }
  }
  
  // Mostrar notifica√ß√£o
  function showNotification(message, type = 'info') {
   const messageEl = document.getElementById('statusMessage');
   messageEl.textContent = message;
   messageEl.style.display = 'block';
   
   // Cor baseada no tipo
   if (type === 'error') {
    messageEl.style.background = 'rgba(231, 76, 60, 0.9)';
   } else if (type === 'success') {
    messageEl.style.background = 'rgba(46, 204, 113, 0.9)';
   } else if (type === 'turn') {
    messageEl.style.background = 'rgba(52, 152, 219, 0.9)';
   } else {
    messageEl.style.background = 'rgba(0,0,0,0.8)';
   }
   
   // Esconder ap√≥s 3 segundos (exceto para turnos)
   if (type !== 'turn') {
    setTimeout(() => {
     messageEl.style.display = 'none';
    }, 3000);
   }
  }
  
  // =============================================
  // LIMPEZA
  // =============================================
  window.addEventListener('beforeunload', () => {
   if (realtimeListener) {
    realtimeListener();
   }
   stopActionTimer();
  });
  
  console.log('‚úÖ Mesa de torneio pronta!');
 </script>
</body>
</html>