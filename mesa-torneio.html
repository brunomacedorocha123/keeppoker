<!DOCTYPE html>
<html lang="pt-br">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Mesa de Torneio | KeepPoker</title>
 
 <!-- Firebase -->
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
 
 <script>
   // Firebase Configuration
   const firebaseConfig = {
     apiKey: "AIzaSyBIBucZSzN671VgJQHGIiepHNUqxbqNKAQ",
     authDomain: "keeppoker-b4173.firebaseapp.com",
     projectId: "keeppoker-b4173",
     storageBucket: "keeppoker-b4173.firebasestorage.app",
     messagingSenderId: "436464592434",
     appId: "1:436464592434:web:c5a1e0c10e10acbc14fe2b"
   };
   
   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();
 </script>
 
 <!-- Poker Engine (ARQUIVO SEPARADO) -->
 <script src="poker-engine.js"></script>
 
<style>
/* ===== RESET E BASE ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #0a1520;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* ===== CABE√áALHO ===== */
.header {
  height: 60px;
  background: rgba(13, 27, 42, 0.9);
  border-bottom: 2px solid #d4af37;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 100;
}

.tournament-info {
  font-size: 1.1em;
  color: #d4af37;
  font-weight: bold;
}

.game-stats {
  display: flex;
  gap: 20px;
}

.stat {
  background: rgba(212, 175, 55, 0.15);
  padding: 6px 12px;
  border-radius: 12px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  font-weight: bold;
}

/* ===== MESA ===== */
.table-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 70%;
  height: 50%;
  z-index: 1;
}

.poker-table {
  width: 100%;
  height: 100%;
  background: #0a5c36;
  border: 15px solid #8B4513;
  border-radius: 50% / 40%;
  box-shadow:
    inset 0 0 40px rgba(0, 0, 0, 0.6),
    0 0 30px rgba(0, 0, 0, 0.7);
  position: relative;
  overflow: visible;
}

.table-center {
  position: absolute;
  top: 52%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 45%;
  height: 35%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.community-cards {
  display: flex;
  gap: 8px;
  justify-content: center;
  align-items: center;
}

.card-placeholder {
  width: 50px;
  height: 70px;
  background: white;
  border-radius: 5px;
  border: 2px solid #333;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.2em;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  color: #2c3e50;
}

.pot {
  color: #d4af37;
  font-size: 1.4em;
  font-weight: bold;
  margin-top: 5px;
}

/* ===== AVATARS ===== */
.avatar-container {
  position: absolute;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 20;
}

.avatar {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: linear-gradient(135deg, #415a77, #1b263b);
  border: 3px solid #d4af37;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.4em;
  margin-bottom: 5px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
  position: relative;
  overflow: hidden;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.player-cards {
  position: absolute;
  left: 85px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 5px;
  z-index: 25;
  width: 90px;
}

.player-card {
  width: 40px;
  height: 56px;
  background: white;
  border-radius: 4px;
  border: 2px solid #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1em;
  color: #000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.player-chips {
  background: rgba(0, 0, 0, 0.7);
  color: #ffd700;
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 0.9em;
  font-weight: bold;
  margin-top: 5px;
  min-width: 80px;
  text-align: center;
}

.current-turn .avatar {
  border-color: #00ff00;
  box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
}

.player-bet {
  position: absolute;
  top: -15px;
  background: rgba(212, 175, 55, 0.9);
  color: #000;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: bold;
  font-size: 0.8em;
  white-space: nowrap;
}

.player-folded .avatar {
  opacity: 0.5;
  border-color: #666;
}

.player-info {
  background: rgba(13, 27, 42, 0.95);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(212, 175, 55, 0.3);
  text-align: center;
  min-width: 100px;
  font-size: 0.9em;
  display: none;
}

/* ===== POSI√á√ïES DOS AVATARES - AJUSTE FINAL VISUAL ===== */
.pos-1 {
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
}

/* Posi√ß√µes 2 e 3 ‚Üí MOVER PARA A DIREITA (‚Üí‚Üí‚Üí) */
.pos-2 {
  top: 160px;
  right: 20%; /* mais perto da borda direita */
}
.pos-3 {
  bottom: 160px;
  right: 20%;
}

/* Posi√ß√µes 5 e 6 ‚Üí MOVER PARA A ESQUERDA (‚Üê‚Üê‚Üê) */
.pos-6 {
  top: 160px;
  left: 20%; /* mais perto da borda esquerda */
}
.pos-5 {
  bottom: 160px;
  left: 20%;
}

/* Posi√ß√£o 4 ‚Üí MOVER PARA CIMA (‚Üë‚Üë‚Üë) */
.pos-4 {
  bottom: 150px; /* mais alto na tela, longe dos controles */
  left: 50%;
  transform: translateX(-50%);
}

/* JOGADOR ATUAL (VOC√ä) */
.player-you .avatar {
  border-color: #3498db;
  box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
}

.player-you .player-info {
  display: block;
}

/* ===== CONTROLES ===== */
.controls-container {
  position: fixed;
  bottom: 8px;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  z-index: 1000;
}

.controls {
  background: rgba(13, 27, 42, 0.95);
  padding: 12px 25px;
  border-radius: 12px;
  border: 2px solid #d4af37;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 560px;
  min-height: 100px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.7);
}

.action-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: nowrap;
  justify-content: center;
  width: 100%;
}

.action-btn {
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  min-width: 90px;
  font-size: 0.95em;
  transition: all 0.3s;
  flex: 1;
  max-width: 100px;
}

.btn-fold { background: #e74c3c; color: white; }
.btn-check { background: #3498db; color: white; }
.btn-call { background: #2ecc71; color: white; }
.btn-raise { background: #9b59b6; color: white; }
.btn-allin { background: #e67e22; color: white; }

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.bet-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-top: 4px;
  width: 100%;
  display: none;
}

.bet-slider {
  flex: 1;
  height: 7px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  outline: none;
  -webkit-appearance: none;
}

.bet-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #d4af37;
  cursor: pointer;
  border: 2px solid white;
}

.bet-amount {
  background: rgba(212, 175, 55, 0.2);
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: bold;
  color: #ffd700;
  min-width: 70px;
  text-align: center;
  font-size: 0.95em;
  border: 1px solid rgba(212, 175, 55, 0.3);
}

.action-timer {
  width: 100%;
  height: 5px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin-top: 6px;
  overflow: hidden;
  display: none;
}

.timer-bar {
  height: 100%;
  background: linear-gradient(90deg, #2ecc71, #e67e22, #e74c3c);
  width: 100%;
  transition: width 1s linear;
}

.status-message {
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  padding: 12px 25px;
  border-radius: 20px;
  border: 2px solid #d4af37;
  z-index: 1000;
  font-weight: bold;
  font-size: 1.1em;
  display: none;
  text-align: center;
  min-width: 300px;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 768px) {
  .table-container {
    width: 85%;
    height: 45%;
    top: 40%;
  }

  .avatar {
    width: 55px;
    height: 55px;
    font-size: 1.2em;
  }

  .player-cards {
    left: 65px;
    width: 80px;
  }

  .player-card {
    width: 35px;
    height: 49px;
    font-size: 0.9em;
  }

  .pos-1 { top: 75px; }
  .pos-2 { top: 120px; right: 24%; }
  .pos-6 { top: 120px; left: 24%; }
  .pos-3 { bottom: 140px; right: 24%; }
  .pos-5 { bottom: 140px; left: 24%; }
  .pos-4 { bottom: 120px; }

  .controls {
    width: 92%;
    padding: 10px 20px;
    min-height: 90px;
  }

  .action-btn {
    padding: 8px 10px;
    min-width: 65px;
    font-size: 0.9em;
    max-width: 75px;
  }
}

@media (max-width: 480px) {
  .avatar {
    width: 45px;
    height: 45px;
    font-size: 1em;
  }

  .player-cards {
    left: 55px;
    width: 70px;
  }

  .player-card {
    width: 30px;
    height: 42px;
    font-size: 0.85em;
  }

  .pos-1 { top: 70px; }
  .pos-2 { top: 100px; right: 20%; }
  .pos-6 { top: 100px; left: 20%; }
  .pos-3 { bottom: 120px; right: 20%; }
  .pos-5 { bottom: 120px; left: 20%; }
  .pos-4 { bottom: 100px; }

  .controls {
    width: 96%;
    padding: 8px 16px;
    min-height: 80px;
  }

  .action-btn {
    padding: 6px 8px;
    min-width: 55px;
    font-size: 0.85em;
    max-width: 65px;
  }

  .bet-controls {
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }
}
</style>
</head>
<body>
<!-- CABE√áALHO -->
<div class="header">
  <div class="tournament-info" id="tournamentName">Torneio</div>
  <div class="game-stats">
    <div class="stat" id="blinds">100/200</div>
    <div class="stat" id="pot">Pote: 0</div>
    <div class="stat" id="playersCount">1/6</div>
  </div>
</div>

<!-- MENSAGEM DE STATUS -->
<div class="status-message" id="statusMessage"></div>

<!-- CONTAINER DA MESA (S√ì A MESA MESMO) -->
<div class="table-container">
  <div class="poker-table">
    <!-- √ÅREA CENTRAL -->
    <div class="table-center">
      <div class="community-cards" id="communityCards">
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
        <div class="card-placeholder"></div>
      </div>
      <div class="pot" id="potAmount">0</div>
    </div>
  </div>
</div>

<!-- AVATARES (FORA da .table-container, posicionados no BODY) -->
<div class="avatar-container pos-1" id="playerPos1">
  <div class="avatar" id="avatar1">?</div>
  <!-- CARTAS AO LADO DO SEU AVATAR (POSI√á√ÉO 1) -->
  <div class="player-cards">
    <div class="player-card" id="playerCard1">?</div>
    <div class="player-card" id="playerCard2">?</div>
  </div>
  <div class="player-chips" id="chips1">-<br>0</div>
</div>

<div class="avatar-container pos-2" id="playerPos2">
  <div class="avatar" id="avatar2">?</div>
  <div class="player-chips" id="chips2">-<br>0</div>
</div>

<div class="avatar-container pos-6" id="playerPos6">
  <div class="avatar" id="avatar6">?</div>
  <div class="player-chips" id="chips6">-<br>0</div>
</div>

<div class="avatar-container pos-3" id="playerPos3">
  <div class="avatar" id="avatar3">?</div>
  <div class="player-chips" id="chips3">-<br>0</div>
</div>

<div class="avatar-container pos-5" id="playerPos5">
  <div class="avatar" id="avatar5">?</div>
  <div class="player-chips" id="chips5">-<br>0</div>
</div>

<div class="avatar-container pos-4" id="playerPos4">
  <div class="avatar" id="avatar4">?</div>
  <div class="player-chips" id="chips4">-<br>0</div>
</div>

<!-- CONTROLES (FORA da .table-container, posicionados no BODY) -->
<div class="controls-container">
  <div class="controls" id="playerControls">
    <!-- BOT√ïES DE A√á√ÉO -->
    <div class="action-buttons" id="actionButtons">
      <button class="action-btn btn-fold" onclick="playerAction('fold')">Fold</button>
      <button class="action-btn btn-check" onclick="playerAction('check')">Check</button>
      <button class="action-btn btn-call" onclick="playerAction('call')">Call</button>
      <button class="action-btn btn-raise" onclick="showRaiseControls()">Raise</button>
      <button class="action-btn btn-allin" onclick="playerAction('allin')">All-in</button>
    </div>

    <!-- CONTROLE DE APOSTA -->
    <div class="bet-controls" id="raiseControls">
      <input type="range" min="0" max="100" value="0" class="bet-slider" id="betSlider" oninput="updateBetAmount()">
      <div class="bet-amount" id="betAmount">0</div>
      <button class="action-btn btn-raise" onclick="confirmRaise()">Confirmar</button>
      <button class="action-btn btn-fold" onclick="hideRaiseControls()">Cancelar</button>
    </div>

    <!-- TIMER DE A√á√ÉO -->
    <div class="action-timer" id="actionTimerContainer">
      <div class="timer-bar" id="actionTimerBar"></div>
    </div>
  </div>
</div>
<script>
// =============================================
// VARI√ÅVEIS GLOBAIS COMPLETAS
// =============================================
let tournamentId = null;
let tournamentData = null;
let currentUser = null;
let userData = null;
let pokerGame = null;
let realtimeListener = null;
let actionTimerInterval = null;
let timeLeft = 30;
let myPlayerPosition = -1;
let gameStarted = false;
let dealerPosition = 0;
let myCards = [];
let currentBet = 0;
let minRaise = 0;
let actionPhase = 'waiting';
let isActionProcessing = false;
let currentBlinds = { small: 50, big: 100 };

const positionMap = [1, 2, 6, 3, 5, 4];

// =============================================
// INICIALIZA√á√ÉO
// =============================================
document.addEventListener('DOMContentLoaded', function() {
   const urlParams = new URLSearchParams(window.location.search);
   tournamentId = urlParams.get('tournamentId');
   
   if (!tournamentId) {
      alert('Torneio n√£o especificado! Redirecionando...');
      window.location.href = 'torneios.html';
      return;
   }
   
   auth.onAuthStateChanged(async (user) => {
      if (!user) {
         window.location.href = 'login.html';
         return;
      }
      
      currentUser = user;
      
      await loadUserData();
      await loadTournamentData();
      
      if (!isUserInTournament()) {
         showNotification('‚ùå Voc√™ n√£o est√° inscrito neste torneio', 'error');
         setTimeout(() => {
            window.location.href = 'torneios.html';
         }, 3000);
         return;
      }
      
      initializeInterface();
      setupRealtimeListener();
      checkIfGameCanStart();
   });
   
   setupControls();
});

async function loadUserData() {
   try {
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      if (userDoc.exists) {
         userData = userDoc.data();
      }
   } catch (error) {
      console.error('Erro ao carregar dados do usu√°rio:', error);
   }
}

async function loadTournamentData() {
   try {
      const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
      if (!tournamentDoc.exists) {
         throw new Error('Torneio n√£o encontrado');
      }
      
      tournamentData = tournamentDoc.data();
      tournamentData.id = tournamentId;
      
      document.getElementById('tournamentName').textContent = tournamentData.name;
      updatePlayerCount();
      
   } catch (error) {
      console.error('Erro ao carregar torneio:', error);
      showNotification('Erro ao carregar torneio', 'error');
   }
}

function updatePlayerCount() {
   const count = tournamentData.players?.length || 1;
   const max = tournamentData.maxPlayers || 6;
   document.getElementById('playersCount').textContent = `${count}/${max}`;
}

function isUserInTournament() {
   if (!tournamentData.players) return false;
   return tournamentData.players.some(p => p.userId === currentUser.uid);
}

function initializeInterface() {
   for (let i = 1; i <= 6; i++) {
      document.getElementById(`avatar${i}`).innerHTML = '?';
      document.getElementById(`chips${i}`).innerHTML = '-<br>0';
      const playerCards = document.getElementById(`playerPos${i}`)?.querySelector('.player-cards');
      if (playerCards) playerCards.style.display = 'none';
   }
   
   const players = tournamentData.players || [];
   
   players.forEach((player, index) => {
      if (index < 6) {
         const pos = positionMap[index];
         const avatarElement = document.getElementById(`avatar${pos}`);
         const chipsElement = document.getElementById(`chips${pos}`);
         const container = document.getElementById(`playerPos${pos}`);
         
         const isMe = player.userId === currentUser.uid;
         if (isMe) {
            myPlayerPosition = index;
            container.classList.add('player-you');
         }
         
         if (player.avatarUrl) {
            avatarElement.innerHTML = `<img src="${player.avatarUrl}" alt="${player.nickname}">`;
         } else {
            const initial = (player.nickname || player.playerName || '?').charAt(0).toUpperCase();
            avatarElement.textContent = initial;
         }
         
         const chips = player.chips || tournamentData.startingStack || 1500;
         chipsElement.innerHTML = `${player.nickname || 'Jogador'}<br>${chips}`;
      }
   });
}

function setupRealtimeListener() {
   realtimeListener = db.collection('tournaments').doc(tournamentId)
      .onSnapshot((doc) => {
         if (doc.exists) {
            const newData = doc.data();
            
            tournamentData = newData;
            updateInterface();
            
            const turnChanged = newData.currentPlayerTurn !== tournamentData?.currentPlayerTurn;
            if (turnChanged) {
               checkMyTurn();
            }
            
            const phaseChanged = newData.currentRound !== actionPhase;
            if (phaseChanged) {
               actionPhase = newData.currentRound || 'waiting';
            }
         }
      }, (error) => {
         console.error('Erro no listener:', error);
      });
}

function updateInterface() {
   if (!tournamentData) return;
   
   updatePlayerCount();
   
   const pot = tournamentData.pot || 0;
   document.getElementById('pot').textContent = `Pote: ${pot}`;
   document.getElementById('potAmount').textContent = pot;
   
   updateCommunityCards();
   
   const players = tournamentData.players || [];
   players.forEach((player, index) => {
      if (index < 6) {
         const pos = positionMap[index];
         const chipsElement = document.getElementById(`chips${pos}`);
         const avatarElement = document.getElementById(`avatar${pos}`);
         const container = document.getElementById(`playerPos${pos}`);
         
         const chips = player.chips || tournamentData.startingStack || 1500;
         const bet = player.bet || 0;
         const name = player.nickname || player.playerName || 'Jogador';
         
         chipsElement.innerHTML = `${name}<br>${chips}`;
         
         let betElement = container.querySelector('.player-bet');
         if (bet > 0) {
            if (!betElement) {
               betElement = document.createElement('div');
               betElement.className = 'player-bet';
               betElement.style.position = 'absolute';
               betElement.style.top = '-20px';
               betElement.style.background = 'rgba(212, 175, 55, 0.9)';
               betElement.style.color = '#000';
               betElement.style.padding = '3px 8px';
               betElement.style.borderRadius = '10px';
               betElement.style.fontWeight = 'bold';
               betElement.style.fontSize = '0.8em';
               betElement.style.whiteSpace = 'nowrap';
               betElement.style.zIndex = '30';
               container.appendChild(betElement);
            }
            betElement.textContent = `Aposta: ${bet}`;
            betElement.style.display = 'block';
         } else if (betElement) {
            betElement.style.display = 'none';
         }
         
         if (tournamentData.currentPlayerTurn === player.userId) {
            avatarElement.classList.add('current-turn');
         } else {
            avatarElement.classList.remove('current-turn');
         }
         
         if (player.isActive === false || player.lastAction === 'fold') {
            avatarElement.classList.add('player-folded');
         } else {
            avatarElement.classList.remove('player-folded');
         }
      }
   });
   
   updateMyCards();
   checkMyTurn();
}

function updateCommunityCards() {
   if (!tournamentData) return;
   
   const communityCards = tournamentData.communityCards || [];
   const container = document.getElementById('communityCards');
   const cards = container.querySelectorAll('.card-placeholder');
   
   cards.forEach((cardEl, index) => {
      if (communityCards[index]) {
         const card = communityCards[index];
         let displayText = '?';
         let color = '#2c3e50';
         
         if (typeof card === 'string') {
            displayText = card;
            color = (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
         }
         
         cardEl.textContent = displayText;
         cardEl.style.color = color;
         cardEl.style.background = 'white';
      } else {
         cardEl.textContent = '';
         cardEl.style.background = 'rgba(255,255,255,0.1)';
      }
   });
}

function updateMyCards() {
   if (!currentUser) return;
   
   const card1Element = document.getElementById('playerCard1');
   const card2Element = document.getElementById('playerCard2');
   const myCardsContainer = document.querySelector('#playerPos1 .player-cards');
   
   const me = tournamentData?.players?.find(p => p.userId === currentUser.uid);
   if (me && me.cards && me.cards.length >= 2) {
      myCards = me.cards;
      if (card1Element && card2Element) {
         card1Element.textContent = formatCard(myCards[0]);
         card2Element.textContent = formatCard(myCards[1]);
         
         card1Element.style.color = getCardColor(myCards[0]);
         card2Element.style.color = getCardColor(myCards[1]);
         
         if (myCardsContainer) {
            myCardsContainer.style.display = 'flex';
         }
      }
   } else {
      if (myCardsContainer) {
         myCardsContainer.style.display = 'none';
      }
   }
}

function checkMyTurn() {
   if (!tournamentData || !tournamentData.currentPlayerTurn) {
      disablePlayerControls();
      stopActionTimer();
      return;
   }
   
   const isMyTurn = tournamentData.currentPlayerTurn === currentUser.uid;
   
   if (isMyTurn) {
      enablePlayerControls();
      startActionTimer();
      showNotification('‚úÖ SUA VEZ! Fa√ßa sua jogada', 'turn');
   } else {
      disablePlayerControls();
      stopActionTimer();
   }
}

function checkIfGameCanStart() {
   const playersCount = tournamentData?.players?.length || 0;
   
   if (playersCount >= 2 && !gameStarted) {
      showNotification('üéÆ Iniciando jogo...', 'info');
      
      setTimeout(async () => {
         await initializePokerEngine();
      }, 2000);
   } else if (playersCount < 2) {
      showNotification('‚è≥ Aguardando mais jogadores... (m√≠nimo 2)', 'info');
   }
}

async function initializePokerEngine() {
   if (gameStarted) return;
   
   const players = tournamentData.players || [];
   
   if (players.length < 2) return;
   
   if (!window.PokerEngine || !window.PokerEngine.PokerGameEngine) {
      showNotification('Erro: Poker Engine n√£o encontrado', 'error');
      return;
   }
   
   try {
      const enginePlayers = players.map((player, index) => ({
         userId: player.userId,
         nickname: player.nickname || player.playerName || `Jogador ${index + 1}`,
         chips: player.chips || tournamentData.startingStack || 1500,
         position: index,
         isActive: true,
         avatarUrl: player.avatarUrl || ''
      }));
      
      pokerGame = new window.PokerEngine.PokerGameEngine(tournamentId);
      const gameState = pokerGame.initialize(enginePlayers);
      
      gameStarted = true;
      dealerPosition = gameState.dealerPosition || 0;
      
      showNotification('üéÆ Jogo iniciado! Preparando primeira m√£o...', 'success');
      
      await startNewHand();
      
   } catch (error) {
      showNotification('Erro ao iniciar jogo: ' + error.message, 'error');
   }
}

async function startNewHand() {
   if (!pokerGame || !gameStarted) return;
   
   try {
      showNotification('üÉè Nova m√£o iniciada! Distribuindo cartas...', 'info');
      
      actionPhase = 'preflop';
      currentBet = currentBlinds.big;
      
      const handResult = await pokerGame.startHand();
      const gameInfo = pokerGame.getGameInfo();
      
      const myPlayerInfo = pokerGame.getPlayerInfo(currentUser.uid);
      if (myPlayerInfo && myPlayerInfo.cards && myPlayerInfo.cards.length >= 2) {
         myCards = myPlayerInfo.cards;
      }
      
      const players = gameInfo.players || [];
      const maxBet = Math.max(...players.map(p => p.bet || 0));
      currentBet = maxBet;
      
      await updateGameStateInFirestore(gameInfo);
      
      updateInterface();
      
      setTimeout(() => {
         startBettingRound();
      }, 1000);
      
   } catch (error) {
      showNotification('Erro: ' + error.message, 'error');
   }
}

function startBettingRound() {
   const players = tournamentData.players || [];
   const activePlayers = players.filter(p => p.isActive !== false && p.lastAction !== 'fold' && p.chips > 0);
   
   if (activePlayers.length <= 1) {
      setTimeout(() => {
         advanceToNextPhase();
      }, 1000);
      return;
   }
   
   const dealerIndex = tournamentData.dealerPosition || 0;
   let currentPlayerIndex;
   
   if (actionPhase === 'preflop') {
      const bigBlindIndex = (dealerIndex + 2) % players.length;
      currentPlayerIndex = (bigBlindIndex + 1) % players.length;
   } else {
      currentPlayerIndex = (dealerIndex + 1) % players.length;
   }
   
   let foundPlayer = false;
   let attempts = 0;
   
   while (!foundPlayer && attempts < players.length * 2) {
      const player = players[currentPlayerIndex];
      
      if (player && 
          player.isActive !== false && 
          player.lastAction !== 'fold' && 
          player.chips > 0) {
         
         foundPlayer = true;
         updateCurrentTurn(player.userId);
         break;
      }
      
      currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
      attempts++;
   }
}

async function updateCurrentTurn(playerId) {
   try {
      await db.collection('tournaments').doc(tournamentId).update({
         currentPlayerTurn: playerId,
         updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
   } catch (error) {
      console.error('Erro ao atualizar turno:', error);
   }
}

async function processActionAndMoveToNext(action, amount = 0) {
   if (isActionProcessing) return;
   isActionProcessing = true;
   
   try {
      const currentPlayerId = tournamentData.currentPlayerTurn;
      
      if (pokerGame && gameStarted) {
         const result = await pokerGame.playerAction(currentPlayerId, action, amount);
         
         if (result.success) {
            if (['bet', 'raise', 'allin'].includes(action)) {
               const player = tournamentData.players?.find(p => p.userId === currentPlayerId);
               if (player) {
                  currentBet = Math.max(currentBet, player.bet || 0);
               }
            }
            
            const gameState = pokerGame.getGameInfo();
            await updateGameStateInFirestore(gameState);
            
            if (checkIfRoundComplete()) {
               await advanceToNextPhase();
            } else {
               await moveToNextPlayer();
            }
         }
      }
   } catch (error) {
      console.error('Erro ao processar a√ß√£o:', error);
      showNotification('Erro: ' + error.message, 'error');
   } finally {
      isActionProcessing = false;
   }
}

function checkIfRoundComplete() {
   const players = tournamentData.players || [];
   const activePlayers = players.filter(p => 
      p.isActive !== false && 
      p.lastAction !== 'fold' && 
      p.chips > 0
   );
   
   if (activePlayers.length <= 1) return true;
   
   const maxBet = Math.max(...activePlayers.map(p => p.bet || 0));
   const allEqualOrFolded = activePlayers.every(p => 
      (p.bet || 0) === maxBet || 
      p.lastAction === 'fold' || 
      p.isAllIn === true
   );
   
   return allEqualOrFolded;
}

async function advanceToNextPhase() {
   if (!pokerGame) return;
   
   try {
      let result;
      let showMessage = true;
      
      switch (actionPhase) {
         case 'preflop':
            actionPhase = 'flop';
            result = await pokerGame.dealer.dealFlop();
            if (showMessage) showNotification('üÉè FLOP virado!', 'info');
            break;
            
         case 'flop':
            actionPhase = 'turn';
            result = await pokerGame.dealer.dealTurn();
            if (showMessage) showNotification('üÉè TURN virado!', 'info');
            break;
            
         case 'turn':
            actionPhase = 'river';
            result = await pokerGame.dealer.dealRiver();
            if (showMessage) showNotification('üÉè RIVER virado!', 'info');
            break;
            
         case 'river':
            actionPhase = 'showdown';
            const winners = pokerGame.dealer.determineWinners();
            showNotification('üèÜ SHOWDOWN! Determinando vencedores...', 'info');
            
            pokerGame.distributePrizes(winners);
            
            setTimeout(() => {
               resetForNewHand();
            }, 3000);
            return;
      }
      
      if (result) {
         currentBet = 0;
         
         const gameState = pokerGame.getGameInfo();
         gameState.currentRound = actionPhase;
         
         await db.collection('tournaments').doc(tournamentId).update({
            communityCards: gameState.communityCards,
            pot: gameState.pot,
            currentRound: actionPhase,
            players: gameState.players.map(p => ({
               ...p,
               lastAction: null,
               bet: 0
            })),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
         });
         
         if (actionPhase !== 'showdown') {
            setTimeout(() => {
               startBettingRound();
            }, 2000);
         }
      }
      
   } catch (error) {
      console.error('Erro ao avan√ßar fase:', error);
   }
}
async function moveToNextPlayer() {
   const players = tournamentData.players || [];
   const currentPlayerId = tournamentData.currentPlayerTurn;
   const currentIndex = players.findIndex(p => p.userId === currentPlayerId);
   
   if (currentIndex === -1) {
      startBettingRound();
      return;
   }
   
   let nextIndex = (currentIndex + 1) % players.length;
   let attempts = 0;
   
   while (attempts < players.length * 2) {
      const nextPlayer = players[nextIndex];
      
      if (nextPlayer && 
          nextPlayer.isActive !== false && 
          nextPlayer.lastAction !== 'fold' && 
          nextPlayer.chips > 0) {
         
         await updateCurrentTurn(nextPlayer.userId);
         return;
      }
      
      nextIndex = (nextIndex + 1) % players.length;
      attempts++;
   }
}

async function resetForNewHand() {
   if (pokerGame && pokerGame.dealer) {
      pokerGame.dealer.resetForNewHand();
      
      currentBet = 0;
      minRaise = 0;
      actionPhase = 'preflop';
      myCards = [];
      
      await db.collection('tournaments').doc(tournamentId).update({
         communityCards: [],
         currentRound: 'preflop',
         currentPlayerTurn: '',
         players: tournamentData.players.map(p => ({
            ...p,
            bet: 0,
            lastAction: null,
            cards: []
         })),
         updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      setTimeout(async () => {
         await startNewHand();
      }, 3000);
   }
}

function setupControls() {
   const slider = document.getElementById('betSlider');
   if (slider) {
      slider.addEventListener('input', updateBetAmount);
   }
}

async function playerAction(action) {
   if (!isMyTurn()) {
      showNotification('N√£o √© sua vez!', 'error');
      return;
   }
   
   try {
      let amount = 0;
      
      if (action === 'raise') {
         amount = parseInt(document.getElementById('betAmount').textContent);
         if (amount <= 0) {
            showNotification('Escolha um valor para raise', 'error');
            return;
         }
      }
      
      await processActionAndMoveToNext(action, amount);
      hideRaiseControls();
      
   } catch (error) {
      showNotification('Erro: ' + error.message, 'error');
   }
}

function showRaiseControls() {
   if (!isMyTurn()) return;
   
   const me = tournamentData?.players?.find(p => p.userId === currentUser.uid);
   if (!me) return;
   
   const maxBet = me.chips || 0;
   const minBet = currentBet > 0 ? currentBet * 2 : currentBlinds.big * 2;
   
   const slider = document.getElementById('betSlider');
   slider.min = minBet;
   slider.max = maxBet;
   slider.value = minBet;
   
   document.getElementById('raiseControls').style.display = 'flex';
   document.getElementById('actionButtons').style.display = 'none';
   
   updateBetAmount();
}

function hideRaiseControls() {
   document.getElementById('raiseControls').style.display = 'none';
   document.getElementById('actionButtons').style.display = 'flex';
}

function updateBetAmount() {
   const slider = document.getElementById('betSlider');
   const amount = parseInt(slider.value);
   document.getElementById('betAmount').textContent = amount;
}

function confirmRaise() {
   playerAction('raise');
}

function isMyTurn() {
   if (!tournamentData || !tournamentData.currentPlayerTurn) return false;
   return tournamentData.currentPlayerTurn === currentUser.uid;
}

function enablePlayerControls() {
   const buttons = document.querySelectorAll('.action-btn');
   buttons.forEach(btn => {
      btn.disabled = false;
   });
   
   document.getElementById('actionTimerContainer').style.display = 'block';
   updateActionButtons();
}

function updateActionButtons() {
   const me = tournamentData.players?.find(p => p.userId === currentUser.uid);
   if (!me) return;
   
   const myBet = me.bet || 0;
   const canCheck = myBet >= currentBet;
   
   const checkBtn = document.querySelector('.btn-check');
   const callBtn = document.querySelector('.btn-call');
   
   if (checkBtn && callBtn) {
      checkBtn.style.display = canCheck ? 'block' : 'none';
      callBtn.style.display = !canCheck ? 'block' : 'none';
      
      const callAmount = Math.max(0, currentBet - myBet);
      callBtn.textContent = callAmount > 0 ? `Call ${callAmount}` : 'Call';
   }
}

function disablePlayerControls() {
   const buttons = document.querySelectorAll('.action-btn');
   buttons.forEach(btn => {
      btn.disabled = true;
   });
   
   document.getElementById('actionTimerContainer').style.display = 'none';
}

function startActionTimer() {
   timeLeft = 30;
   const timerBar = document.getElementById('actionTimerBar');
   timerBar.style.width = '100%';
   timerBar.style.background = '#2ecc71';
   
   stopActionTimer();
   
   actionTimerInterval = setInterval(() => {
      timeLeft--;
      const percentage = (timeLeft / 30) * 100;
      timerBar.style.width = percentage + '%';
      
      if (timeLeft <= 10) {
         timerBar.style.background = '#e74c3c';
      } else if (timeLeft <= 20) {
         timerBar.style.background = '#e67e22';
      }
      
      if (timeLeft <= 0) {
         playerAction('fold');
         stopActionTimer();
      }
   }, 1000);
}

function stopActionTimer() {
   if (actionTimerInterval) {
      clearInterval(actionTimerInterval);
      actionTimerInterval = null;
   }
}

async function updateGameStateInFirestore(gameState) {
   try {
      await db.collection('tournaments').doc(tournamentId).update({
         players: gameState.players,
         communityCards: gameState.communityCards,
         pot: gameState.pot,
         currentPlayerTurn: gameState.currentPlayerTurn || '',
         currentRound: gameState.round || 'preflop',
         dealerPosition: gameState.dealerPosition || 0,
         updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
   } catch (error) {
      console.error('Erro ao atualizar Firestore:', error);
   }
}

function formatCard(card) {
   if (!card) return '?';
   
   if (typeof card === 'string') {
      return card;
   }
   
   if (card.rank && card.suit) {
      const suitSymbol = getSuitSymbol(card.suit);
      return card.rank + suitSymbol;
   }
   
   return '?';
}

function getCardColor(card) {
   if (typeof card === 'string') {
      return (card.includes('‚ô•') || card.includes('‚ô¶')) ? '#e74c3c' : '#2c3e50';
   }
   
   if (card.suit) {
      return (card.suit === 'hearts' || card.suit === 'diamonds') ? '#e74c3c' : '#2c3e50';
   }
   
   return '#2c3e50';
}

function getSuitSymbol(suit) {
   switch(suit) {
      case 'hearts': return '‚ô•';
      case 'diamonds': return '‚ô¶';
      case 'clubs': return '‚ô£';
      case 'spades': return '‚ô†';
      default: return '?';
   }
}

function showNotification(message, type = 'info') {
   const messageEl = document.getElementById('statusMessage');
   messageEl.textContent = message;
   messageEl.style.display = 'block';
   
   if (type === 'error') {
      messageEl.style.background = 'rgba(231, 76, 60, 0.9)';
   } else if (type === 'success') {
      messageEl.style.background = 'rgba(46, 204, 113, 0.9)';
   } else if (type === 'turn') {
      messageEl.style.background = 'rgba(52, 152, 219, 0.9)';
   } else {
      messageEl.style.background = 'rgba(0,0,0,0.8)';
   }
   
   if (type !== 'turn') {
      setTimeout(() => {
         messageEl.style.display = 'none';
      }, 3000);
   }
}

window.addEventListener('beforeunload', () => {
   if (realtimeListener) realtimeListener();
   stopActionTimer();
});

console.log('‚úÖ Sistema de mesa de torneio carregado!');
</script>
</body>
</html>